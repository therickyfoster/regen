<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Planetary Restoration Archive â€” Madagascar Node Dashboard</title>
  <meta name="description" content="PRA Madagascar regenerative node dashboard with user authentication, offline-first architecture, gamification, and community coordination tools."/>
  <meta name="theme-color" content="#081221"/>
  
  <!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ZERO-HARM / ANTI-INVERSION DECLARATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    PURPOSE: This dashboard is designed exclusively for ecological restoration,
    community coordination, and transparent stewardship of regenerative projects.
    
    NON-WEAPONIZATION: This code must not be repurposed for surveillance, 
    extraction, exploitation, harm to people, biosphere degradation, or 
    sovereignty violation.
    
    LICENSE: Open for peaceful restoration use. Respect all attributed licenses.
    See "Attributions & Licenses" section at footer for third-party code usage.
    
    SAFETY FEATURES: Client-side rate limiting, input sanitization, no external
    tracking, no PII exposure, local-first data storage, user consent required
    for all data operations.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEME SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Multi-theme support for different cultural contexts and preferences
       USAGE: Themes auto-detect system preference and allow manual switching
       THEMES: default, medieval, space, anime, forest, ocean
       EXPECTED OUTCOME: Personalized visual experience that respects user preference
    */
    :root {
      --bg: #04060b;
      --card: rgba(10,14,20,0.68);
      --glass: rgba(255,255,255,0.03);
      --accent: #7fe3c7;
      --accent-2: #ffd36e;
      --glass-border: rgba(255,255,255,0.06);
      --blur: 12px;
      --muted: #8fb9bd;
      --ink: #e6f0ff;
      --danger: #ff6b6b;
      --success: #51cf66;
    }
    
    /* Medieval theme */
    [data-theme="medieval"] {
      --bg: #1a0f0a;
      --accent: #d4af37;
      --accent-2: #8b4513;
      --ink: #f5e6d3;
    }
    
    /* Space theme */
    [data-theme="space"] {
      --bg: #000000;
      --accent: #00d4ff;
      --accent-2: #ff00ff;
      --ink: #ffffff;
    }
    
    /* Anime theme */
    [data-theme="anime"] {
      --bg: #fff5f5;
      --card: rgba(255,240,245,0.9);
      --accent: #ff6b9d;
      --accent-2: #c92a2a;
      --ink: #2d3748;
      --muted: #718096;
    }
    
    /* Forest theme */
    [data-theme="forest"] {
      --bg: #0d1b0d;
      --accent: #4ade80;
      --accent-2: #86efac;
      --ink: #dcfce7;
    }
    
    /* Ocean theme */
    [data-theme="ocean"] {
      --bg: #001428;
      --accent: #38bdf8;
      --accent-2: #0ea5e9;
      --ink: #e0f2fe;
    }

    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      overflow-x: hidden;
      scroll-behavior: smooth;
    }
    
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial;
      line-height: 1.6;
    }
    
    a {
      color: var(--accent);
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    main {
      position: relative;
      min-height: 100vh;
      z-index: 2;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STICKY NAVIGATION & TABLE OF CONTENTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Persistent navigation for easy access to all sections
       USAGE: Automatically generated from section headings, sticky positioning
       EXPECTED OUTCOME: Always-visible navigation that aids exploration
    */
    header.site-head {
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(180deg, var(--bg) 0%, rgba(4,6,11,0.95) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      padding: 12px 0;
    }
    
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .brand h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.6px;
    }
    
    .brand .subtitle {
      margin: 0;
      font-size: 11px;
      color: var(--muted);
    }
    
    .nav {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .toc-toggle {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 18px;
      z-index: 90;
    }
    
    .toc {
      position: fixed;
      right: 20px;
      top: 100px;
      width: 220px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      background: var(--card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 16px;
      backdrop-filter: blur(var(--blur));
      display: none;
    }
    
    .toc.active {
      display: block;
    }
    
    .toc h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
    }
    
    .toc ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .toc li {
      margin: 6px 0;
    }
    
    .toc a {
      font-size: 13px;
      color: var(--muted);
      display: block;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .toc a:hover {
      background: var(--glass);
      color: var(--accent);
      text-decoration: none;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTON & FORM CONTROLS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Consistent interactive elements with accessibility
       USAGE: Standard button classes for primary, secondary, danger actions
       EXPECTED OUTCOME: Clear, accessible, tactile UI controls
    */
    .btn {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border: none;
      color: #012;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(127, 227, 199, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.alt {
      background: linear-gradient(90deg, #102329, #0b1620);
      color: #cfe;
    }
    
    .btn.danger {
      background: linear-gradient(90deg, var(--danger), #e03131);
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.small {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--glass-border);
      background: rgba(0,18,26,0.6);
      color: var(--ink);
      font-family: inherit;
      font-size: 14px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(127, 227, 199, 0.1);
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLASS CARD SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Frosted glass aesthetic with depth and layering
       USAGE: Primary container for content sections
       EXPECTED OUTCOME: Modern, elegant content presentation
    */
    .glass-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur));
      border-radius: 14px;
      padding: 24px;
      margin: 20px 0;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COLLAPSIBLE SECTIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Progressive disclosure to reduce cognitive load
       USAGE: Click section header to expand/collapse
       EXPECTED OUTCOME: Clean, scannable interface with details on demand
    */
    .collapsible {
      margin: 20px 0;
    }
    
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }
    
    .collapsible-header:hover {
      background: var(--glass);
      border-color: var(--accent);
    }
    
    .collapsible-header h2,
    .collapsible-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .collapsible-icon {
      transition: transform 0.3s;
      font-size: 20px;
    }
    
    .collapsible.active .collapsible-icon {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .collapsible.active .collapsible-content {
      max-height: 5000px;
      transition: max-height 0.5s ease-in;
    }
    
    .collapsible-inner {
      padding: 20px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AUTHENTICATION MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Secure local user authentication without server dependency
       USAGE: Create account with username/password, stored encrypted in IndexedDB
       SECURITY: bcrypt-style password hashing, rate limiting on login attempts
       EXPECTED OUTCOME: Privacy-first authentication suitable for offline use
    */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 32px;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: var(--glass);
      color: var(--ink);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SEARCH FUNCTIONALITY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Client-side full-text search across all content
       USAGE: Type query in search box, results update in real-time
       ALGORITHM: Simple text matching with highlighting
       EXPECTED OUTCOME: Fast, privacy-preserving content discovery
    */
    .search-container {
      position: relative;
      margin: 20px 0;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border-radius: 12px;
      border: 2px solid var(--glass-border);
      background: rgba(0,18,26,0.6);
      color: var(--ink);
      font-size: 15px;
    }
    
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }
    
    .search-results {
      margin-top: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .search-result-item {
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .search-result-item:hover {
      border-color: var(--accent);
      background: var(--glass);
    }
    
    .search-result-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .search-result-snippet {
      font-size: 13px;
      color: var(--muted);
    }
    
    .highlight {
      background: var(--accent);
      color: #000;
      padding: 2px 4px;
      border-radius: 3px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GAMIFICATION HUD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Visual feedback system for user contributions and progress
       USAGE: Earn XP and badges through actions (pledges, seed entries, etc.)
       PSYCHOLOGY: Positive reinforcement for regenerative behaviors
       EXPECTED OUTCOME: Increased engagement and sustained participation
    */
    .hud {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 60;
    }
    
    .hud .mini {
      background: linear-gradient(180deg, rgba(2,16,24,0.9), rgba(0,16,20,0.85));
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px);
      min-width: 140px;
    }
    
    .hud-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
      font-size: 13px;
    }
    
    .hud-label {
      color: var(--muted);
    }
    
    .hud-value {
      font-weight: 700;
      color: var(--accent);
      font-size: 15px;
    }
    
    .badge {
      background: linear-gradient(135deg, #0b1f13, #051810);
      padding: 4px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127, 227, 199, 0.2);
      font-weight: 700;
      color: var(--accent-2);
      font-size: 11px;
      display: inline-block;
      margin: 2px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       USER DASHBOARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Personalized view of user activity and contributions
       USAGE: Displayed after successful authentication
       EXPECTED OUTCOME: Clear overview of personal impact and next actions
    */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .dashboard-card {
      background: var(--card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 20px;
    }
    
    .dashboard-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-big {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEME SELECTOR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Visual customization for different user preferences
       USAGE: Select from dropdown or auto-detect system preference
       THEMES: Default, Medieval, Space, Anime, Forest, Ocean
       EXPECTED OUTCOME: Personalized aesthetic matching user context
    */
    .theme-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0;
    }
    
    .theme-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--glass-border);
      background: var(--card);
      color: var(--ink);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .theme-btn:hover {
      border-color: var(--accent);
      background: var(--glass);
    }
    
    .theme-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      font-weight: 600;
    }
    
    /* Utility classes */
    .small { font-size: 13px; }
    .muted { color: var(--muted); }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .flex { display: flex; }
    .flex-wrap { flex-wrap: wrap; }
    .gap-1 { gap: 8px; }
    .gap-2 { gap: 16px; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .hidden { display: none; }
    
    .chip {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--glass-border);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0,20,18,0.35);
      font-size: 13px;
    }
    
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 0;
      top: 120%;
      white-space: nowrap;
      padding: 8px 12px;
      border-radius: 8px;
      background: #041a18;
      color: var(--accent);
      border: 1px solid var(--glass-border);
      z-index: 100;
      font-size: 12px;
      max-width: 300px;
      white-space: normal;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PRINT STYLESHEET
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Clean, readable printed/PDF output
       USAGE: Automatic when printing via browser or "Export PDF" button
       EXPECTED OUTCOME: Professional document suitable for archival
    */
    @media print {
      body {
        background: white;
        color: black;
      }
      
      .no-print, .hud, .toc, header.site-head, .nav, .modal {
        display: none !important;
      }
      
      .glass-card {
        border: 1px solid #ccc;
        background: white;
        page-break-inside: avoid;
      }
      
      .collapsible-content {
        max-height: none !important;
      }
      
      a {
        color: #0066cc;
        text-decoration: underline;
      }
      
      .wrap {
        max-width: 100%;
      }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE DESIGN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    @media (max-width: 768px) {
      .wrap {
        padding: 12px;
      }
      
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .toc {
        position: fixed;
        inset: 0;
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
      }
      
      .toc-toggle {
        display: block;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        padding: 20px;
      }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NOSCRIPT FALLBACK
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Graceful degradation for non-JavaScript environments
       EXPECTED OUTCOME: Core content remains accessible
    */
    noscript {
      display: block;
      padding: 20px;
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
      border-radius: 8px;
      margin: 20px;
    }
  </style>
</head>
<body>
  <!-- Noscript fallback -->
  <noscript>
    <strong>JavaScript Required:</strong> This dashboard requires JavaScript for full functionality including user authentication, offline data storage, and interactive features. Please enable JavaScript or access a simplified version of the content below.
  </noscript>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PARALLAX CANVAS LAYERS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PURPOSE: Immersive visual atmosphere with cosmic + mycelial aesthetics
       USAGE: Automatically animated, responds to mouse/gyro input
       LAYERS: Stars (depth), Nebula (atmosphere), Mycelium (living growth)
       EXPECTED OUTCOME: Beautiful, organic background that represents connection
  -->
  <canvas id="stars" style="position:fixed;inset:0;z-index:0;display:block"></canvas>
  <canvas id="nebula" style="position:fixed;inset:0;z-index:1;mix-blend-mode:screen;pointer-events:none"></canvas>
  <canvas id="myco" style="position:fixed;inset:0;z-index:1;mix-blend-mode:lighten;pointer-events:none"></canvas>

  <!-- Main application container -->
  <main>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         STICKY HEADER WITH NAVIGATION
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <header class="site-head">
      <div class="wrap">
        <div class="header-inner">
          <div class="brand">
            <svg width="40" height="40" viewBox="0 0 48 48" aria-hidden="true">
              <defs>
                <linearGradient id="g" x1="0" x2="1">
                  <stop offset="0" stop-color="#7fe3c7"/>
                  <stop offset="1" stop-color="#ffd36e"/>
                </linearGradient>
              </defs>
              <rect width="48" height="48" rx="10" fill="#02121a"/>
              <path d="M8 34c8-12 16-14 32-26" stroke="url(#g)" stroke-width="2.6" fill="none" stroke-linecap="round"/>
            </svg>
            <div>
              <h1>PRA Madagascar Node</h1>
              <p class="subtitle" id="userGreeting">Community Restoration Dashboard</p>
            </div>
          </div>

          <nav class="nav no-print">
            <div id="authButtons">
              <button class="btn" onclick="showAuthModal('login')">Sign In</button>
              <button class="btn alt" onclick="showAuthModal('signup')">Sign Up</button>
            </div>
            <div id="userButtons" class="hidden">
              <button class="btn" onclick="showDashboard()">Dashboard</button>
              <button class="btn alt" onclick="logout()">Sign Out</button>
            </div>
            <button class="btn alt no-print" onclick="toggleTOC()">â˜° Menu</button>
          </nav>
        </div>

        <!-- Search bar -->
        <div class="search-container no-print">
          <input 
            type="search" 
            class="search-input" 
            id="searchInput" 
            placeholder="Search projects, pledges, documentation..."
            aria-label="Search content"
          />
          <span class="search-icon">ğŸ”</span>
        </div>
        <div id="searchResults" class="search-results hidden"></div>
      </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TABLE OF CONTENTS (Collapsible sidebar)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <aside class="toc no-print" id="tocSidebar">
      <h3>Contents</h3>
      <ul id="tocList"></ul>
    </aside>

    <div class="wrap">
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HERO SECTION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="hero" class="glass-card">
        <h2 data-i18n="hero.title">Madagascar â€” Mycelial & Coastal Regeneration</h2>
        <p class="lead" data-i18n="hero.lead">
          This node documents grassroots restoration in Madagascar: reforestation corridors, 
          mangrove rehabilitation, community seed banks, and mycelial network research. Everything 
          here is offline-first, cryptographically stampable, and gamified to invite participation 
          from local stewards to global supporters.
        </p>
        
        <div class="flex flex-wrap gap-2 mt-2">
          <button class="btn" onclick="scrollToSection('projects')">ğŸŒ± Explore Projects</button>
          <button class="btn" onclick="scrollToSection('pledges')">ğŸ’š Make Pledge</button>
          <button class="btn" onclick="exportManifest()">ğŸ“¥ Download Manifest</button>
        </div>
        
        <div class="flex flex-wrap gap-1 mt-2">
          <span class="chip">ğŸ¯ Mâ€¢Mâ€¢S â€” Marine, Mycelium, Seed</span>
          <span class="chip">ğŸ“± Gyro-Parallax</span>
          <span class="chip">ğŸ„ Living Mycelium</span>
          <span class="chip">ğŸ”’ Privacy-First</span>
        </div>

        <!-- Theme selector -->
        <div class="mt-2">
          <label class="small">Visual Theme:</label>
          <div class="theme-selector">
            <button class="theme-btn active" onclick="setTheme('default')">ğŸŒŠ Default</button>
            <button class="theme-btn" onclick="setTheme('medieval')">ğŸ° Medieval</button>
            <button class="theme-btn" onclick="setTheme('space')">ğŸš€ Space</button>
            <button class="theme-btn" onclick="setTheme('anime')">ğŸŒ¸ Anime</button>
            <button class="theme-btn" onclick="setTheme('forest')">ğŸŒ² Forest</button>
            <button class="theme-btn" onclick="setTheme('ocean')">ğŸ‹ Ocean</button>
          </div>
        </div>

        <!-- Export buttons -->
        <div class="mt-2">
          <label class="small">Export Options:</label>
          <div class="flex flex-wrap gap-1 mt-1">
            <button class="btn small" onclick="exportHTML()">ğŸ’¾ Save HTML</button>
            <button class="btn small" onclick="window.print()">ğŸ–¨ï¸ Export PDF</button>
            <button class="btn small" onclick="bundleAttestation()">ğŸ“¦ Export JSON</button>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           USER DASHBOARD (Shown after login)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="userDashboard" class="hidden">
        <div class="collapsible active">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>ğŸ“Š Your Dashboard</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner">
              <div class="dashboard-grid">
                <div class="dashboard-card">
                  <h3>ğŸŒ± Your Impact</h3>
                  <div class="stat-big" id="userPledgeCount">0</div>
                  <div class="stat-label">Pledges Made</div>
                  <div class="mt-1">
                    <div class="stat-big" id="userXP" style="font-size:24px">0</div>
                    <div class="stat-label">Experience Points</div>
                  </div>
                </div>
                
                <div class="dashboard-card">
                  <h3>ğŸ† Badges Earned</h3>
                  <div id="userBadgesList" class="mt-1">
                    <p class="small muted">Complete actions to earn badges</p>
                  </div>
                </div>
                
                <div class="dashboard-card">
                  <h3>ğŸ“ˆ Recent Activity</h3>
                  <div id="userActivityList" class="mt-1">
                    <p class="small muted">Your activity will appear here</p>
                  </div>
                </div>
                
                <div class="dashboard-card">
                  <h3>âš¡ Quick Actions</h3>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <button class="btn small" onclick="scrollToSection('pledges')">New Pledge</button>
                    <button class="btn small" onclick="openSeedModal()">Add Seed</button>
                    <button class="btn small" onclick="scrollToSection('projects')">View Projects</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PROJECT OVERVIEW (Collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="overview">
        <div class="collapsible active">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>ğŸŒ Project Overview</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner glass-card">
              <p>Madagascar is a biodiversity treasure with unique endemism. Our node focuses on three pillars:</p>
              
              <div class="dashboard-grid mt-2">
                <div class="dashboard-card">
                  <h3>ğŸ„ Myco-Corridors</h3>
                  <p class="small">Using fungal networks to enhance soil restoration and seedling survival rates through symbiotic relationships.</p>
                </div>
                
                <div class="dashboard-card">
                  <h3>ğŸŒŠ Mangrove Rebuilds</h3>
                  <p class="small">Coastal buffer restoration for cyclone resilience and fisheries support, protecting communities and marine ecosystems.</p>
                </div>
                
                <div class="dashboard-card">
                  <h3>ğŸŒ¾ Community Seed Vaults</h3>
                  <p class="small">Decentralized, cryptographically timestamped seed provenance ledger ensuring food sovereignty and biodiversity.</p>
                </div>
              </div>

              <div class="mt-2">
                <h3>ğŸ“ Quick Facts</h3>
                <ul class="small">
                  <li><strong>Location:</strong> Eastern & northwestern Madagascar (regional partners)</li>
                  <li><strong>Focus:</strong> Rewilding, livelihoods, water security, seed sovereignty</li>
                  <li><strong>Approach:</strong> Community-led, scientifically validated, transparently tracked</li>
                  <li><strong>Contact:</strong> steward@planetaryrestorationarchive.com</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ACTIVE PROJECTS (Collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="projects">
        <div class="collapsible active">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>ğŸš€ Active Projects</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner">
              <div class="dashboard-grid">
                <div class="dashboard-card">
                  <h3>1ï¸âƒ£ Myco-Corridor Pilot â€” Tamatave</h3>
                  <p class="small">
                    Pilot mycorrhizal inoculation plots linking degraded patches. 
                    Tracking survival rate, soil carbon, and fungal DNA index.
                  </p>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <button class="btn small" onclick="claim('seedling')">Sponsor Seedlings</button>
                    <button class="btn small" onclick="claim('lab-kit')">Fund Lab Kit</button>
                  </div>
                </div>

                <div class="dashboard-card">
                  <h3>2ï¸âƒ£ Mangrove Microfund â€” Mahajamba</h3>
                  <p class="small">
                    Community-led planting and nursery training with coral reef protection tie-ins. 
                    Direct support to local stewards.
                  </p>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <button class="btn small" onclick="claim('mangrove')">Sponsor Planting</button>
                    <button class="btn small" onclick="claim('nursery')">Support Nursery</button>
                  </div>
                </div>

                <div class="dashboard-card">
                  <h3>3ï¸âƒ£ Seed Vault & Provenance</h3>
                  <p class="small">
                    Offline-first provenance ledger using IndexedDB with optional IPFS/OTS 
                    anchoring for immutable records.
                  </p>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <button class="btn small" onclick="openSeedModal()">Add Seed Entry</button>
                    <button class="btn small" onclick="exportSeeds()">Export Vault</button>
                  </div>
                </div>
              </div>

              <div class="glass-card mt-2">
                <h3>ğŸ® Gamified Participation</h3>
                <p class="small">Earn badges and XP through meaningful contributions:</p>
                <ul class="small">
                  <li><span class="badge">SEED</span> â€” Add a verified seed entry</li>
                  <li><span class="badge">PLANT</span> â€” Report 10 seedlings planted</li>
                  <li><span class="badge">GUILD</span> â€” Recruit 3 local stewards</li>
                  <li><span class="badge">ANCHOR</span> â€” Anchor pledge on-chain</li>
                </ul>
                <p class="small muted mt-1">Badges are stored locally and can be signed with your wallet when you choose to publish.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PLEDGE MANAGER (Collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="pledges">
        <div class="collapsible active">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>ğŸ’š Pledge Manager</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner glass-card">
              <p class="small">
                Make a pledge stored locally. When online, you can choose to publish (anchor). 
                Pledges are hashed locally and can be exported for attestation.
              </p>

              <form id="pledgeForm" class="mt-2" onsubmit="event.preventDefault(); savePledge();">
                <div class="mb-2">
                  <label>Name (optional)</label>
                  <input 
                    id="pledgeName" 
                    type="text"
                    placeholder="Your steward name or group"
                    aria-label="Pledge name"
                  />
                </div>

                <div class="mb-2">
                  <label>Pledge (what you'd fund or do)</label>
                  <textarea 
                    id="pledgeText" 
                    rows="4"
                    placeholder="Describe your commitment to restoration..."
                    aria-label="Pledge description"
                    required
                  ></textarea>
                </div>

                <div class="flex flex-wrap gap-1">
                  <button class="btn" type="submit">ğŸ’¾ Save Locally</button>
                  <button class="btn alt" type="button" onclick="exportPledges()">ğŸ“¤ Export</button>
                  <button class="btn alt" type="button" onclick="bundleAttestation()">ğŸ“¦ Create Attestation</button>
                </div>
              </form>

              <div class="mt-2">
                <h3>Your Local Pledges</h3>
                <div id="pledgesList"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SMART CONTRACT INTEGRATION (Collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="contracts">
        <div class="collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>â›“ï¸ Smart-Contract Pledges (Optional)</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner glass-card">
              <p class="small">
                Optional path to anchor pledges on-chain. This skeleton is safe and non-executing 
                until you explicitly confirm a transaction in your wallet.
              </p>

              <div class="dashboard-grid mt-2">
                <div class="dashboard-card">
                  <h3>Wallet Status</h3>
                  <div id="walletStatus" class="small muted">Not connected</div>
                  <button class="btn mt-1" id="connectWallet" onclick="tryConnectWallet()">
                    Connect Wallet
                  </button>
                </div>

                <div class="dashboard-card">
                  <h3>Anchor Action</h3>
                  <p class="small muted">Simulate blockchain anchoring</p>
                  <button class="btn mt-1" id="anchorPledge" onclick="simulateAnchor()" disabled>
                    Anchor Pledge (Simulate)
                  </button>
                </div>
              </div>

              <details class="mt-2">
                <summary class="small tooltip" data-tooltip="Human-readable preview of the call data">
                  ğŸ“‹ Preview Contract Call
                </summary>
                <pre id="contractPreview" class="small" style="background:#00121b;padding:12px;border-radius:8px;color:#9ff;margin-top:8px;overflow:auto;max-height:200px">
No wallet connected yet
                </pre>
              </details>

              <div class="mt-2">
                <h3>Transaction Log</h3>
                <pre id="contractLog" style="background:#00121b;padding:12px;border-radius:8px;color:#9ff;font-size:12px;max-height:200px;overflow:auto">
Logs will appear here...
                </pre>
              </div>

              <p class="small muted mt-2">
                âš ï¸ ABI & address placeholders are left for your deploy script. When ready, this UI 
                will render an exact call, gas estimate, and a plain-language summary for consent.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMMUNITY CHAT (Collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="chat">
        <div class="collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>ğŸ’¬ Community Chat</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner glass-card">
              <p class="small">
                TLK.io powers a lightweight public chat overlay. The embed loads only if you 
                choose to open it to minimize bandwidth and reduce detection surface.
              </p>
              
              <button class="btn mt-1" id="toggleTlk" onclick="toggleTlk()">
                ğŸ—¨ï¸ Open Chat
              </button>
              
              <div id="tlkContainer" class="mt-2">
                <iframe 
                  id="tlkFrame" 
                  title="Community Chat"
                  style="width:100%;height:430px;border-radius:12px;border:1px solid rgba(0,0,0,.25);display:none"
                ></iframe>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INTRASITE CONNECTIVITY (Collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <section id="intrasite">
        <div class="collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>ğŸ”— Intrasite Network</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-inner glass-card">
              <p class="small">
                This node can discover and link to sibling pages offline using a local registry. 
                Add entries to the registry below; when online, you may publish the registry JSON 
                to your preferred storage (e.g., IPFS, GitHub Pages).
              </p>

              <div class="dashboard-grid mt-2">
                <div>
                  <label class="small">Node Label</label>
                  <input id="nodeLabel" placeholder="e.g., Morocco" />
                </div>
                <div>
                  <label class="small">URL / Path</label>
                  <input id="nodeURL" placeholder="/morocco or https://..." />
                </div>
                <div style="display:flex;align-items:flex-end;gap:8px">
                  <button class="btn" onclick="addNode()">â• Add</button>
                  <button class="btn alt" onclick="exportNodes()">ğŸ“¤ Export</button>
                </div>
              </div>

              <div id="nodeList" class="mt-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FOOTER WITH ATTRIBUTIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      -->
      <footer class="glass-card">
        <div class="flex justify-between items-center flex-wrap gap-2">
          <div>
            <strong>Planetary Restoration Archive â€” Madagascar</strong>
            <p class="small muted">
              Immutable intent: All contributions are intended for restoration & community wellbeing.
            </p>
          </div>
          <div class="small muted text-right">
            Offline-first â€¢ PWA-ready â€¢ Privacy-minded<br/>
            Use responsibly â€¢ Not legal advice
          </div>
        </div>

        <details class="mt-2">
          <summary class="small" style="cursor:pointer">ğŸ“œ Attributions & Licenses</summary>
          <div class="small muted mt-1">
            <h4>Third-Party Patterns & Inspirations:</h4>
            <ul>
              <li><strong>IndexedDB Architecture:</strong> Adapted from MDN Web Docs patterns (CC-BY-SA 2.5)</li>
              <li><strong>Service Worker Pattern:</strong> Inspired by Google's Workbox library approach (Apache 2.0)</li>
              <li><strong>Canvas Parallax:</strong> Technique inspired by various open-source examples</li>
              <li><strong>Glass Morphism UI:</strong> Contemporary web design pattern (public domain)</li>
              <li><strong>TLK.io:</strong> Third-party chat service (see tlk.io/terms)</li>
            </ul>
            <p class="mt-1">
              All code written specifically for this project is released under MIT License for 
              peaceful restoration purposes. Commercial surveillance or extractive use is prohibited.
            </p>
          </div>
        </details>

        <div class="text-center mt-2 small muted">
          <p>
            <strong>Zero-Harm Declaration:</strong> This system is designed exclusively for 
            ecological restoration and must not be weaponized, used for surveillance, or 
            repurposed for harm. All users commit to regenerative principles.
          </p>
        </div>
      </footer>
    </div>
  </main>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GAMIFICATION HUD (Fixed position)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <div class="hud no-print">
    <div class="mini glass-card">
      <div class="hud-item">
        <span class="hud-label">XP</span>
        <span class="hud-value" id="xpVal">0</span>
      </div>
      <div class="hud-item">
        <span class="hud-label">Level</span>
        <span class="hud-value" id="levelVal">1</span>
      </div>
      <div class="small muted" style="margin-top:6px">
        Badges: <span id="badgeList">â€”</span>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AUTHENTICATION MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="authModalTitle">Sign In</h2>
        <button class="modal-close" onclick="closeAuthModal()" aria-label="Close">&times;</button>
      </div>

      <div id="authModalBody">
        <form id="authForm" onsubmit="event.preventDefault(); handleAuth();">
          <div class="mb-2">
            <label>Username</label>
            <input 
              id="authUsername" 
              type="text" 
              required 
              minlength="3"
              autocomplete="username"
              aria-label="Username"
            />
          </div>

          <div class="mb-2">
            <label>Password</label>
            <input 
              id="authPassword" 
              type="password" 
              required 
              minlength="8"
              autocomplete="current-password"
              aria-label="Password"
            />
          </div>

          <div class="mb-2" id="authEmailGroup" style="display:none">
            <label>Email (optional, for notifications)</label>
            <input 
              id="authEmail" 
              type="email"
              autocomplete="email"
              aria-label="Email"
            />
          </div>

          <button class="btn" type="submit" style="width:100%">
            <span id="authSubmitText">Sign In</span>
          </button>

          <p class="small muted text-center mt-1">
            <a href="#" id="authToggle" onclick="event.preventDefault(); toggleAuthMode()">
              Need an account? Sign up
            </a>
          </p>
        </form>

        <div class="small muted mt-2" style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px">
          <strong>ğŸ”’ Privacy Note:</strong> Your credentials are stored locally using secure hashing. 
          No data leaves your device without explicit consent. This is a fully offline-capable system.
        </div>
      </div>
    </div>
  </div>

  <!-- TOC toggle for mobile -->
  <button class="btn toc-toggle no-print" onclick="toggleTOC()">â˜°</button>

  <script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CORE JAVASCRIPT APPLICATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   
   ARCHITECTURE OVERVIEW:
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   1. Service Worker & PWA (offline-first capability)
   2. IndexedDB Layer (persistent local storage)
   3. Authentication System (local, hashed credentials)
   4. Analytics Tracker (privacy-focused, optional email)
   5. Canvas Parallax System (visual atmosphere)
   6. UI Controllers (collapsibles, search, theme)
   7. Data Management (pledges, seeds, nodes, badges)
   8. Export Functions (HTML, PDF, JSON)
   
   USAGE:
   â”â”â”â”â”â”
   - All functions are well-documented inline
   - Rate limiting prevents abuse
   - Input sanitization throughout
   - No external dependencies (pure vanilla JS)
   
   EXPECTED BEHAVIOR:
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   - Works offline after first load
   - Syncs when user chooses
   - Never sends data without consent
   - Degrades gracefully without JS
*/

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1. SERVICE WORKER & PWA SETUP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Enable offline functionality and app-like experience
   USAGE: Auto-registers on page load, caches critical assets
   EXPECTED OUTCOME: Site works without internet connection
*/
(function initServiceWorker() {
  const swCode = `
    const CACHE_VERSION = 'pra-madagascar-v3';
    const CORE_ASSETS = ['/', '/index.html'];
    
    self.addEventListener('install', event => {
      self.skipWaiting();
      event.waitUntil(
        caches.open(CACHE_VERSION).then(cache => cache.addAll(CORE_ASSETS))
      );
    });
    
    self.addEventListener('activate', event => {
      event.waitUntil(
        caches.keys().then(keys =>
          Promise.all(
            keys.map(key => key !== CACHE_VERSION && caches.delete(key))
          )
        )
      );
      self.clients.claim();
    });
    
    self.addEventListener('fetch', event => {
      if (event.request.method !== 'GET') return;
      
      event.respondWith(
        (async () => {
          const cache = await caches.open(CACHE_VERSION);
          const cached = await cache.match(event.request);
          
          if (cached) return cached;
          
          try {
            const response = await fetch(event.request);
            if (response?.ok) {
              cache.put(event.request, response.clone());
            }
            return response;
          } catch (err) {
            return cached || new Response('Offline', { status: 503 });
          }
        })()
      );
    });
  `;
  
  try {
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(swUrl).catch(() => {});
    }
  } catch (e) {
    console.warn('Service worker registration failed', e);
  }

  // Web app manifest
  const manifest = {
    name: "PRA Madagascar Dashboard",
    short_name: "PRA-MG",
    start_url: "/index.html",
    display: "standalone",
    background_color: "#04060b",
    theme_color: "#081221",
    icons: [{
      src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Crect width='48' height='48' rx='10' fill='%2302121a'/%3E%3Cpath d='M8 34c8-12 16-14 32-26' stroke='%237fe3c7' stroke-width='2.6' fill='none' stroke-linecap='round'/%3E%3C/svg%3E",
      sizes: "48x48",
      type: "image/svg+xml"
    }]
  };
  
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  const manifestUrl = URL.createObjectURL(manifestBlob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestUrl;
  document.head.appendChild(link);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2. INDEXEDDB LAYER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Persistent local storage for all user data
   STORES: users, pledges, badges, nodes, prefs, analytics
   USAGE: All async operations, automatic version management
   EXPECTED OUTCOME: Reliable data persistence across sessions
*/
const DB_NAME = 'pra-madagascar';
const DB_VERSION = 3;
let db = null;

async function openDB() {
  if (db) return db;
  
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onupgradeneeded = (event) => {
      const database = event.target.result;
      
      // Create object stores if they don't exist
      if (!database.objectStoreNames.contains('users')) {
        database.createObjectStore('users', { keyPath: 'username' });
      }
      if (!database.objectStoreNames.contains('pledges')) {
        database.createObjectStore('pledges', { keyPath: 'id' });
      }
      if (!database.objectStoreNames.contains('badges')) {
        database.createObjectStore('badges', { keyPath: 'id' });
      }
      if (!database.objectStoreNames.contains('nodes')) {
        database.createObjectStore('nodes', { keyPath: 'id' });
      }
      if (!database.objectStoreNames.contains('prefs')) {
        database.createObjectStore('prefs', { keyPath: 'key' });
      }
      if (!database.objectStoreNames.contains('analytics')) {
        database.createObjectStore('analytics', { keyPath: 'id', autoIncrement: true });
      }
    };
    
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onerror = () => reject(request.error);
  });
}

async function saveLocal(store, item) {
  const database = await openDB();
  return new Promise((resolve, reject) => {
    const transaction = database.transaction(store, 'readwrite');
    transaction.objectStore(store).put(item);
    transaction.oncomplete = () => resolve(true);
    transaction.onerror = () => reject(transaction.error);
  });
}

async function getAll(store) {
  const database = await openDB();
  return new Promise((resolve, reject) => {
    const transaction = database.transaction(store, 'readonly');
    const request = transaction.objectStore(store).getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function getOne(store, key) {
  const database = await openDB();
  return new Promise((resolve, reject) => {
    const transaction = database.transaction(store, 'readonly');
    const request = transaction.objectStore(store).get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function getPref(key) {
  const result = await getOne('prefs', key);
  return result?.val;
}

async function setPref(key, val) {
  return saveLocal('prefs', { key, val });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3. AUTHENTICATION SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Local user authentication without server dependency
   SECURITY: SHA-256 password hashing, rate limiting, secure storage
   USAGE: Sign up, sign in, maintain session
   EXPECTED OUTCOME: Secure local authentication suitable for offline use
   
   IMPORTANT: This is client-side only. For production with server sync,
   implement proper backend authentication with bcrypt/argon2.
*/

let currentUser = null;
const LOGIN_ATTEMPTS = new Map();
const MAX_ATTEMPTS = 5;
const ATTEMPT_WINDOW = 15 * 60 * 1000; // 15 minutes

// Simple password hashing (SHA-256 with salt)
// NOTE: For production, use proper server-side hashing with bcrypt/argon2
async function hashPassword(password, salt) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password + salt);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

function generateSalt() {
  return Array.from(crypto.getRandomValues(new Uint8Array(16)))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

function checkRateLimit(username) {
  const now = Date.now();
  const attempts = LOGIN_ATTEMPTS.get(username) || [];
  const recentAttempts = attempts.filter(time => now - time < ATTEMPT_WINDOW);
  
  if (recentAttempts.length >= MAX_ATTEMPTS) {
    const oldestAttempt = Math.min(...recentAttempts);
    const waitTime = Math.ceil((ATTEMPT_WINDOW - (now - oldestAttempt)) / 1000 / 60);
    throw new Error(`Too many login attempts. Please wait ${waitTime} minutes.`);
  }
  
  recentAttempts.push(now);
  LOGIN_ATTEMPTS.set(username, recentAttempts);
}

async function signup(username, password, email = '') {
  // Input validation
  if (!username || username.length < 3) {
    throw new Error('Username must be at least 3 characters');
  }
  if (!password || password.length < 8) {
    throw new Error('Password must be at least 8 characters');
  }
  
  // Sanitize inputs
  username = username.trim().toLowerCase();
  email = email.trim().toLowerCase();
  
  // Check if user exists
  const existingUser = await getOne('users', username);
  if (existingUser) {
    throw new Error('Username already exists');
  }
  
  // Create user
  const salt = generateSalt();
  const passwordHash = await hashPassword(password, salt);
  
  const user = {
    username,
    passwordHash,
    salt,
    email,
    createdAt: new Date().toISOString(),
    xp: 0,
    level: 1
  };
  
  await saveLocal('users', user);
  trackAnalytics('user_signup', { username });
  
  return user;
}

async function login(username, password) {
  username = username.trim().toLowerCase();
  
  // Rate limiting
  checkRateLimit(username);
  
  // Get user
  const user = await getOne('users', username);
  if (!user) {
    throw new Error('Invalid username or password');
  }
  
  // Verify password
  const passwordHash = await hashPassword(password, user.salt);
  if (passwordHash !== user.passwordHash) {
    throw new Error('Invalid username or password');
  }
  
  // Set current user
  currentUser = user;
  await setPref('currentUser', username);
  updateUIForUser();
  trackAnalytics('user_login', { username });
  
  return user;
}

async function logout() {
  currentUser = null;
  await setPref('currentUser', null);
  updateUIForUser();
  trackAnalytics('user_logout', { username: currentUser?.username });
  toast('Signed out successfully');
}

async function restoreSession() {
  const username = await getPref('currentUser');
  if (username) {
    currentUser = await getOne('users', username);
    updateUIForUser();
  }
}

function updateUIForUser() {
  const authButtons = document.getElementById('authButtons');
  const userButtons = document.getElementById('userButtons');
  const userDashboard = document.getElementById('userDashboard');
  const userGreeting = document.getElementById('userGreeting');
  
  if (currentUser) {
    authButtons.classList.add('hidden');
    userButtons.classList.remove('hidden');
    userDashboard.classList.remove('hidden');
    userGreeting.textContent = `Welcome back, ${currentUser.username}!`;
    updateDashboard();
  } else {
    authButtons.classList.remove('hidden');
    userButtons.classList.add('hidden');
    userDashboard.classList.add('hidden');
    userGreeting.textContent = 'Community Restoration Dashboard';
  }
}

async function updateDashboard() {
  if (!currentUser) return;
  
  // Update stats
  const pledges = await getAll('pledges');
  const userPledges = pledges.filter(p => p.userId === currentUser.username);
  document.getElementById('userPledgeCount').textContent = userPledges.length;
  document.getElementById('userXP').textContent = currentUser.xp || 0;
  
  // Update badges
  const badges = await getAll('badges');
  const userBadges = badges.filter(b => b.userId === currentUser.username);
  const badgesHTML = userBadges.length 
    ? userBadges.map(b => `<span class="badge">${escapeHtml(b.label)}</span>`).join(' ')
    : '<p class="small muted">No badges yet</p>';
  document.getElementById('userBadgesList').innerHTML = badgesHTML;
  
  // Update activity
  const recentPledges = userPledges.slice(-5).reverse();
  const activityHTML = recentPledges.length
    ? recentPledges.map(p => `
        <div class="small" style="margin-bottom:8px;padding:8px;background:var(--glass);border-radius:6px">
          <strong>${escapeHtml(p.name || 'Pledge')}</strong><br>
          <span class="muted">${new Date(p.ts).toLocaleDateString()}</span>
        </div>
      `).join('')
    : '<p class="small muted">No recent activity</p>';
  document.getElementById('userActivityList').innerHTML = activityHTML;
}

// Modal controls
let authMode = 'login';

function showAuthModal(mode = 'login') {
  authMode = mode;
  const modal = document.getElementById('authModal');
  const title = document.getElementById('authModalTitle');
  const submitText = document.getElementById('authSubmitText');
  const toggle = document.getElementById('authToggle');
  const emailGroup = document.getElementById('authEmailGroup');
  
  if (mode === 'signup') {
    title.textContent = 'Create Account';
    submitText.textContent = 'Sign Up';
    toggle.textContent = 'Already have an account? Sign in';
    emailGroup.style.display = 'block';
  } else {
    title.textContent = 'Sign In';
    submitText.textContent = 'Sign In';
    toggle.textContent = 'Need an account? Sign up';
    emailGroup.style.display = 'none';
  }
  
  modal.classList.add('active');
  document.getElementById('authUsername').focus();
}

function closeAuthModal() {
  document.getElementById('authModal').classList.remove('active');
  document.getElementById('authForm').reset();
}

function toggleAuthMode() {
  showAuthModal(authMode === 'login' ? 'signup' : 'login');
}

async function handleAuth() {
  const username = document.getElementById('authUsername').value;
  const password = document.getElementById('authPassword').value;
  const email = document.getElementById('authEmail').value;
  
  try {
    if (authMode === 'signup') {
      await signup(username, password, email);
      toast('Account created successfully! Please sign in.');
      showAuthModal('login');
    } else {
      await login(username, password);
      toast(`Welcome back, ${username}!`);
      closeAuthModal();
    }
  } catch (error) {
    toast(error.message);
  }
}

function showDashboard() {
  document.getElementById('userDashboard').scrollIntoView({ behavior: 'smooth' });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   4. ANALYTICS & TRACKING (Privacy-focused)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Track usage patterns for improvement, not surveillance
   PRIVACY: All data stored locally, only sent if user opts in
   USAGE: Automatic tracking of key events with daily summaries
   EXPECTED OUTCOME: Insights into feature usage without compromising privacy
*/

async function trackAnalytics(event, data = {}) {
  const entry = {
    event,
    data,
    timestamp: new Date().toISOString(),
    user: currentUser?.username || 'anonymous'
  };
  
  await saveLocal('analytics', entry);
  
  // Check if we should send daily summary
  const lastSent = await getPref('lastAnalyticsSent');
  const now = Date.now();
  const oneDay = 24 * 60 * 60 * 1000;
  
  if (!lastSent || now - lastSent > oneDay) {
    await sendAnalyticsSummary();
    await setPref('lastAnalyticsSent', now);
  }
}

async function sendAnalyticsSummary() {
  // This function would normally send analytics to admin email
  // For now, it just prepares the summary
  const analytics = await getAll('analytics');
  const lastDay = analytics.filter(a => 
    Date.now() - new Date(a.timestamp).getTime() < 24 * 60 * 60 * 1000
  );
  
  const summary = {
    totalEvents: lastDay.length,
    uniqueUsers: new Set(lastDay.map(a => a.user)).size,
    eventCounts: lastDay.reduce((acc, a) => {
      acc[a.event] = (acc[a.event] || 0) + 1;
      return acc;
    }, {}),
    timestamp: new Date().toISOString()
  };
  
  // In production, this would send to admin@planetaryrestorationarchive.com
  // For now, just log to console
  console.log('Analytics Summary (24h):', summary);
  
  // Store summary locally
  await saveLocal('prefs', { 
    key: 'lastAnalyticsSummary', 
    val: summary 
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   5. CANVAS PARALLAX SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Create immersive visual atmosphere with cosmic + organic aesthetics
   USAGE: Automatically renders and animates on page load
   LAYERS: Stars (depth), Nebula (atmosphere), Mycelium (living growth)
   PERFORMANCE: Optimized with requestAnimationFrame
   EXPECTED OUTCOME: Beautiful, responsive background animation
*/

(function initParallax() {
  // Stars layer
  const stars = document.getElementById('stars');
  const ctx = stars.getContext('2d');
  let w = stars.width = innerWidth;
  let h = stars.height = innerHeight;
  
  const layers = [];
  function rng(seed) {
    let x = Math.sin(seed) * 1e4;
    return () => (x = Math.sin(x) * 1e4, x - Math.floor(x));
  }
  
  const r = rng(117);
  
  function createLayer(count, speed, size, color) {
    const starArray = [];
    for (let i = 0; i < count; i++) {
      starArray.push({
        x: r() * w,
        y: r() * h,
        z: r(),
        r: 1 + r() * size,
        t: r() * 6.28
      });
    }
    layers.push({ stars: starArray, speed, color });
  }
  
  createLayer(260, 0.02, 1.6, '255,255,255');
  createLayer(130, 0.06, 2.4, '180,220,255');
  createLayer(70, 0.12, 3.4, '200,255,220');
  
  let mx = 0, my = 0, t = 0, gx = 0, gy = 0;
  
  addEventListener('mousemove', e => {
    mx = (e.clientX - w / 2) / w;
    my = (e.clientY - h / 2) / h;
  });
  
  addEventListener('resize', () => {
    w = stars.width = innerWidth;
    h = stars.height = innerHeight;
  });
  
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', e => {
      gx = (e.gamma || 0) / 45;
      gy = (e.beta || 0) / 90;
    }, true);
  }
  
  function drawStars() {
    t += 0.01;
    
    const gradient = ctx.createLinearGradient(0, 0, 0, h);
    gradient.addColorStop(0, '#02141c');
    gradient.addColorStop(1, '#061019');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, w, h);
    
    for (let i = 0; i < layers.length; i++) {
      const layer = layers[i];
      for (const star of layer.stars) {
        const px = (star.x + (mx + gx) * (i + 1) * 40 + Math.sin(t + star.t) * 6) % w;
        const py = (star.y + (my + gy) * (i + 1) * 30 + Math.cos(t + star.t) * 6) % h;
        ctx.fillStyle = `rgba(${layer.color},${0.8 * (0.6 + star.z * 0.4)})`;
        ctx.beginPath();
        ctx.arc(px, py, star.r * (0.6 + Math.sin(t + star.t) * 0.4), 0, Math.PI * 2);
        ctx.fill();
        
        // Occasional constellation lines
        if (Math.random() < 0.004) {
          const other = layer.stars[(Math.random() * layer.stars.length) | 0];
          const px2 = (other.x + (mx + gx) * (i + 1) * 40) % w;
          const py2 = (other.y + (my + gy) * (i + 1) * 30) % h;
          ctx.strokeStyle = 'rgba(127,227,199,.06)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(px, py);
          ctx.lineTo(px2, py2);
          ctx.stroke();
        }
      }
    }
    
    requestAnimationFrame(drawStars);
  }
  
  drawStars();
  
  // Nebula layer
  const nebula = document.getElementById('nebula');
  const nctx = nebula.getContext('2d');
  nebula.width = w;
  nebula.height = h;
  
  function noise(x, y, s) {
    return (Math.sin(x * 0.01 * s) + Math.cos(y * 0.008 * s) + 
            Math.sin((x + y) * 0.005 * s)) * 0.5 + 0.5;
  }
  
  function paintNebula() {
    nebula.width = innerWidth;
    nebula.height = innerHeight;
    const img = nctx.createImageData(nebula.width, nebula.height);
    
    for (let y = 0; y < nebula.height; y += 2) {
      for (let x = 0; x < nebula.width; x += 2) {
        const n1 = noise(x, y, 1.2);
        const n2 = noise(x + 200, y + 50, 0.6);
        const n3 = noise(x * 1.4, y * 1.2, 0.9);
        let v = Math.max(0, (n1 * 0.6 + n2 * 0.3 + n3 * 0.4) - 0.85);
        v = Math.min(1, v * 4);
        
        const r = 127 + 128 * v;
        const g = 200 * v;
        const b = 255 * v * 0.8;
        const a = v * 70;
        
        for (let dy = 0; dy < 2; dy++) {
          for (let dx = 0; dx < 2; dx++) {
            const idx = ((y + dy) * nebula.width + (x + dx)) * 4;
            img.data[idx] = r;
            img.data[idx + 1] = g;
            img.data[idx + 2] = b;
            img.data[idx + 3] = a;
          }
        }
      }
    }
    
    nctx.putImageData(img, 0, 0);
  }
  
  paintNebula();
  
  // Mycelium layer
  const myco = document.getElementById('myco');
  const mctx = myco.getContext('2d');
  let W = myco.width = innerWidth;
  let H = myco.height = innerHeight;
  
  addEventListener('resize', () => {
    W = myco.width = innerWidth;
    H = myco.height = innerHeight;
  });
  
  const nodes = [];
  
  function seedMycelium(count = 24) {
    nodes.length = 0;
    for (let i = 0; i < count; i++) {
      nodes.push({
        x: Math.random() * W,
        y: Math.random() * H,
        a: Math.random() * 6.28,
        v: 0.3 + 0.4 * Math.random()
      });
    }
  }
  
  seedMycelium();
  
  function stepMycelium() {
    mctx.clearRect(0, 0, W, H);
    mctx.globalCompositeOperation = 'lighter';
    
    for (const node of nodes) {
      const nx = node.x + Math.cos(node.a) * node.v;
      const ny = node.y + Math.sin(node.a) * node.v;
      
      mctx.strokeStyle = 'rgba(127,227,199,.08)';
      mctx.lineWidth = 1.2;
      mctx.beginPath();
      mctx.moveTo(node.x, node.y);
      mctx.lineTo(nx, ny);
      mctx.stroke();
      
      node.x = nx;
      node.y = ny;
      node.a += (Math.random() - 0.5) * 0.6;
      
      // Wrap around
      if (node.x < 0) node.x += W;
      if (node.x > W) node.x -= W;
      if (node.y < 0) node.y += H;
      if (node.y > H) node.y -= H;
      
      // Occasional branching
      if (Math.random() < 0.004 && nodes.length < 320) {
        nodes.push({
          x: node.x,
          y: node.y,
          a: node.a + (Math.random() - 0.5),
          v: node.v * (0.9 + Math.random() * 0.2)
        });
      }
    }
    
    requestAnimationFrame(stepMycelium);
  }
  
  stepMycelium();
  
  // Growth boost function (called on pledges)
  window.__mycoBoost = function() {
    for (let i = 0; i < 12; i++) {
      nodes.push({
        x: Math.random() * W,
        y: Math.random() * H,
        a: Math.random() * 6.28,
        v: 0.3 + 0.5 * Math.random()
      });
    }
  };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   6. UI CONTROLLERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Manage interactive UI elements
   USAGE: Called by user actions
   EXPECTED OUTCOME: Smooth, intuitive interface interactions
*/

// Collapsible sections
function toggleCollapsible(header) {
  const collapsible = header.closest('.collapsible');
  collapsible.classList.toggle('active');
  trackAnalytics('toggle_section', { 
    section: header.querySelector('h2, h3')?.textContent 
  });
}

// Table of contents
function generateTOC() {
  const sections = document.querySelectorAll('section[id]');
  const tocList = document.getElementById('tocList');
  
  sections.forEach(section => {
    const heading = section.querySelector('h2, h3');
    if (!heading) return;
    
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = `#${section.id}`;
    a.textContent = heading.textContent.replace(/[â–¼â–²]/g, '').trim();
    a.onclick = (e) => {
      e.preventDefault();
      scrollToSection(section.id);
      if (window.innerWidth <= 768) {
        toggleTOC();
      }
    };
    li.appendChild(a);
    tocList.appendChild(li);
  });
}

function toggleTOC() {
  const toc = document.getElementById('tocSidebar');
  toc.classList.toggle('active');
}

function scrollToSection(id) {
  const section = document.getElementById(id);
  if (section) {
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    trackAnalytics('navigate_to_section', { section: id });
  }
}

// Search functionality
let searchIndex = [];

function buildSearchIndex() {
  searchIndex = [];
  const sections = document.querySelectorAll('section');
  
  sections.forEach(section => {
    const title = section.querySelector('h2, h3')?.textContent || '';
    const content = section.textContent || '';
    searchIndex.push({
      id: section.id,
      title,
      content: content.slice(0, 500) // First 500 chars
    });
  });
}

function search(query) {
  if (!query || query.length < 2) {
    document.getElementById('searchResults').classList.add('hidden');
    return;
  }
  
  query = query.toLowerCase();
  const results = searchIndex
    .map(item => {
      const titleMatch = item.title.toLowerCase().includes(query);
      const contentMatch = item.content.toLowerCase().includes(query);
      
      if (!titleMatch && !contentMatch) return null;
      
      const index = item.content.toLowerCase().indexOf(query);
      const snippet = index >= 0 
        ? '...' + item.content.slice(Math.max(0, index - 50), index + 100) + '...'
        : item.content.slice(0, 150) + '...';
      
      return {
        ...item,
        snippet: highlightText(snippet, query),
        score: titleMatch ? 10 : 1
      };
    })
    .filter(Boolean)
    .sort((a, b) => b.score - a.score)
    .slice(0, 5);
  
  displaySearchResults(results);
  trackAnalytics('search', { query, resultCount: results.length });
}

function highlightText(text, query) {
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function displaySearchResults(results) {
  const container = document.getElementById('searchResults');
  
  if (results.length === 0) {
    container.innerHTML = '<div class="small muted" style="padding:12px">No results found</div>';
    container.classList.remove('hidden');
    return;
  }
  
  container.innerHTML = results.map(result => `
    <div class="search-result-item" onclick="scrollToSection('${result.id}')">
      <div class="search-result-title">${escapeHtml(result.title)}</div>
      <div class="search-result-snippet">${result.snippet}</div>
    </div>
  `).join('');
  
  container.classList.remove('hidden');
}

// Debounced search
let searchTimeout;
document.getElementById('searchInput')?.addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => search(e.target.value), 300);
});

// Theme system
async function setTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  await setPref('theme', theme);
  
  // Update button states
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  trackAnalytics('change_theme', { theme });
}

async function restoreTheme() {
  const savedTheme = await getPref('theme');
  if (savedTheme) {
    document.body.setAttribute('data-theme', savedTheme);
    const btn = Array.from(document.querySelectorAll('.theme-btn'))
      .find(b => b.textContent.toLowerCase().includes(savedTheme));
    if (btn) {
      document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
  } else {
    // Auto-detect system preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      setTheme('default');
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7. PLEDGE MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Create, store, and manage user pledges for restoration projects
   USAGE: Users can make pledges that are stored locally and optionally anchored
   SECURITY: Input sanitization, rate limiting, cryptographic hashing
   EXPECTED OUTCOME: Transparent, verifiable pledge system
*/

async function savePledge() {
  if (!currentUser) {
    toast('Please sign in to make a pledge');
    showAuthModal('login');
    return;
  }
  
  const name = document.getElementById('pledgeName').value?.trim() || currentUser.username;
  const text = document.getElementById('pledgeText').value?.trim();
  
  if (!text) {
    toast('Please describe your pledge');
    return;
  }
  
  // Input validation and sanitization
  if (text.length < 10) {
    toast('Pledge description must be at least 10 characters');
    return;
  }
  
  if (text.length > 5000) {
    toast('Pledge description must be less than 5000 characters');
    return;
  }
  
  const id = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
  const pledge = {
    id,
    name: escapeHtml(name),
    text: escapeHtml(text),
    userId: currentUser.username,
    ts: new Date().toISOString(),
    hash: await sha256Hex(text)
  };
  
  await saveLocal('pledges', pledge);
  await loadPledges();
  
  document.getElementById('pledgeName').value = '';
  document.getElementById('pledgeText').value = '';
  
  toast('Pledge saved locally â€” export or anchor when ready');
  increaseXP(5);
  
  if (window.__mycoBoost) {
    window.__mycoBoost();
  }
  
  trackAnalytics('pledge_created', { userId: currentUser.username });
}

async function loadPledges() {
  const pledges = await getAll('pledges');
  const userPledges = currentUser 
    ? pledges.filter(p => p.userId === currentUser.username)
    : [];
  
  const container = document.getElementById('pledgesList');
  
  if (userPledges.length === 0) {
    container.innerHTML = '<div class="small muted">No local pledges yet. Make your first pledge above!</div>';
    return;
  }
  
  container.innerHTML = userPledges.map(pledge => `
    <div style="padding:12px;border-radius:10px;border:1px solid var(--glass-border);margin-bottom:10px;background:var(--glass)">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px">
        <strong>${escapeHtml(pledge.name)}</strong>
        <span class="small muted">${new Date(pledge.ts).toLocaleDateString()}</span>
      </div>
      <div class="small">${escapeHtml(pledge.text)}</div>
      <div class="small muted" style="margin-top:6px;font-family:monospace;font-size:11px">
        Hash: ${pledge.hash?.slice(0, 16)}...
      </div>
    </div>
  `).join('');
}

async function exportPledges() {
  const pledges = await getAll('pledges');
  const userPledges = currentUser
    ? pledges.filter(p => p.userId === currentUser.username)
    : pledges;
  
  const bundle = await withHashes({
    type: 'pledges',
    items: userPledges,
    exportedBy: currentUser?.username || 'anonymous',
    exportedAt: new Date().toISOString()
  });
  
  saveFile(
    JSON.stringify(bundle, null, 2),
    `pra-madagascar-pledges-${Date.now()}.attest.json`,
    'application/json'
  );
  
  trackAnalytics('export_pledges', { count: userPledges.length });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8. SEED VAULT MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Track and preserve seed provenance for food sovereignty
   USAGE: Add seed entries with metadata, export for sharing/archival
   EXPECTED OUTCOME: Decentralized seed library with cryptographic verification
*/

function openSeedModal() {
  if (!currentUser) {
    toast('Please sign in to add seed entries');
    showAuthModal('login');
    return;
  }
  
  const name = prompt('Seed name / local identifier (e.g., "Madagascar Red Rice"):');
  if (!name || name.trim().length < 2) {
    toast('Please provide a valid seed name');
    return;
  }
  
  const location = prompt('Collection location (optional):') || 'Not specified';
  const notes = prompt('Additional notes (optional):') || '';
  
  const entry = {
    id: 's_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
    name: escapeHtml(name.trim()),
    location: escapeHtml(location),
    notes: escapeHtml(notes),
    userId: currentUser.username,
    ts: new Date().toISOString()
  };
  
  const pledgeEntry = {
    id: 'seed_' + entry.id,
    name: 'seed-vault',
    text: JSON.stringify(entry),
    userId: currentUser.username,
    ts: entry.ts
  };
  
  saveLocal('pledges', pledgeEntry).then(() => {
    toast('Seed entry saved to local vault');
    increaseXP(3);
    awardBadge('seed_' + Date.now(), 'SEED');
    
    if (window.__mycoBoost) {
      window.__mycoBoost();
    }
    
    trackAnalytics('seed_added', { seedName: entry.name });
  });
}

async function exportSeeds() {
  const pledges = await getAll('pledges');
  const seeds = pledges.filter(p => p.id && p.id.startsWith('seed_'));
  
  if (seeds.length === 0) {
    toast('No seed entries to export');
    return;
  }
  
  const bundle = await withHashes({
    type: 'seeds',
    items: seeds.map(s => {
      try {
        return { ...s, parsed: JSON.parse(s.text) };
      } catch {
        return s;
      }
    }),
    exportedBy: currentUser?.username || 'anonymous',
    exportedAt: new Date().toISOString()
  });
  
  saveFile(
    JSON.stringify(bundle, null, 2),
    `pra-madagascar-seedvault-${Date.now()}.attest.json`,
    'application/json'
  );
  
  trackAnalytics('export_seeds', { count: seeds.length });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   9. BADGES & XP SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Gamification to encourage participation and recognize contributions
   USAGE: Automatically award badges and XP for actions
   PSYCHOLOGY: Positive reinforcement for regenerative behaviors
   EXPECTED OUTCOME: Increased engagement and sustained participation
*/

async function awardBadge(id, label) {
  if (!currentUser) return;
  
  const badge = {
    id: id || 'badge_' + Date.now(),
    label,
    userId: currentUser.username,
    ts: new Date().toISOString()
  };
  
  await saveLocal('badges', badge);
  await loadBadges();
  toast(`ğŸ† Badge earned: ${label}`);
  trackAnalytics('badge_earned', { badge: label, userId: currentUser.username });
}

async function loadBadges() {
  const badges = await getAll('badges');
  const userBadges = currentUser
    ? badges.filter(b => b.userId === currentUser.username)
    : [];
  
  const badgeList = document.getElementById('badgeList');
  badgeList.innerHTML = userBadges.length > 0
    ? userBadges.map(b => `<span class="badge">${escapeHtml(b.label)}</span>`).join(' ')
    : 'â€”';
  
  updateHUD();
}

async function increaseXP(amount) {
  if (!currentUser) return;
  
  currentUser.xp = (currentUser.xp || 0) + amount;
  
  // Calculate level (every 100 XP = 1 level)
  const newLevel = Math.floor(currentUser.xp / 100) + 1;
  const oldLevel = currentUser.level || 1;
  
  if (newLevel > oldLevel) {
    currentUser.level = newLevel;
    toast(`ğŸ‰ Level up! You are now level ${newLevel}`);
    trackAnalytics('level_up', { level: newLevel, userId: currentUser.username });
  }
  
  await saveLocal('users', currentUser);
  updateHUD();
  updateDashboard();
}

function updateHUD() {
  if (currentUser) {
    document.getElementById('xpVal').textContent = currentUser.xp || 0;
    document.getElementById('levelVal').textContent = currentUser.level || 1;
  }
}

async function claim(tag) {
  if (!currentUser) {
    toast('Please sign in to claim rewards');
    showAuthModal('login');
    return;
  }
  
  await awardBadge('claim_' + tag + '_' + Date.now(), tag.toUpperCase());
  
  const claimPledge = {
    id: 'pledge_' + tag + '_' + Date.now(),
    name: 'auto-claim',
    text: 'Claimed: ' + tag,
    userId: currentUser.username,
    ts: new Date().toISOString()
  };
  
  await saveLocal('pledges', claimPledge);
  toast(`Claim noted locally: ${tag}`);
  increaseXP(10);
  
  trackAnalytics('claim_action', { tag, userId: currentUser.username });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   10. SMART CONTRACT INTEGRATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Optional blockchain anchoring for immutable pledge records
   USAGE: Connect wallet, simulate or execute on-chain anchoring
   SECURITY: User must explicitly approve all transactions
   EXPECTED OUTCOME: Optional on-chain verification without mandatory blockchain use
*/

let userAddress = null;

async function tryConnectWallet() {
  if (!window.ethereum) {
    toast('No Ethereum provider detected. Please install MetaMask or similar wallet.');
    return;
  }
  
  try {
    const accounts = await window.ethereum.request({ 
      method: 'eth_requestAccounts' 
    });
    
    userAddress = accounts[0];
    document.getElementById('walletStatus').textContent = userAddress;
    document.getElementById('anchorPledge').disabled = false;
    
    logContract('Wallet connected: ' + userAddress);
    await renderPreview();
    
    trackAnalytics('wallet_connected', { address: userAddress.slice(0, 10) + '...' });
  } catch (error) {
    logContract('Wallet connection cancelled or failed: ' + error.message);
    toast('Wallet connection cancelled');
  }
}

async function renderPreview() {
  const pledges = await getAll('pledges');
  const recentPledges = pledges.slice(-5);
  
  const hashes = await Promise.all(
    recentPledges.map(p => sha256Hex(p.text || ''))
  );
  
  const demo = {
    method: 'anchorPledges(bytes32[])',
    to: '0xYourContractAddressHere',
    from: userAddress || '0x0000000000000000000000000000000000000000',
    args: hashes,
    estimatedGas: '~150,000',
    note: 'This is a preview. Actual transaction requires contract deployment.'
  };
  
  document.getElementById('contractPreview').textContent = 
    JSON.stringify(demo, null, 2);
}

async function simulateAnchor() {
  if (!userAddress) {
    toast('Please connect your wallet first');
    return;
  }
  
  const sampleHash = '0x' + Array.from(
    crypto.getRandomValues(new Uint8Array(32))
  ).map(b => b.toString(16).padStart(2, '0')).join('');
  
  logContract('Simulated anchor transaction created');
  logContract('Transaction hash: ' + sampleHash);
  logContract('Status: Confirmed (simulation)');
  logContract('Gas used: 127,456 (simulation)');
  
  toast('Simulated anchor created â€” view log for details');
  await awardBadge('anchor_' + Date.now(), 'ANCHOR PLEDGE');
  
  trackAnalytics('anchor_simulated', { userId: currentUser?.username });
}

function logContract(text) {
  const logElement = document.getElementById('contractLog');
  const timestamp = new Date().toISOString();
  const newLine = `[${timestamp}] ${text}\n`;
  logElement.textContent = newLine + logElement.textContent;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   11. ATTESTATION BUNDLE EXPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Create comprehensive export of all user data with cryptographic verification
   USAGE: Called when user wants complete data export
   EXPECTED OUTCOME: JSON file with all data, hashes, and metadata
*/

async function bundleAttestation() {
  const pledges = await getAll('pledges');
  const badges = await getAll('badges');
  const nodes = await getAll('nodes');
  const analytics = await getAll('analytics');
  
  const userPledges = currentUser 
    ? pledges.filter(p => p.userId === currentUser.username)
    : pledges;
  
  const userBadges = currentUser
    ? badges.filter(b => b.userId === currentUser.username)
    : badges;
  
  const payload = {
    version: 2,
    exportedAt: new Date().toISOString(),
    exportedBy: currentUser?.username || 'anonymous',
    user: currentUser ? {
      username: currentUser.username,
      xp: currentUser.xp,
      level: currentUser.level,
      createdAt: currentUser.createdAt
    } : null,
    pledges: userPledges,
    badges: userBadges,
    nodes: nodes,
    stats: {
      totalPledges: userPledges.length,
      totalBadges: userBadges.length,
      totalXP: currentUser?.xp || 0
    }
  };
  
  const bundle = await withHashes(payload);
  
  saveFile(
    JSON.stringify(bundle, null, 2),
    `pra-madagascar-attestation-${Date.now()}.json`,
    'application/json'
  );
  
  toast('Attestation bundle created and downloaded');
  trackAnalytics('export_attestation', { userId: currentUser?.username });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   12. INTRASITE NETWORK MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Build network of connected restoration nodes
   USAGE: Add links to other nodes for decentralized coordination
   EXPECTED OUTCOME: Discoverable network of restoration projects
*/

async function addNode() {
  const label = document.getElementById('nodeLabel').value?.trim();
  const url = document.getElementById('nodeURL').value?.trim();
  
  if (!label || !url) {
    toast('Please provide both label and URL');
    return;
  }
  
  if (label.length < 2 || label.length > 100) {
    toast('Label must be between 2 and 100 characters');
    return;
  }
  
  const id = 'n_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);
  const node = {
    id,
    label: escapeHtml(label),
    url: escapeHtml(url),
    addedBy: currentUser?.username || 'anonymous',
    ts: new Date().toISOString()
  };
  
  await saveLocal('nodes', node);
  
  document.getElementById('nodeLabel').value = '';
  document.getElementById('nodeURL').value = '';
  
  await loadNodes();
  toast('Node added to local registry');
  
  trackAnalytics('node_added', { label });
}

async function loadNodes() {
  const nodes = await getAll('nodes');
  const container = document.getElementById('nodeList');
  
  if (nodes.length === 0) {
    container.innerHTML = '<div class="small muted">No nodes registered yet. Add sibling nodes above.</div>';
    return;
  }
  
  container.innerHTML = '<h3 class="small">Registered Nodes:</h3><ul>' + 
    nodes.map(node => `
      <li style="margin:8px 0">
        <a href="${escapeHtml(node.url)}" target="_blank" rel="noopener">
          ${escapeHtml(node.label)}
        </a>
        <span class="small muted"> â€” Added ${new Date(node.ts).toLocaleDateString()}</span>
      </li>
    `).join('') + '</ul>';
}

async function exportNodes() {
  const nodes = await getAll('nodes');
  
  if (nodes.length === 0) {
    toast('No nodes to export');
    return;
  }
  
  const bundle = await withHashes({
    type: 'nodes',
    items: nodes,
    exportedBy: currentUser?.username || 'anonymous',
    exportedAt: new Date().toISOString()
  });
  
  saveFile(
    JSON.stringify(bundle, null, 2),
    `pra-madagascar-nodes-${Date.now()}.json`,
    'application/json'
  );
  
  trackAnalytics('export_nodes', { count: nodes.length });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   13. COMMUNITY CHAT INTEGRATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Enable real-time community coordination
   USAGE: Toggle chat iframe on demand to minimize bandwidth
   EXPECTED OUTCOME: Lightweight, optional chat feature
*/

function toggleTlk() {
  const frame = document.getElementById('tlkFrame');
  const button = document.getElementById('toggleTlk');
  
  if (frame.style.display === 'none' || frame.style.display === '') {
    frame.src = 'https://tlk.io/pra-madagascar';
    frame.style.display = 'block';
    button.textContent = 'âŒ Close Chat';
    trackAnalytics('chat_opened');
  } else {
    frame.src = '';
    frame.style.display = 'none';
    button.textContent = 'ğŸ—¨ï¸ Open Chat';
    trackAnalytics('chat_closed');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   14. EXPORT FUNCTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Allow users to save and share their data in multiple formats
   USAGE: Export as HTML, PDF, or JSON
   EXPECTED OUTCOME: Portable, archival-quality data exports
*/

function exportHTML() {
  const html = document.documentElement.outerHTML;
  saveFile(html, `pra-madagascar-${Date.now()}.html`, 'text/html');
  toast('HTML file saved');
  trackAnalytics('export_html');
}

function exportManifest() {
  const manifest = {
    title: 'PRA Madagascar Node',
    timestamp: new Date().toISOString(),
    version: '3.0',
    projects: [
      'Myco-Corridor Pilot â€” Tamatave',
      'Mangrove Microfund â€” Mahajamba',
      'Seed Vault & Provenance'
    ],
    pillars: ['Marine', 'Mycelium', 'Seed'],
    user: currentUser ? {
      username: currentUser.username,
      xp: currentUser.xp,
      level: currentUser.level
    } : null
  };
  
  saveFile(
    JSON.stringify(manifest, null, 2),
    `pra-madagascar-manifest-${Date.now()}.json`,
    'application/json'
  );
  
  trackAnalytics('export_manifest');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   15. HELPER FUNCTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Utility functions used throughout the application
   USAGE: Called by other functions for common operations
   EXPECTED OUTCOME: Consistent, secure data handling
*/

function toast(message) {
  console.log('[PRA Toast]', message);
  
  // Create toast element
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #000;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(20px)';
    toast.style.transition = 'all 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  };
  return String(text).replace(/[&<>"']/g, char => map[char]);
}

function saveFile(data, filename, type) {
  const blob = new Blob([data], { type });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
}

async function sha256Hex(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return '0x' + Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

async function withHashes(obj) {
  const json = JSON.stringify(obj);
  const hash = await sha256Hex(json);
  
  return {
    hash,
    algorithm: 'SHA-256',
    created: new Date().toISOString(),
    data: obj,
    signature: 'Self-attested',
    provenance: 'PRA Madagascar Node Dashboard v3.0'
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   16. INITIALIZATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURPOSE: Bootstrap the application on page load
   USAGE: Automatically runs when page loads
   EXPECTED OUTCOME: Fully functional, initialized application
*/

(async function init() {
  try {
    // Initialize database
    await openDB();
    console.info('âœ… IndexedDB initialized');
    
    // Restore user session
    await restoreSession();
    console.info('âœ… Session restored');
    
    // Restore theme
    await restoreTheme();
    console.info('âœ… Theme restored');
    
    // Load data
    await loadPledges();
    await loadBadges();
    await loadNodes();
    console.info('âœ… Data loaded');
    
    // Build search index
    buildSearchIndex();
    console.info('âœ… Search index built');
    
    // Generate table of contents
    generateTOC();
    console.info('âœ… Table of contents generated');
    
    // Track page load
    trackAnalytics('page_load', {
      userAgent: navigator.userAgent,
      timestamp: new Date().toISOString()
    });
    
    console.info('âœ… PRA Madagascar Dashboard initialized successfully');
    
    // Show welcome message for first-time users
    const hasVisited = await getPref('hasVisited');
    if (!hasVisited) {
      setTimeout(() => {
        toast('Welcome to PRA Madagascar! Sign up to start making pledges.');
        setPref('hasVisited', true);
      }, 1000);
    }
    
  } catch (error) {
    console.error('âŒ Initialization error:', error);
    toast('Error initializing application. Please refresh the page.');
  }
})();

// Add CSS animation for toast
const style = document.createElement('style');
style.textContent = `
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
`;
document.head.appendChild(style);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   END OF APPLICATION CODE
   
   FUTURE-PROOFING CONSIDERATIONS:
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   1. Modular architecture allows easy feature addition
   2. IndexedDB schema versioning supports data migration
   3. Analytics system can be extended for deeper insights
   4. Theme system accepts new themes without code changes
   5. Authentication can be upgraded to server-sync
   6. Smart contract integration is skeleton-ready for deployment
   7. Export formats support future data standards
   8. Search can be enhanced with fuzzy matching
   9. All functions are documented for maintainability
   10. Zero-harm principles embedded throughout
   
   For questions or contributions, contact:
   steward@planetaryrestorationarchive.com
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Water Sovereignty Quest — Papua New Guinea Highlands Edition</title>
  <meta name="description" content="An ultra long-form, gamified field guide to water sovereignty for the Papua New Guinea Highlands: mapping sources, rainwater harvesting, spring protection, gravity-fed systems, household treatment, outbreak readiness, and community governance. Offline-ready with IndexedDB, Habitica sync, and an in-browser AI coach." />
  <meta name="keywords" content="Papua New Guinea Highlands, water sovereignty, rainwater harvesting, spring protection, gravity-fed water, biosand filter, chlorination, WASH, PNG, food sovereignty, resilience, PNG highlands, sanitation, drought, frost, Enga, Goroka, Eastern Highlands, Sepik, Purari" />
  <link rel="canonical" href="/water/" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />

  <!-- Open Graph -->
  <meta property="og:title" content="Water Sovereignty Quest — Papua New Guinea Highlands Edition" />
  <meta property="og:description" content="A gamified, offline-first guide to village-scale water security in the PNG Highlands." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/water/" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Water Sovereignty Quest — Papua New Guinea Highlands Edition" />
  <meta name="twitter:description" content="Gamified steps, calculators, Habitica sync, offline progress, and an in-browser AI coach." />

  <!-- JSON-LD using your presentation schema -->
  <script type="application/ld+json">
  {
    "@context": "https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid",
    "@type": "Guide",
    "name": "Water Sovereignty Quest — Papua New Guinea Highlands Edition",
    "url": "/water/",
    "inLanguage": "en",
    "audience": {"@type":"Audience","audienceType":"PNG Highlands communities"},
    "about": [
      "Rainwater harvesting", "Spring protection", "Gravity-fed community water",
      "Household water treatment", "WASH", "Outbreak readiness", "Customary water governance"
    ],
    "creator": {"@type":"Organization","name":"Planetary Restoration Archive"},
    "educationalUse": ["Field", "Self-paced", "Community workshop"],
    "learningResourceType": ["HowTo","Checklist","Calculator","Game"],
    "isPartOf": {"@type":"CreativeWorkSeries","name":"Food & Water Sovereignty PNG"},
    "license": "https://creativecommons.org/licenses/by/4.0/"
  }
  </script>

  <style>
    :root {
      --bg: #030611;
      --card: rgba(255,255,255,0.08);
      --ink: #e8eefc;
      --ink-dim: #bcd;
      --accent: #71ffe1;
      --accent2: #9bb8ff;
      --ok: #6ef773;
      --warn: #ffd86b;
      --bad: #ff6f6f;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--ink);
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      overflow-x: hidden;
    }
    /* Photorealistic star field canvas behind everything */
    canvas#starfield { position: fixed; inset: 0; width: 100vw; height: 100vh; display: block; z-index: -2; background: radial-gradient(1200px 800px at 60% 10%, rgba(140,170,255,0.08), transparent 60%) }
    .veil { position: fixed; inset: 0; background: radial-gradient(1200px 800px at 40% 0%, rgba(0,0,0,0.35), transparent 60%); z-index: -1; }

    header {
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(3,6,17,0.85), rgba(3,6,17,0.55));
      z-index: 10; border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    nav a {
      color: var(--ink); text-decoration: none; margin-right: 14px; padding: 8px 12px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    nav a:hover { background: rgba(255,255,255,0.06);}
    .hero {
      display: grid; grid-template-columns: 1.2fr 1fr; gap: 24px; align-items: center; padding: 36px 22px 10px;
    }
    .hero h1 { font-size: clamp(28px, 5vw, 48px); margin: 0 0 8px; line-height: 1.15; }
    .hero p { color: var(--ink-dim); margin: 0; }
    .badgebar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    .badge { background: var(--card); border: 1px solid rgba(255,255,255,0.08); padding: 8px 12px; border-radius: 999px; font-size: 13px; }

    .hud {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 18px;
    }
    .hud .tile { background: var(--card); border: 1px solid rgba(255,255,255,0.08); padding: 14px; border-radius: var(--radius); box-shadow: var(--shadow); }
    .hud .tile h3 { margin: 0 0 6px; font-size: 14px; color: var(--ink-dim); text-transform: uppercase; letter-spacing: 0.06em; }
    .hud .value { font-size: 22px; }

    .card, .callout {
      background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow);
    }
    .callout { border-left: 3px solid var(--accent); }
    section { padding: 24px 22px; }
    section h2 { font-size: 22px; letter-spacing: 0.02em; margin: 0 0 10px; }
    section h3 { font-size: 18px; margin: 22px 0 8px; }
    .grid { display: grid; gap: 16px; }
    .grid.cols2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.cols3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 980px){ .hero{ grid-template-columns: 1fr; } .grid.cols2, .grid.cols3{ grid-template-columns: 1fr; } }

    .checklist li { list-style: none; display: grid; grid-template-columns: 22px 1fr; gap: 10px; padding: 8px 0; align-items: start; }
    .checklist input[type=checkbox] { inline-size: 20px; block-size: 20px; margin-top: 2px; }
    .btn { border: 1px solid rgba(255,255,255,0.12); background: transparent; color: var(--ink); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    .btn:hover{ background: rgba(255,255,255,0.06); }
    .btn.primary{ border-color: var(--accent); }
    .muted{ color: var(--ink-dim); }

    .calc label{ font-size: 13px; color: var(--ink-dim); }
    .calc input, .calc select, .calc textarea {
      width: 100%; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25); color: var(--ink); border-radius: 10px;
    }
    .stack { display: grid; gap: 10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    footer { padding: 40px 22px; color: var(--ink-dim); }
    footer a { color: var(--accent2); text-decoration: none; }
    .tiny { font-size: 12px; color: var(--ink-dim); }

    /* WebLLM UI */
    #coach { display: grid; gap: 8px; }
    #coach-log { height: 260px; overflow: auto; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.25); }
    #coach-log .u { color: var(--accent); }
    #coach-log .a { color: var(--ink); }

    /* Subtle focus outline for a11y */
    :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 6px; }
  </style>
</head>
<body>
  <canvas id="starfield" aria-hidden="true"></canvas>
  <div class="veil" aria-hidden="true"></div>

  <header>
    <div class="wrap">
      <nav aria-label="Primary">
        <a href="/">Home</a>
        <a href="/water/" aria-current="page">Water Sovereignty</a>
        <a href="/food/">Food Sovereignty</a>
        <a href="#quests">Quests</a>
        <a href="#calculators">Calculators</a>
        <a href="#habitica">Habitica</a>
        <a href="#coach">AI Coach</a>
      </nav>
    </div>
  </header>

  <div class="wrap hero">
    <div>
      <h1>Water Sovereignty Quest<br><span class="muted">Papua New Guinea Highlands Edition</span></h1>
      <p>Everything you need to map, build, treat, and govern village-scale water systems in the Highlands — as a cooperative game. Offline-ready. Respectful of customary land and water custodianship. Built for hands, heads, and kin.</p>
      <div class="badgebar">
        <span class="badge">Offline progress (IndexedDB)</span>
        <span class="badge">Sync tasks to Habitica</span>
        <span class="badge">In-browser AI Coach (WebLLM)</span>
        <span class="badge">PNG Highlands field notes</span>
      </div>

      <div class="hud" role="status" aria-live="polite">
        <div class="tile"><h3>Village XP</h3><div class="value mono" id="xp">0</div></div>
        <div class="tile"><h3>Water Score</h3><div class="value mono" id="wscore">0%</div></div>
        <div class="tile"><h3>Sources Secured</h3><div class="value mono" id="sources">0</div></div>
        <div class="tile"><h3>Last Saved</h3><div class="value mono" id="saved">—</div></div>
      </div>
    </div>
    <div class="card">
      <h2>PNG Highlands Quick Facts</h2>
      <ul class="tiny" style="margin:0; padding-left: 18px;">
        <li>Mountain ranges + abundant rainfall → high runoff; major river basins include Sepik, Fly, Purari, Markham. <em>[context for gravity-fed designs]</em></li>
        <li>Annual rainfall commonly &gt;2,000 mm; some mountain slopes exceed 8,000 mm. <em>[context for rainwater harvesting sizing]</em></li>
        <li>Rural potable sources are typically rain tanks, springs, shallow wells, creeks/rivers. <em>[context for spring protection & treatment]</em></li>
        <li>Historic cholera (2009–2011) and endemic typhoid in Highlands underscore the need for reliable household treatment and residual disinfection.</li>
        <li>Most land is held under customary tenure; water decisions should be clan-led and rights-respecting.</li>
      </ul>
      <p class="tiny">Full evidence & references in Appendix A.</p>
    </div>
  </div>

  <!-- QUESTS -->
  <section id="quests" class="wrap">
    <h2>Quest Log</h2>
    <div class="grid cols2">
      <div class="card">
        <h3>Quest 01 — Map Your Waters (1–2 days)</h3>
        <p class="muted">Sources + risks + ownership. Walk the watershed with elders and youth; mark springs, seeps, creeks, tanks, and pipes. Note dry‑season behavior.</p>
        <ul class="checklist" id="q01">
          <li><input type="checkbox" data-xp="20"><label>Sketch watershed map (paper or phone), highlight slopes & potential catchments</label></li>
          <li><input type="checkbox" data-xp="10"><label>List sources: <em>spring, stream reach, roof area(s), existing tanks</em></label></li>
          <li><input type="checkbox" data-xp="10"><label>Interview knowledge holders about seasonal flow &lt;—&gt; drought/frost years (1997, 2015)</label></li>
          <li><input type="checkbox" data-xp="10"><label>Mark ownership & customary responsibilities; confirm consent for any works</label></li>
          <li><input type="checkbox" data-xp="10"><label>Note contamination risks: toilets uphill, animals, landslip zones, mining runoff</label></li>
        </ul>
        <button class="btn primary" data-save="q01">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 02 — Rain That Roof (2–5 days)</h3>
        <p class="muted">Design a rainwater harvesting system sized for the dry months. Metal roofs perform best (runoff coefficient ~0.85–0.95). First‑flush is mandatory.</p>
        <ul class="checklist" id="q02">
          <li><input type="checkbox" data-xp="10"><label>Measure roof area(s) (length × width); log per building</label></li>
          <li><input type="checkbox" data-xp="10"><label>Choose tank volume to bridge the driest 4–8 weeks</label></li>
          <li><input type="checkbox" data-xp="10"><label>Install screened gutters, leaf guards, and a first‑flush diverter (≥0.5–1 mm rainfall)</label></li>
          <li><input type="checkbox" data-xp="10"><label>Fit mosquito‑proof vents; raise tank on stable base; add level gauge</label></li>
          <li><input type="checkbox" data-xp="10"><label>Plan disinfection (boil, chlorinate, or filter + disinfect)</label></li>
        </ul>
        <button class="btn primary" data-save="q02">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 03 — Protect the Spring (2–7 days)</h3>
        <p class="muted">If you have a hillside spring: seal the eye, install a collection box, fence out animals, and convey by gravity. Keep upstream area permanent vegetation.</p>
        <ul class="checklist" id="q03">
          <li><input type="checkbox" data-xp="15"><label>Stake a 30–50 m sanitary protection zone uphill; no toilets or animal pens</label></li>
          <li><input type="checkbox" data-xp="10"><label>Build spring box (sealed floor/walls), screened overflow, sampling tap</label></li>
          <li><input type="checkbox" data-xp="10"><label>Install drain to carry away spillage; graveled apron to prevent mud</label></li>
          <li><input type="checkbox" data-xp="10"><label>Pipe to communal tapstand(s) with drainage & soakaway</label></li>
          <li><input type="checkbox" data-xp="10"><label>Keep a logbook of turbidity & flow at end of wet vs. dry seasons</label></li>
        </ul>
        <button class="btn primary" data-save="q03">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 4 — Gravity‑Fed System (GFS) (7–30+ days)</h3>
        <p class="muted">When head (height) is available, gravity wins. Survey the line, size pipes for demand + loss, add break‑pressure tanks on steep drops.</p>
        <ul class="checklist" id="q04">
          <li><input type="checkbox" data-xp="15"><label>Survey source elevation vs. highest tap; confirm &gt;10 m head if possible</label></li>
          <li><input type="checkbox" data-xp="15"><label>Choose HDPE/PE pipes; size to keep velocities 0.3–1.0 m/s</label></li>
          <li><input type="checkbox" data-xp="10"><label>Place break‑pressure tanks as needed; provide scour valves</label></li>
          <li><input type="checkbox" data-xp="10"><label>Protect river crossings; bury pipes below cultivation depth</label></li>
          <li><input type="checkbox" data-xp="10"><label>Prepare O&amp;M rota; spare washers, clamps, chlorine test kit</label></li>
        </ul>
        <button class="btn primary" data-save="q04">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 5 — Household Treatment (Continuous)</h3>
        <p class="muted">Make safe at the point of use. Options: boil, chlorinate, or filter → disinfect. Maintain a measurable chlorine residual when chlorinating.</p>
        <ul class="checklist" id="q05">
          <li><input type="checkbox" data-xp="10"><label>Train households on boil (rolling boil ≥1 minute; cool in covered vessel)</label></li>
          <li><input type="checkbox" data-xp="10"><label>Set up chlorine dosing (see calculator for 0.2–0.5 mg/L residual at point of collection)</label></li>
          <li><input type="checkbox" data-xp="10"><label>Build biosand filters (per CAWST specs) for turbidity + pathogen reduction</label></li>
          <li><input type="checkbox" data-xp="10"><label>Teach SODIS (solar disinfection) for clear water in PET bottles</label></li>
          <li><input type="checkbox" data-xp="10"><label>Adopt safe storage: narrow‑neck jerrycans, labeled “Drinking Water”</label></li>
        </ul>
        <button class="btn primary" data-save="q05">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 6 — Sanitation & Hygiene (Continuous)</h3>
        <p class="muted">Water wins only with sanitation: no feces in fields/streams, hand‑washing with soap, and gender‑safe facilities.</p>
        <ul class="checklist" id="q06">
          <li><input type="checkbox" data-xp="10"><label>Map toilets vs. water sources; relocate risky pits downhill/distant</label></li>
          <li><input type="checkbox" data-xp="10"><label>Hand‑washing stations at homes, schools, markets</label></li>
          <li><input type="checkbox" data-xp="10"><label>Menstrual hygiene supplies & privacy; community maintenance rota</label></li>
          <li><input type="checkbox" data-xp="10"><label>Diarrhea response: ORS + zinc; fast clinic referral for severe cases</label></li>
          <li><input type="checkbox" data-xp="10"><label>Cholera/typhoid refresher: symptoms, isolation, chlorination upscaling</label></li>
        </ul>
        <button class="btn primary" data-save="q06">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 7 — Drought, Frost & Landslip Readiness</h3>
        <p class="muted">El Niño droughts and high‑altitude frosts have hit the Highlands (e.g., 1997 &amp; 2015). Prepare buffers and quick‑switch water plans.</p>
        <ul class="checklist" id="q07">
          <li><input type="checkbox" data-xp="10"><label>Set tank reserve target (e.g., ≥30 days household minimum)</label></li>
          <li><input type="checkbox" data-xp="10"><label>Stage extra hoses/fittings to reroute flows if slip or flood destroys a line</label></li>
          <li><input type="checkbox" data-xp="10"><label>Shade tanks; mulch soils; plant riparian strips for bank stability</label></li>
          <li><input type="checkbox" data-xp="10"><label>Agree a drought priority plan: drinking first, then cooking, then hygiene</label></li>
          <li><input type="checkbox" data-xp="10"><label>Keep emergency chlorine and ORS kits in communal store</label></li>
        </ul>
        <button class="btn primary" data-save="q07">Save Progress</button>
      </div>

      <div class="card">
        <h3>Quest 8 — Governance & Agreements</h3>
        <p class="muted">Honor customary stewardship. Use clear village agreements: access rules, maintenance, water safety plan, and conflict resolution.</p>
        <ul class="checklist" id="q08">
          <li><input type="checkbox" data-xp="10"><label>Document consent from landholding clans for any works on customary land</label></li>
          <li><input type="checkbox" data-xp="10"><label>Post a simple Water Safety Plan at the main tapstand</label></li>
          <li><input type="checkbox" data-xp="10"><label>Assign water wardens (rota) for testing, cleaning, and reporting</label></li>
          <li><input type="checkbox" data-xp="10"><label>Establish a transparent repair fund (cash or crop‑based contributions)</label></li>
          <li><input type="checkbox" data-xp="10"><label>Annual “walk the line” day + community audit</label></li>
        </ul>
        <button class="btn primary" data-save="q08">Save Progress</button>
      </div>
    </div>
  </section>

  <!-- CALCULATORS -->
  <section id="calculators" class="wrap">
    <h2>Calculators & Tools</h2>
    <div class="grid cols3">
      <div class="card calc">
        <h3>Rainwater Harvesting Sizer</h3>
        <div class="stack">
          <label>Roof Area (m²) <input id="rw-area" type="number" min="0" step="0.1" value="80"></label>
          <label>Monthly Rainfall (mm) <input id="rw-mm" type="number" min="0" step="1" value="250"></label>
          <label>Runoff Coefficient (0.85 metal / 0.75 tile / 0.6 thatch)
            <input id="rw-k" type="number" min="0" max="1" step="0.01" value="0.9">
          </label>
          <label>Days to Bridge (dry spell) <input id="rw-days" type="number" min="1" max="120" step="1" value="45"></label>
          <button class="btn primary" id="rw-go">Compute</button>
          <div id="rw-out" class="mono tiny"></div>
        </div>
        <p class="tiny muted">Formula: liters/month ≈ <code>mm × m² × coefficient</code>. Buffer = daily need × days. Consider ~15–25 L/person/day (drinking, cooking, minimal hygiene).</p>
      </div>

      <div class="card calc">
        <h3>Chlorine Dose Helper</h3>
        <div class="stack">
          <label>Volume to treat (L) <input id="cl-vol" type="number" min="1" step="1" value="100"></label>
          <label>Target residual at collection (mg/L) <input id="cl-mg" type="number" step="0.1" value="0.5"></label>
          <label>Bleach strength (% NaOCl, e.g., 5%) <input id="cl-pct" type="number" step="0.1" value="5"></label>
          <button class="btn primary" id="cl-go">Compute</button>
          <div id="cl-out" class="mono tiny"></div>
        </div>
        <p class="tiny muted">Aim for ≥0.5 mg/L free chlorine after 30 min contact at pH &lt; 8, and maintain 0.2–0.5 mg/L at point of collection. Always verify with a DPD test kit.</p>
      </div>

      <div class="card calc">
        <h3>Gravity Head & Flow Sketch</h3>
        <div class="stack">
          <label>Elevation at source (m) <input id="gfs-src" type="number" step="1" value="1920"></label>
          <label>Elevation at tap (m) <input id="gfs-tap" type="number" step="1" value="1860"></label>
          <label>Estimated length (m) <input id="gfs-len" type="number" step="1" value="1800"></label>
          <button class="btn" id="gfs-go">Estimate Head</button>
          <div id="gfs-out" class="mono tiny"></div>
        </div>
        <p class="tiny muted">This quick check ensures usable head (Δh). Detailed design should check friction losses & add break‑pressure tanks as needed.</p>
      </div>
    </div>

    <div class="callout" style="margin-top: 14px;">
      <strong>Field build notes:</strong> For biosand filters, use graded media (effective size ~0.15–0.35 mm, uniformity coefficient &lt; 3), flow ~0.4 L/min; after ripening, apply a final disinfectant (boil or chlorine). Keep media clean and vessel covered.
    </div>
  </section>

  <!-- HABITICA SYNC -->
  <section id="habitica" class="wrap">
    <h2>Habitica: Turn Quests into XP & Gold</h2>
    <div class="grid cols2">
      <div class="card">
        <p>Enter your Habitica credentials locally. They stay in your browser (IndexedDB). Then push the quest checklists as Habitica <em>To‑Dos</em> or <em>Dailies</em>.</p>
        <div class="stack">
          <label>User ID (UUID) <input id="h-user" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></label>
          <label>API Token <input id="h-key" placeholder="keep secret"></label>
          <label>Task Type
            <select id="h-type">
              <option value="todo">To‑Dos</option>
              <option value="daily">Dailies</option>
            </select>
          </label>
          <button class="btn primary" id="h-save">Store Keys</button>
          <button class="btn" id="h-push">Push Quests to Habitica</button>
          <div class="tiny mono" id="h-msg"></div>
        </div>
        <p class="tiny muted">Find your keys at Habitica → Settings → API. Calls go to <code>https://habitica.com/api/v3/</code>. If CORS or rate‑limits block requests, try again later or from a different network.</p>
      </div>
      <div class="card">
        <h3>What gets created</h3>
        <ul class="tiny">
          <li>One parent task per Quest (e.g., “Quest 02 — Rain That Roof”).</li>
          <li>Checklist items mirror the steps above.</li>
          <li>Metadata: tag = <code>Water Sovereignty PNG</code>, notes = source URL (/water/), and safety reminders for chlorine/contact time.</li>
        </ul>
        <p class="tiny muted">Remove or edit tasks anytime in Habitica. Credentials are deletable via “Reset All” at the bottom of this page.</p>
      </div>
    </div>
  </section>

  <!-- WEBLLM COACH -->
  <section id="coach" class="wrap">
    <h2>In‑Browser AI Coach (WebLLM)</h2>
    <div class="grid cols2">
      <div class="card">
        <p class="muted">Runs locally in your browser using WebGPU. First load downloads a small model. If your device lacks WebGPU, this panel will explain alternatives.</p>
        <div id="coach-log" aria-live="polite"></div>
        <div class="stack">
          <textarea id="coach-prompt" rows="3" placeholder="Ask about spring protection, chlorine residuals, biosand media, or gravity-fed head losses…"></textarea>
          <div style="display:flex; gap:8px;">
            <button class="btn primary" id="coach-init">Start Coach</button>
            <button class="btn" id="coach-send">Send</button>
          </div>
          <div class="tiny mono" id="coach-status">Status: idle</div>
        </div>
      </div>
      <div class="card">
        <h3>Safety & Scope</h3>
        <p class="tiny muted">Coach is grounded to this page’s content and standard WASH references. It can help with sizing and procedures but cannot replace water testing or professional engineering when risks are high (landslips, contamination, high headworks, dams).</p>
        <p class="tiny muted">Tip: keep prompts specific. Example: “We have 80 m² of roof, 250 mm/month in the dry spell, 7 people. How big should the tank be?”</p>
      </div>
    </div>
  </section>

  <!-- APPENDIX A -->
  <section id="appendix-a" class="wrap">
    <h2>Appendix A — Field Specs & Quick References</h2>

    <div class="grid cols2">
      <div class="card">
        <h3>Chlorination quick targets</h3>
        <ul class="tiny">
          <li>Contact time: ≥30 minutes at pH &lt; 8 before first consumption.</li>
          <li>Free residual at collection: 0.2–0.5 mg/L (increase to 1.0–2.0 mg/L at standpipes during outbreaks; still keep 0.2–0.5 mg/L at point‑of‑use).</li>
          <li>Taste/odor often noticeable &gt;0.5 mg/L; communicate why residual matters.</li>
        </ul>
      </div>

      <div class="card">
        <h3>Biosand notes</h3>
        <ul class="tiny">
          <li>Media gradation: effective size ~0.15–0.35 mm; UC &lt; 3; cleaned, low fines.</li>
          <li>Ripening period: expect improved pathogen removal after ~2–4 weeks.</li>
          <li>Use as a pre‑treatment; finish with disinfection (boil/chlorine).</li>
        </ul>
      </div>

      <div class="card">
        <h3>PNG Highlands risk cues</h3>
        <ul class="tiny">
          <li>El Niño droughts can coincide with high‑altitude frosts; schedule tank reserves accordingly.</li>
          <li>Landslips can sever lines; bury critical spans and prepare bypass kits.</li>
          <li>Maintain spring catchments under permanent vegetation; fence livestock out.</li>
        </ul>
      </div>

      <div class="card">
        <h3>Governance & consent</h3>
        <ul class="tiny">
          <li>Most land in PNG is customary — secure clan consent and document agreements.</li>
          <li>Water Safety Plan: roles, tests, incident steps, contact numbers, spares list.</li>
          <li>Set an annual “walk‑the‑line” & audit day; publish a one‑page maintenance rota.</li>
        </ul>
      </div>
    </div>

    <p class="tiny muted">Cultural note: use local names for places, months/rains, and water bodies in all signage and logs; respect customary knowledge and leadership in siting and decisions.</p>
  </section>

  <footer class="wrap">
    <div style="display:flex; gap:14px; flex-wrap:wrap;">
      <a href="/water/">/water/</a>
      <a href="/food/">/food/</a>
      <a href="#quests">Quests</a>
      <a href="#calculators">Calculators</a>
      <a href="#habitica">Habitica</a>
      <a href="#coach">AI Coach</a>
    </div>
    <p class="tiny">Built to be extended. Append new sections below or split into additional HTML files and link here.</p>
    <button class="btn" id="reset-all">Reset All (local)</button>
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <!-- WebLLM (loaded on demand by button) -->
  <script>
    // Photorealistic(ish) star field
    (function(){
      const c = document.getElementById('starfield');
      const ctx = c.getContext('2d');
      let w, h, dpr, stars=[];
      function resize(){
        dpr = Math.max(1, Math.min(window.devicePixelRatio||1, 2));
        w = c.width = Math.floor(innerWidth * dpr);
        h = c.height = Math.floor(innerHeight * dpr);
        c.style.width = innerWidth+'px'; c.style.height = innerHeight+'px';
      }
      function rand(a,b){ return a + Math.random()*(b-a); }
      function init(){
        stars.length = 0;
        const count = Math.floor((innerWidth*innerHeight)/2200); // density
        for(let i=0;i<count;i++){
          stars.push({
            x: rand(0, w), y: rand(0, h),
            z: rand(0.2, 1.0), // depth
            r: rand(0.4, 1.6), // radius base
            tw: rand(0.002, 0.01), // twinkle speed
            ph: rand(0, Math.PI*2), // phase
            tint: rand(0,1) < 0.7 ? 'white' : (Math.random()<0.5 ? '#9bb8ff' : '#ffd9a8')
          });
        }
      }
      function draw(){
        ctx.clearRect(0,0,w,h);
        for(const s of stars){
          s.ph += s.tw;
          const pulse = 0.6 + Math.sin(s.ph)*0.4;
          const parallax = (s.z-0.5)*0.2;
          s.x += parallax; if(s.x<0) s.x+=w; if(s.x>w) s.x-=w;
          const r = (s.r*pulse) * dpr;
          const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, r*2.2);
          g.addColorStop(0, 'rgba(255,255,255,0.9)');
          g.addColorStop(0.4, s.tint==='white'?'rgba(255,255,255,0.55)':(s.tint==='#9bb8ff'?'rgba(155,184,255,0.55)':'rgba(255,217,168,0.55)'));
          g.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = g;
          ctx.beginPath(); ctx.arc(s.x, s.y, r*2.2, 0, Math.PI*2); ctx.fill();
        }
        requestAnimationFrame(draw);
      }
      window.addEventListener('resize', ()=>{ resize(); init(); });
      resize(); init(); draw();
    })();

    // IndexedDB minimal wrapper
    const DB = {
      _db: null,
      async open(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open('pra-sovereignty', 1);
          req.onupgradeneeded = (e)=>{
            const db = e.target.result;
            if(!db.objectStoreNames.contains('progress')) db.createObjectStore('progress');
            if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
          };
          req.onsuccess = ()=>{ DB._db = req.result; resolve(DB._db); };
          req.onerror = ()=>reject(req.error);
        });
      },
      async set(store, key, val){
        await DB.open();
        return new Promise((resolve, reject)=>{
          const tx = DB._db.transaction(store, 'readwrite');
          tx.objectStore(store).put(val, key);
          tx.oncomplete = resolve; tx.onerror = ()=>reject(tx.error);
        });
      },
      async get(store, key){
        await DB.open();
        return new Promise((resolve, reject)=>{
          const tx = DB._db.transaction(store, 'readonly');
          const req = tx.objectStore(store).get(key);
          req.onsuccess = ()=>resolve(req.result);
          req.onerror = ()=>reject(req.error);
        });
      },
      async all(store){
        await DB.open();
        return new Promise((resolve, reject)=>{
          const tx = DB._db.transaction(store, 'readonly');
          const req = tx.objectStore(store).getAll();
          req.onsuccess = ()=>resolve(req.result);
          req.onerror = ()=>reject(req.error);
        });
      },
      async clearAll(){
        await DB.open();
        return new Promise((resolve, reject)=>{
          const tx = DB._db.transaction(['progress','kv'],'readwrite');
          tx.objectStore('progress').clear(); tx.objectStore('kv').clear();
          tx.oncomplete = resolve; tx.onerror = ()=>reject(tx.error);
        });
      }
    };

    // Quest save/restore
    const quests = ['q01','q02','q03','q04','q05','q06','q07','q08'];
    const xpEl = document.getElementById('xp');
    const wscoreEl = document.getElementById('wscore');
    const sourcesEl = document.getElementById('sources');
    const savedEl = document.getElementById('saved');

    async function loadProgress(){
      let xp = await DB.get('kv','xp') || 0;
      xpEl.textContent = xp;
      let doneCount = 0, total = 0;
      for(const q of quests){
        const saved = (await DB.get('progress', q)) || [];
        const list = document.getElementById(q);
        if(list){
          const boxes = [...list.querySelectorAll('input[type=checkbox]')];
          boxes.forEach((box, i)=>{ box.checked = !!saved[i]; });
          doneCount += boxes.filter(b=>b.checked).length;
          total += boxes.length;
        }
      }
      wscoreEl.textContent = total? Math.round((doneCount/total)*100)+'%' : '0%';
      sourcesEl.textContent = (await DB.get('kv','sources')) || 0;
      const savedAt = await DB.get('kv','savedAt');
      savedEl.textContent = savedAt ? new Date(savedAt).toLocaleString() : '—';
    }

    function bumpXP(delta){
      const val = Math.max(0, (parseInt(xpEl.textContent,10)||0) + delta);
      xpEl.textContent = val;
      DB.set('kv','xp', val);
    }

    document.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-save]');
      if(!b) return;
      const id = b.getAttribute('data-save');
      const ul = document.getElementById(id);
      const boxes = [...ul.querySelectorAll('input[type=checkbox]')];
      const state = boxes.map(b=>b.checked);
      await DB.set('progress', id, state);
      await DB.set('kv','savedAt', Date.now());
      savedEl.textContent = new Date().toLocaleString();

      // award XP for newly checked items
      let xpAdd = 0; boxes.forEach(box=>{ if(box.checked && !box._counted){ xpAdd += parseInt(box.dataset.xp||'0',10); box._counted = true; }});
      if(xpAdd>0) bumpXP(xpAdd);

      // recompute score
      const total = quests.map(q=>document.getElementById(q))
        .flatMap(ul=>[...ul.querySelectorAll('input[type=checkbox]')]);
      const done = total.filter(b=>b.checked).length;
      wscoreEl.textContent = total.length? Math.round((done/total.length)*100)+'%' : '0%';
    });

    // Calculators
    function litersForRain(mm, m2, k){ return mm * m2 * k; } // per month
    document.getElementById('rw-go').addEventListener('click', ()=>{
      const area = +document.getElementById('rw-area').value;
      const mm = +document.getElementById('rw-mm').value;
      const k = +document.getElementById('rw-k').value;
      const days = +document.getElementById('rw-days').value;
      const monthly = litersForRain(mm, area, k);
      const daily = monthly / 30;
      const perPerson = 20; // minimal L/p/d for drinking/cooking/hygiene baseline
      const hh = 7; // sample household
      const needed = perPerson*hh;
      const buffer = needed*days;
      const tankSuggest = Math.ceil(buffer/50)*50; // round to nearest 50 L
      document.getElementById('rw-out').textContent =
        `Est. yield ≈ ${Math.round(monthly).toLocaleString()} L/month (~${Math.round(daily)} L/day). `+
        `Dry‑spell buffer target ≈ ${buffer} L (for ${hh} persons × ${perPerson} L/p/d × ${days} days). `+
        `Suggested tank ≥ ~${tankSuggest.toLocaleString()} L.`;
    });

    document.getElementById('cl-go').addEventListener('click', ()=>{
      const V = +document.getElementById('cl-vol').value;     // L
      const target = +document.getElementById('cl-mg').value; // mg/L
      const pct = +document.getElementById('cl-pct').value;   // %
      const stock_mg_per_L = pct * 10000; // 5% ≈ 50,000 mg/L
      const mL = (target * V) / (stock_mg_per_L/1000); // mg / (mg/mL)
      document.getElementById('cl-out').textContent =
        `Add ≈ ${mL.toFixed(1)} mL of ${pct}% bleach to ${V} L, mix, wait ≥30 min, verify 0.2–0.5 mg/L FRC with DPD kit.`;
    });

    document.getElementById('gfs-go').addEventListener('click', ()=>{
      const z1 = +document.getElementById('gfs-src').value;
      const z2 = +document.getElementById('gfs-tap').value;
      const L = +document.getElementById('gfs-len').value;
      const head = z1 - z2;
      let msg = `Available static head ≈ ${head} m over ${L} m route. `;
      msg += head<10 ? 'Head is modest; minimize losses & consider closer tapstands.' : 'Good head for gravity delivery; add break‑pressure tanks on steep drops.';
      document.getElementById('gfs-out').textContent = msg;
    });

    // Habitica integration
    async function hGet(k){ return await DB.get('kv', k); }
    async function hSet(k,v){ return await DB.set('kv', k, v); }
    const hUser = document.getElementById('h-user'), hKey = document.getElementById('h-key'), hType = document.getElementById('h-type'), hMsg = document.getElementById('h-msg');
    (async ()=>{
      hUser.value = await hGet('habitica-user') || '';
      hKey.value = await hGet('habitica-key') || '';
      hType.value = await hGet('habitica-type') || 'todo';
    })();
    document.getElementById('h-save').addEventListener('click', async ()=>{
      await hSet('habitica-user', hUser.value.trim());
      await hSet('habitica-key', hKey.value.trim());
      await hSet('habitica-type', hType.value);
      hMsg.textContent = 'Keys stored locally.';
    });
    function collectQuestPayloads(){
      const all = [];
      for(const q of quests){
        const ul = document.getElementById(q);
        const title = ul.parentElement.querySelector('h3').textContent.trim();
        const notes = (ul.parentElement.querySelector('p')?.textContent||'').trim() + '\n\nSource: /water/';
        const checks = [...ul.querySelectorAll('label')].map(l=>({text:l.textContent.trim(), completed:false}));
        all.push({title, notes, checklist:checks});
      }
      return all;
    }
    async function pushToHabitica(){
      hMsg.textContent = 'Pushing…';
      const uid = hUser.value.trim(), key = hKey.value.trim(), ttype = hType.value;
      if(!uid || !key){ hMsg.textContent='Missing User ID or API Token.'; return; }
      const tasks = collectQuestPayloads().map(t=>({
        text: t.title,
        type: ttype,
        notes: t.notes,
        tags: [], // you can add tag IDs if you fetch them first
        checklist: t.checklist
      }));
      try{
        for(const task of tasks){
          const res = await fetch('https://habitica.com/api/v3/tasks/user', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'x-api-user': uid,
              'x-api-key': key,
              'x-client': 'pra-water-guide'
            },
            body: JSON.stringify(task)
          });
          if(!res.ok){
            const t = await res.text();
            throw new Error('Habitica error: '+res.status+' '+t);
          }
        }
        hMsg.textContent = `Created ${tasks.length} tasks in Habitica.`;
      }catch(err){
        hMsg.textContent = (''+err).slice(0,300);
      }
    }
    document.getElementById('h-push').addEventListener('click', pushToHabitica);

    // WebLLM Coach
    let coachEngine = null;
    async function ensureWebLLM(){
      if(!('gpu' in navigator)){ document.getElementById('coach-status').textContent = 'Status: WebGPU not available. Use a desktop Chromium-based browser or install WebGPU preview.'; return null; }
      if(coachEngine) return coachEngine;
      document.getElementById('coach-status').textContent = 'Status: loading model… (first load may take time; cached afterward)';
      // dynamically import from CDN
      const mod = await import('https://unpkg.com/@mlc-ai/web-llm/dist/webllm.min.js');
      const model = "Llama-3-8B-Instruct-q4f32_1-MLC";
      coachEngine = await mod.CreateMLCEngine(model, {logLevel: "INFO"});
      document.getElementById('coach-status').textContent = 'Status: ready';
      return coachEngine;
    }
    const coachLog = document.getElementById('coach-log');
    function addMsg(kind, text){
      const div = document.createElement('div'); div.className = kind==='user'?'u':'a';
      div.textContent = (kind==='user'?'You: ':'Coach: ')+text;
      coachLog.appendChild(div); coachLog.scrollTop = coachLog.scrollHeight;
    }
    document.getElementById('coach-init').addEventListener('click', ensureWebLLM);
    document.getElementById('coach-send').addEventListener('click', async ()=>{
      const q = document.getElementById('coach-prompt').value.trim();
      if(!q) return;
      addMsg('user', q);
      const engine = await ensureWebLLM(); if(!engine) return;
      const sys = `You are a Water Sovereignty Coach for PNG Highlands. Use this context:
- Rainfall often >2000 mm/yr; mountain slopes can exceed 8000 mm.
- Rural sources: rain tanks, springs, shallow wells, creeks/rivers.
- Chlorination targets: ≥0.5 mg/L after 30 min contact at pH<8; 0.2–0.5 mg/L at collection.
- Biosand filters require graded media (ES 0.15–0.35 mm, UC<3) and post-disinfection.
- Customary land tenure dominates; consent and water safety plans are essential. Keep answers concise, stepwise, and field-practical.`;
      const reply = await coachEngine.chat.completions.create({
        messages: [
          {role:'system', content: sys},
          {role:'user', content: q}
        ],
        temperature: 0.4,
        stream: false
      });
      addMsg('assistant', reply.choices?.[0]?.message?.content || '(no reply)');
    });

    // Reset
    document.getElementById('reset-all').addEventListener('click', async ()=>{
      if(confirm('Clear all locally stored progress and keys?')){ await DB.clearAll(); location.reload(); }
    });

    // Initial load
    loadProgress();

    // Service Worker (cache this page for offline)
    if('serviceWorker' in navigator){
      const swCode = `
        const CACHE='pra-water-v1';
        self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
        self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e=>{
          const url = new URL(e.request.url);
          if(url.origin===location.origin){
            e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
              const copy = res.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)); return res;
            })));
          }
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    }
  </script>
</body>
</html>

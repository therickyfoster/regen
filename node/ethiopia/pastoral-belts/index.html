<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horn & Sahel Pastoral Belts ‚Ä¢ Food & Water Sovereignty ‚Äî Multisystem Dashboard (Foster + Navi)</title>
<meta name="theme-color" content="#0b1020" />
<meta name="color-scheme" content="dark" />
<meta name="description" content="Offline-first sovereignty dashboard for pastoral belts (Horn & Sahel): boreholes/berkads/hafirs ‚Üí mobile herds & corridors ‚Üí fodder banks/blocks ‚Üí animal health/vaccinations ‚Üí markets (livestock/fodder/water trucking) ‚Üí peace pacts ‚Üí early warning. Mycelial gamification, anti-inversion guardrails, service-worker caching." />
<style>
  :root{
    --bg:#0b1020; --ink:#e8f0ff; --muted:#c9d2ffcc;
    --card:#0e1534e6; --edge:#1b2658; --glass:#0e1534b0;
    --accent:#7af5e5; --accent2:#a78bfa; --gold:#ffd166; --ok:#70ffa8; --warn:#ffcd6b; --bad:#ff6b6b;
    --shadow:0 10px 30px #0008, inset 0 1px 0 #3a49a155;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 800px at 80% -10%, #1a2346 0%, rgba(11,16,32,0) 60%),
                     radial-gradient(1000px 600px at 10% -20%, #141d3a 0%, rgba(11,16,32,0) 60%), var(--bg);
    color:var(--ink); font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
    overflow-x:hidden;
  }
  /* Photorealistic constellation parallax (3 layers) */
  #deep-sky,#sky,#near-sky{position:fixed; inset:0; z-index:-5}
  #sky{z-index:-4; opacity:.95} #near-sky{z-index:-3; opacity:.85}
  .nebula{position:fixed; inset:auto; z-index:-2; pointer-events:none; opacity:.28; mix-blend-mode:screen;
          filter:brightness(115%) blur(10px) saturate(130%);
          background:radial-gradient(650px 400px at 15% 30%, #4f46e5 0%, transparent 60%),
                     radial-gradient(800px 500px at 80% 20%, #22d3ee 0%, transparent 65%),
                     radial-gradient(700px 500px at 45% 75%, #8b5cf6 0%, transparent 60%);
          width:140vmax; height:100vmax; left:-10vmax; top:-10vmax}
  header{position:sticky; top:0; backdrop-filter:blur(8px);
         background:linear-gradient(180deg, rgba(16,25,54,.88), rgba(16,25,54,.42) 60%, transparent);
         border-bottom:1px solid #1f2a5a; z-index:10}
  .wrap{max-width:1280px; margin:0 auto; padding:16px clamp(12px,2.6vw,28px)}
  h1{margin:.2rem 0 .4rem; font-weight:900; font-size:clamp(22px,3.6vw,38px); letter-spacing:.2px}
  h2{margin:1.4rem 0 .5rem; font-size:clamp(18px,2.4vw,26px)}
  h3{margin:1rem 0 .3rem; font-size:clamp(16px,2vw,22px)}
  p,li{color:var(--muted)}
  a{color:var(--accent)}
  .badge{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:4px 8px; border-radius:999px;
         border:1px solid #28407a; background:#101936b3; color:#c7d2fe}
  .ribbon{display:inline-block; padding:3px 8px; border-radius:8px; background:#0f1a3dcc; border:1px solid #24306a; color:#c7d2fe}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:linear-gradient(180deg, var(--card), #0c1330cc); border:1px solid var(--edge); border-radius:16px; padding:16px; box-shadow:var(--shadow); position:relative}
  .panel{display:grid; gap:12px; grid-template-columns: repeat(12,1fr)}
  .panel > .card{grid-column: span 12}
  @media(min-width:880px){
    .span-4{grid-column: span 4} .span-6{grid-column: span 6} .span-8{grid-column: span 8} .span-12{grid-column: span 12}
  }
  .section{position:relative; margin:22px 0; padding:18px; border:1px solid var(--edge); border-radius:16px; background:linear-gradient(180deg,#0e1534c8,#0d1432aa)}
  .section[data-depth="near"]{transform:translateY(calc(var(--scroll,0)*.06px))}
  .section[data-depth="mid"]{transform:translateY(calc(var(--scroll,0)*.03px))}
  .section[data-depth="far"]{transform:translateY(calc(var(--scroll,0)*.015px))}
  .divider{height:1px; background:linear-gradient(90deg, transparent, #2a3880, transparent); margin:16px 0}
  .muted{opacity:.92}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:13px}
  .tag{position:absolute; top:10px; right:12px; font-size:11px; color:#cbd5ff; opacity:.9}
  .tooltip{border-bottom:1px dashed #7aa2ff; cursor:help}
  .btn{display:inline-flex; gap:10px; align-items:center; padding:10px 14px; border-radius:12px; text-decoration:none;
       background:linear-gradient(90deg,#233069,#192653); border:1px solid #2a3a76; color:#e4ebff}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .switch{display:inline-flex; align-items:center; gap:8px}
  .switch input{accent-color:#7aa2ff}
  .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111b3f; color:#eaf0ff; border:1px solid #2a3a76; border-radius:10px; padding:10px 14px; display:none; z-index:20}
  .okline{height:3px; background:linear-gradient(90deg, #63ff99, #7af5e5)}
  .list-tight li{margin:.25rem 0}
  .inversion{margin:10px 0 6px; padding:10px 14px; border-radius:12px; border:1px solid #28407a;
             background:linear-gradient(180deg,#0f183cdd,#0f183c80); color:#e8f0ff; font-weight:600}
  .kpis{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .kpi{padding:12px 14px; border:1px solid var(--edge); border-radius:14px; background:#0e1534cc}
  .kpi .big{font-weight:900; font-size:clamp(18px,2.6vw,28px)}
  canvas#mycelium{width:100%; height:260px; display:block; border-radius:12px; background:linear-gradient(180deg,#0f1630bb,#0a122caa); border:1px solid var(--edge)}
  footer{padding:26px 0; text-align:center; color:#a8b6f1}
</style>
</head>
<body>
<canvas id="deep-sky" aria-hidden="true"></canvas>
<canvas id="sky" aria-hidden="true"></canvas>
<canvas id="near-sky" aria-hidden="true"></canvas>
<div class="nebula" aria-hidden="true"></div>

<header>
  <div class="wrap">
    <div class="badge">Foster + Navi ‚Ä¢ Planetary Restoration Archive ‚Ä¢ Zero-Harm / Anti-Inversion</div>
    <h1>Pastoral Belts ‚Äî Food & Water Sovereignty ‚Ä¢ Multisystem Dashboard</h1>
    <p class="muted">Offline-first blueprint for mobile herders across the Horn & Sahel: water points (boreholes/berkads/hafirs) ‚Üí mobility corridors & seasonal grazing ‚Üí animal health & markets ‚Üí fodder banks/blocks ‚Üí peace pacts ‚Üí early warning. Mycelial gamification coordinates action while honoring pastoral dignity.</p>
  </div>
</header>

<main class="wrap">
  <section class="section" data-depth="near">
    <div Anti-inversion: hope-first, zero-harm design. Every module welcomes dignified reintegration of all actors into a peaceful commons.</div>
    <div class="toolbar" role="toolbar" aria-label="Quick controls">
      <a class="btn" id="exportState">Export State (JSON)</a>
      <a class="btn" id="importState">Import State</a>
      <label class="switch"><input type="checkbox" id="darkness" checked/> <span>Night mode</span></label>
      <a class="btn" id="openQuestEditor">Quest Editor</a>
      <a class="btn" id="syncGithub">Load Gamification Plugin (GitHub)</a>
    </div>
    <div class="divider"></div>
    <div class="kpis">
      <div class="kpi"><div class="muted">Herding households onboarded</div><div class="big" id="kpiHouseholds">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Water points restored (bore/berkad/hafir)</div><div class="big" id="kpiWater">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Mobile vet outreaches</div><div class="big" id="kpiVet">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Fodder banks / feed blocks</div><div class="big" id="kpiFodder">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Corridor & grazing accords</div><div class="big" id="kpiAccords">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Livestock vaccinated</div><div class="big" id="kpiVax">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Early warnings issued</div><div class="big" id="kpiEW">0</div><div class="okline"></div></div>
    </div>
  </section>

  <!-- ====================== CORE MODULES ====================== -->
  <section class="section" data-depth="mid" id="modules">
    <h2>Action Modules (click to expand)</h2>
    <div class="panel">
      <!-- WATER SYSTEMS -->
      <details class="card span-6" open>
        <summary><strong>üíß Water Points ‚Äî Boreholes ‚Ä¢ Berkads ‚Ä¢ Hafirs ‚Ä¢ Subsurface Dams</strong></summary>
        <p>Rehabilitation, chlorination, generator/solar kits, spares and O&M committees with women/youth seats.</p>
        <div class="grid">
          <div class="card">
            <label>Type</label>
            <select id="wpType"><option>Borehole</option><option>Berkad (cistern)</option><option>Hafir (pond)</option><option>Subsurface dam</option></select>
            <label>Location</label><input id="wpLoc" placeholder="Woreda/County ‚Ä¢ GPS/landmark" />
            <label>Action</label>
            <select id="wpAction"><option>Pump repair</option><option>Desilt</option><option>Apron/fencing</option><option>Solar retrofit</option><option>Chlorination</option><option>Spare parts cache</option></select>
            <button class="btn" id="addWaterPoint">Log Water Action</button>
          </div>
          <div class="card">
            <h3>Water Points</h3>
            <ul id="wpList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- MOBILITY & PEACE -->
      <details class="card span-6" open>
        <summary><strong>üß≠ Mobility Corridors & Crossline Peace Pacts</strong></summary>
        <p>Dry-season & wet-season routes, negotiated access to grazing and water; neutral status for troughs & vet posts.</p>
        <div class="grid">
          <div class="card">
            <label>Corridor name</label><input id="corrName" placeholder="e.g., Borena ‚Üî Marsabit dry-season corridor" />
            <label>Season</label><select id="corrSeason"><option>Dry</option><option>Wet</option><option>All-season</option></select>
            <label>Notes</label><input id="corrNotes" placeholder="waypoints, clans, elders committee" />
            <button class="btn" id="addCorridor">Add Corridor</button>
          </div>
          <div class="card">
            <h3>Accords</h3>
            <label>Communities</label><input id="accordComms" placeholder="e.g., Gabra‚ÄìBorana elders council" />
            <label>Terms</label><input id="accordTerms" placeholder="shared trough, no-arms at water, market truce day" />
            <button class="btn" id="addAccord">Record Accord</button>
            <ul id="accordList" class="list-tight" style="margin-top:10px"></ul>
          </div>
        </div>
      </details>

      <!-- LIVESTOCK HEALTH -->
      <details class="card span-6">
        <summary><strong>üê™ Livestock Health ‚Äî Vax ‚Ä¢ Deworm ‚Ä¢ Vet Packs ‚Ä¢ Cold Chain</strong></summary>
        <p>Species: camel, cattle, goats, sheep. Prioritize PPR, SGP, CBPP, FMD campaigns; deworm + vitamin boosters.</p>
        <div class="grid">
          <div class="card">
            <label>Species</label><select id="vetSpecies"><option>Camel</option><option>Cattle</option><option>Goat</option><option>Sheep</option></select>
            <label>Intervention</label><select id="vetType"><option>Vaccination</option><option>Deworm</option><option>Treatment</option><option>Vitamin/mineral</option></select>
            <label>Count</label><input id="vetCount" type="number" min="0" />
            <label>Mobile team</label><input id="vetTeam" placeholder="Team or NGO/DoL unit" />
            <button class="btn" id="addVet">Log Vet Outreach</button>
          </div>
          <div class="card">
            <h3>Outreach Ledger</h3>
            <ul id="vetList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- FODDER & FEED -->
      <details class="card span-6">
        <summary><strong>üåø Fodder Banks ‚Ä¢ Feed Blocks ‚Ä¢ Reseeding ‚Ä¢ Enclosures</strong></summary>
        <p>Strategic enclosures, drought-tolerant grasses (Cenchrus, Chloris), legume pods, urea-molasses blocks; hay sheds.</p>
        <div class="grid">
          <div class="card">
            <label>Site</label><input id="fodderSite" placeholder="kebele/ward ‚Ä¢ enclosure name" />
            <label>Action</label>
            <select id="fodderAction"><option>Fodder bank established</option><option>Reseeding</option><option>Feed blocks produced</option><option>Hay baled</option><option>Bush control</option></select>
            <label>Quantity</label><input id="fodderQty" type="number" min="0" placeholder="e.g., 500 (bales/blocks/kg)" />
            <button class="btn" id="addFodder">Add Fodder Action</button>
          </div>
          <div class="card">
            <h3>Fodder Actions</h3>
            <ul id="fodderList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- MARKETS -->
      <details class="card span-6">
        <summary><strong>üìà Market & Price Watch ‚Äî Livestock ‚Ä¢ Fodder ‚Ä¢ Trucked Water ‚Ä¢ Fuel</strong></summary>
        <p>Track market prices; alert on spikes/drops. Hubs: Garissa, Isiolo, Marsabit, Wajir, Mandera, Lodwar, Moyale, Yabello/Borena, Semera (Afar), Gode, Hargeisa, Baidoa, Kismayo, El Fasher, Nyala.</p>
        <div class="grid">
          <div class="card">
            <label>Market</label>
            <select id="mktTown">
              <option>Garissa</option><option>Isiolo</option><option>Marsabit</option><option>Wajir</option><option>Mandera</option><option>Lodwar</option><option>Moyale</option>
              <option>Yabello</option><option>Semera</option><option>Gode</option><option>Hargeisa</option><option>Baidoa</option><option>Kismayo</option><option>El Fasher</option><option>Nyala</option>
            </select>
            <label>Commodity</label>
            <select id="mktItem">
              <option>Goat (head)</option><option>Sheep (head)</option><option>Cattle (head)</option><option>Camel (head)</option>
              <option>Fodder bale</option><option>Feed block</option><option>Water (trucked, 10,000L)</option><option>Fuel (diesel/L)</option>
            </select>
            <label>Price (local currency)</label><input id="mktPrice" type="number" min="0" step="0.01" />
            <button class="btn" id="addPrice">Log Price</button>
          </div>
          <div class="card">
            <h3>Signals</h3>
            <ul id="priceSignals" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- EARLY WARNING -->
      <details class="card span-6">
        <summary><strong>‚ö†Ô∏è Early Warning (manual, offline-first)</strong></summary>
        <p class="muted">Enter observations to trigger advisories (later wire to feeds). Indices: NDVI/VCI, water point outages, disease rumors, conflict risk.</p>
        <div class="grid">
          <div class="card">
            <label>Signal</label>
            <select id="ewType">
              <option>NDVI/VCI low (pasture)</option>
              <option>Water point outage</option>
              <option>Livestock disease rumor</option>
              <option>Grain price spike</option>
              <option>Fodder price spike</option>
              <option>Conflict near corridor</option>
              <option>Locust watch</option>
              <option>Heat stress window</option>
              <option>Storm/flood watch</option>
              <option>Cross-border closure</option>
            </select>
            <label>Severity</label><select id="ewSev"><option>Low</option><option>Moderate</option><option>High</option></select>
            <label>Notes</label><input id="ewNotes" placeholder="What, where, when" />
            <button class="btn" id="addEW">Add Warning</button>
          </div>
          <div class="card">
            <h3>Advisories</h3>
            <ul id="ewList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- LIVELIHOODS: MILK, HIDES, CASH -->
      <details class="card span-6">
        <summary><strong>ü•õ Milk Co-ops ‚Ä¢ Hides/Skins ‚Ä¢ Cash-for-Water</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Co-op name</label><input id="coopName" placeholder="e.g., Camel Milk Collective ‚Äî Garissa" />
            <label>Action</label>
            <select id="coopAction"><option>Milk collection point</option><option>Solar chilling</option><option>Payment digitization</option><option>Hides/skins curing</option><option>Cash-for-water distribution</option></select>
            <button class="btn" id="addCoop">Log Livelihood Action</button>
          </div>
          <div class="card">
            <h3>Livelihood Actions</h3>
            <ul id="coopList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- KNOWLEDGE BANK -->
      <details class="card span-12">
        <summary><strong>üìö Knowledge & Scripts</strong> <span class="tag">planetaryrestorationarchive.com/scripts ‚Ä¢ GitHub loaders</span></summary>
        <p>Paste a GitHub RAW URL (or PRA endpoint) to load modules (if CORS permits). This keeps the dashboard lightweight but extensible.</p>
        <div class="grid">
          <div class="card">
            <label>Load script (GitHub RAW / PRA)</label>
            <input id="scriptUrl" placeholder="https://raw.githubusercontent.com/..." />
            <button class="btn" id="loadScript">Load</button>
            <p id="scriptStatus" class="muted"></p>
            <pre id="scriptPreview" class="mono" style="white-space:pre-wrap;max-height:200px;overflow:auto"></pre>
          </div>
          <div class="card">
            <h3>Pastoral Cheatsheet</h3>
            <ul class="list-tight">
              <li><span class="tooltip" title="Fence, rest, reseed with drought grasses/legumes; open with rules">Managed enclosures</span></li>
              <li><span class="tooltip" title="Urea-molasses + minerals molded into blocks to bridge feed gaps">Feed blocks (urea/molasses)</span></li>
              <li><span class="tooltip" title="Vaccinate pre-migration, cold chain boxes, shade & water for teams">Mobile vet campaign</span></li>
              <li><span class="tooltip" title="Solar retrofit for pumps, spares caches, fee committees">Borehole O&M committees</span></li>
              <li><span class="tooltip" title="Elders/peace committees set truce windows & neutral points">Crossline accords</span></li>
            </ul>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- ====================== GAMIFICATION ENGINE ====================== -->
  <section class="section" data-depth="near" id="game">
    <h2>üéÆ Mycelial Gamification Engine (offline-first)</h2>
    <p class="muted">Track quests, households, streaks, virtues, co-ops, and shared wins. Anti-inversion: only non-violent, dignity-preserving actions count.</p>

    <div class="grid">
      <div class="card">
        <h3>Create Quest</h3>
        <label>Title</label><input id="qTitle" placeholder="Rehabilitate 20 boreholes" />
        <label>Category</label>
        <select id="qCat">
          <option>Water</option><option>Mobility</option><option>Health</option><option>Fodder</option><option>Market</option><option>Peace</option><option>Early Warning</option><option>Livelihoods</option>
        </select>
        <label>Target value</label><input id="qTarget" type="number" min="1" value="5" />
        <label>Unit</label><input id="qUnit" placeholder="units" />
        <button class="btn" id="qCreate">Create Quest</button>
      </div>

      <div class="card">
        <h3>Active Quests</h3>
        <ul id="qList" class="list-tight"></ul>
      </div>

      <div class="card">
        <h3>Submit Progress</h3>
        <label>Quest</label><select id="qPick"></select>
        <label>Value</label><input id="qValue" type="number" min="0" />
        <label>Household/Team</label><input id="qWho" placeholder="Team / Household ID" />
        <button class="btn" id="qSubmit">Submit</button>
        <p id="qMsg" class="muted"></p>
      </div>

      <div class="card">
        <h3>Leaderboard</h3>
        <ol id="leader" class="list-tight"></ol>
      </div>

      <div class="card">
        <h3>Virtues</h3>
        <p class="muted">Stewardship ‚Ä¢ Care ‚Ä¢ Courage ‚Ä¢ Clarity</p>
        <ul id="virtues" class="list-tight"></ul>
      </div>

      <div class="card">
        <h3>Guilds (Co-ops)</h3>
        <label>Guild Name</label><input id="gName" placeholder="Pastoral Water Stewards ‚Äî North Corridor" />
        <button class="btn" id="gCreate">Create Guild</button>
        <ul id="gList" class="list-tight"></ul>
      </div>
    </div>
  </section>

  <!-- ====================== MYCELIAL MAP ====================== -->
  <section class="section" data-depth="far">
    <h2>Mycelial Synergy Map</h2>
    <p class="muted">Nodes are actions; edges show helpful synergies. Hover for hints.</p>
    <canvas id="mycelium" aria-label="Mycelial action network"></canvas>
  </section>

  <section class="section" data-depth="near" id="license">
    <h2>Zero-Harm / Anti-Inversion License Banner</h2>
    <p class="mono">This dashboard and associated scripts are intended exclusively for humanitarian, ecological, and dignity-preserving use. Any repurposing for coercion, violence, or deprivation violates the license spirit. Reintegration clause: all corrupt actors are invited back into peaceful civic life through transparent restitution and pro-social labor.</p>
  </section>

  <footer>
    <div class="divider"></div>
    <p class="mono">Local & offline-first. To wire in live feeds later, add connectors; this file will cache via service worker.</p>
    <p class="mono">Foster + Navi ‚Ä¢ PRA ‚Ä¢ Pastoral Belts Sovereignty Edition</p>
  </footer>
</main>

<!-- ====================== JS: Parallax Sky + Engine ====================== -->
<script>
/* Parallax constellation sky */
(function(){
  function stars(canvas, count, blurSpread){
    const dpr=Math.min(2, devicePixelRatio||1), ctx=canvas.getContext('2d');
    function resize(){ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; draw(); }
    const pts=[...Array(count)].map(()=>({x:Math.random(), y:Math.random(), r:Math.random()*1.3+.2, a:.35+.65*Math.random()}));
    function draw(){ const w=canvas.width,h=canvas.height; ctx.clearRect(0,0,w,h);
      for(const s of pts){ const x=s.x*w,y=s.y*h;
        ctx.globalAlpha=s.a;
        const g=ctx.createRadialGradient(x,y,0,x,y,s.r*dpr*blurSpread);
        g.addColorStop(0,'rgba(255,255,255,.95)'); g.addColorStop(1,'rgba(255,255,255,0)');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,s.r*dpr,0,Math.PI*2); ctx.fill();
      } ctx.globalAlpha=1;
    }
    addEventListener('resize', resize, {passive:true}); resize();
    return {draw};
  }
  stars(document.getElementById('near-sky'),1800,2.8);
  stars(document.getElementById('sky'),     1200,2.2);
  stars(document.getElementById('deep-sky'), 900,1.8);
  let t=0; (function tick(){ t+=.0025;
    document.querySelector('.nebula').style.transform=`translate3d(${Math.sin(t)*8}px,${Math.cos(t*.6)*6}px,0) rotate(${t*.02}rad)`;
    requestAnimationFrame(tick);
  })();
  addEventListener('scroll', ()=>{ document.documentElement.style.setProperty('--scroll', String(scrollY||0)); }, {passive:true});
})();

/* IndexedDB helper */
const DB = (function(){
  let db; const name='pastoral-sovereignty', ver=1;
  function open(){ return new Promise((res,rej)=>{
    const r = indexedDB.open(name, ver);
    r.onupgradeneeded = e=>{
      const d = e.target.result;
      d.createObjectStore('kv');
      d.createObjectStore('water',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('corridors',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('accords',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('vet',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('fodder',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('prices',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('ew',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('coops',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('quests',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('progress',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('guilds',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('virtues',{keyPath:'name'});
    };
    r.onsuccess = ()=>{db=r.result; res();}; r.onerror=()=>rej(r.error);
  });}
  function put(store, value, key){ return tx(store,'readwrite').store.put(value, key).complete }
  function get(store, key){ return tx(store).store.get(key) }
  function all(store){ return new Promise((res,rej)=>{ const t=tx(store), req=t.store.getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error)})}
  function tx(store, mode='readonly'){ const t=db.transaction(store, mode); t.store=t.objectStore(store); t.complete=new Promise((res,rej)=>{t.oncomplete=()=>res(); t.onerror=()=>rej(t.error);}); return t;}
  return {open,put,get,all};
})();

/* Toast */
function toast(msg){ const el=document.querySelector('.toast') || (()=>{
  const t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); return t;})();
  el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2200);
}

/* KPI rendering */
async function renderKPI(){
  const pairs = [
    ['households','kpiHouseholds'],
    ['water','kpiWater'],
    ['vet','kpiVet'],
    ['fodder','kpiFodder'],
    ['accords','kpiAccords'],
    ['vax','kpiVax'],
    ['ew','kpiEW']
  ];
  for(const [k,id] of pairs){ const v = (await DB.get('kv', k)) || 0; const el = document.getElementById(id);
    if(el) el.textContent = v.toLocaleString(); }
}
const KPI = {
  async bump(key, by=1){
    const cur = (await DB.get('kv', key)) || 0; await DB.put('kv', cur+by, key);
    renderKPI();
  }
};

/* Water points */
async function addWaterPoint(){
  const type=document.getElementById('wpType').value;
  const loc=document.getElementById('wpLoc').value.trim();
  const action=document.getElementById('wpAction').value;
  if(!loc) return toast('Location required');
  await DB.put('water',{type,loc,action,t:Date.now()});
  await KPI.bump('water',1);
  renderWater(); toast('Water action logged');
}
async function renderWater(){
  const data = await DB.all('water'); const ul=document.getElementById('wpList'); ul.innerHTML='';
  data.slice(-200).forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.type} ‚Ä¢ ${d.loc} ‚Äî ${d.action}`; ul.appendChild(li); });
}

/* Corridors & accords */
async function addCorridor(){
  const name=document.getElementById('corrName').value.trim();
  const season=document.getElementById('corrSeason').value;
  const notes=document.getElementById('corrNotes').value.trim();
  if(!name) return toast('Corridor name');
  await DB.put('corridors',{name,season,notes,t:Date.now()});
  renderCorridors(); toast('Corridor saved');
}
async function renderCorridors(){
  const all=await DB.all('corridors'); const list=document.getElementById('accordList'); // show below too
  // Just append to accords list as info if no separate UI; keep simple
  const ul=document.createElement('ul'); ul.className='list-tight';
  all.forEach(d=>{ const li=document.createElement('li'); li.textContent = `üß≠ ${d.name} ‚Äî ${d.season} ‚Ä¢ ${d.notes}`; ul.appendChild(li); });
  // place under Mobility panel
  const mobPanel = document.querySelector('details[open] .grid').parentElement; // safe enough
}
async function addAccord(){
  const comms=document.getElementById('accordComms').value.trim();
  const terms=document.getElementById('accordTerms').value.trim();
  if(!comms||!terms) return toast('Communities + terms');
  await DB.put('accords',{comms,terms,t:Date.now()});
  await KPI.bump('accords',1);
  renderAccords(); toast('Accord recorded');
}
async function renderAccords(){
  const data=await DB.all('accords'); const ul=document.getElementById('accordList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.comms} ‚Äî ${d.terms}`; ul.appendChild(li); });
}

/* Vet outreach */
async function addVet(){
  const species=document.getElementById('vetSpecies').value;
  const type=document.getElementById('vetType').value;
  const count=parseInt(document.getElementById('vetCount').value||'0',10);
  const team=(document.getElementById('vetTeam').value||'anonymous team').trim();
  if(!count) return toast('Enter animal count');
  await DB.put('vet',{species,type,count,team,t:Date.now()});
  await KPI.bump('vet',1);
  if(/vax|vaccination/i.test(type)) await KPI.bump('vax',count);
  renderVet(); toast('Vet outreach logged');
}
async function renderVet(){
  const data=await DB.all('vet'); const ul=document.getElementById('vetList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.team} ‚Äî ${d.type} ${d.count} ${d.species}`; ul.appendChild(li); });
}

/* Fodder */
async function addFodder(){
  const site=document.getElementById('fodderSite').value.trim();
  const action=document.getElementById('fodderAction').value;
  const qty=parseFloat(document.getElementById('fodderQty').value||'0');
  if(!site) return toast('Site required');
  await DB.put('fodder',{site,action,qty,t:Date.now()});
  await KPI.bump('fodder',1);
  renderFodder(); toast('Fodder action logged');
}
async function renderFodder(){
  const data=await DB.all('fodder'); const ul=document.getElementById('fodderList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.site} ‚Äî ${d.action}${d.qty?` (${d.qty})`:''}`; ul.appendChild(li); });
}

/* Markets */
async function addPrice(){
  const town=document.getElementById('mktTown').value;
  const item=document.getElementById('mktItem').value;
  const price=parseFloat(document.getElementById('mktPrice').value||'0');
  if(!price) return toast('Enter price');
  await DB.put('prices',{town,item,price,t:Date.now()});
  analyzePrices(); toast('Logged.');
}
async function analyzePrices(){
  const list = await DB.all('prices');
  const by = {};
  for(const r of list){ const key=r.town+'|'+r.item; (by[key] ||= []).push(r.price); }
  const ul = document.getElementById('priceSignals'); ul.innerHTML='';
  Object.entries(by).forEach(([key, arr])=>{
    const [town, item]=key.split('|'); arr.sort((a,b)=>a-b);
    const n=arr.length, med=arr[Math.floor(n/2)], last=arr[arr.length-1];
    const jump = last>med*1.25;
    const li = document.createElement('li'); li.innerHTML = `<strong>${town}</strong> ‚Äî ${item}: latest ${last.toFixed(2)} ‚Äî ${jump?'<span class="bad">SPIKE</span>':'ok'}`;
    ul.appendChild(li);
  });
}

/* Early Warning */
async function addEW(){
  const type=document.getElementById('ewType').value; const sev=document.getElementById('ewSev').value; const notes=document.getElementById('ewNotes').value;
  await DB.put('ew',{type,sev,notes,t:Date.now()}); await KPI.bump('ew',1);
  renderEW(); toast('Advisory logged');
}
async function renderEW(){
  const data=await DB.all('ew'); const ul=document.getElementById('ewList'); ul.innerHTML='';
  data.sort((a,b)=>b.t-a.t).slice(0,100).forEach(d=>{
    const li=document.createElement('li');
    const color = d.sev==='High'?'bad': (d.sev==='Moderate'?'warn':'ok');
    li.innerHTML=`<strong class="${color}">${d.sev}</strong> ‚Ä¢ ${d.type} ‚Äî <span class="muted">${d.notes||''}</span>`;
    ul.appendChild(li);
  });
}

/* Livelihoods */
async function addCoop(){
  const name=document.getElementById('coopName').value.trim();
  const action=document.getElementById('coopAction').value;
  if(!name) return toast('Co-op name');
  await DB.put('coops',{name,action,t:Date.now()});
  renderCoops(); toast('Action logged');
}
async function renderCoops(){
  const data=await DB.all('coops'); const ul=document.getElementById('coopList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.name} ‚Äî ${d.action}`; ul.appendChild(li); });
}

/* Gamification */
const GAME = {
  async init(){
    for (const v of ['Stewardship','Care','Courage','Clarity']){
      if(!(await DB.get('virtues',v))) await DB.put('virtues',{name:v, score:0});
    }
    const seedDefaults = [
      {id:crypto.randomUUID(), title:'Rehabilitate 20 boreholes', category:'Water', target:20, unit:'boreholes', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Desilt 30 berkads/hafirs', category:'Water', target:30, unit:'sites', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Negotiate 12 corridor accords', category:'Peace', target:12, unit:'accords', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Run 40 mobile vet outreaches', category:'Health', target:40, unit:'outreaches', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Vaccinate 50,000 small ruminants', category:'Health', target:50000, unit:'animals', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Establish 25 fodder banks', category:'Fodder', target:25, unit:'banks', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Produce 10,000 feed blocks', category:'Fodder', target:10000, unit:'blocks', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Issue 60 early warnings', category:'Early Warning', target:60, unit:'alerts', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Launch 8 milk co-ops', category:'Livelihoods', target:8, unit:'co-ops', progress:0, t:Date.now()}
    ];
    const existing = await DB.all('quests');
    if(existing.length===0){ for(const q of seedDefaults){ await DB.put('quests', q); } }
    renderVirtues(); renderQuests(); renderLeader(); renderGuilds();
  },
  async addQuest(q){ await DB.put('quests', q); renderQuests(); toast('Quest created'); }
};
async function renderQuests(){
  const list = await DB.all('quests');
  const ul=document.getElementById('qList'); const pick=document.getElementById('qPick');
  ul.innerHTML=''; pick.innerHTML='';
  list.forEach(q=>{
    const li=document.createElement('li');
    const done=(q.progress||0); const pct=Math.min(100, Math.round(100*done/(q.target||1)));
    li.innerHTML = `<strong>${q.title}</strong> (${q.category}) ‚Äî ${done.toLocaleString()}/${q.target.toLocaleString()} ${q.unit} <span class="ribbon">${pct}%</span>`;
    ul.appendChild(li);
    const opt=document.createElement('option'); opt.value=q.id; opt.textContent=q.title; pick.appendChild(opt);
  });
}
async function renderLeader(){
  const prog = await DB.all('progress'); const by={};
  for(const p of prog){ by[p.who] = (by[p.who]||0) + (p.value||0); }
  const arr = Object.entries(by).map(([k,v])=>({who:k, score:v})).sort((a,b)=>b.score-a.score).slice(0,20);
  const ol=document.getElementById('leader'); ol.innerHTML='';
  arr.forEach(e=>{ const li=document.createElement('li'); li.textContent = `${e.who} ‚Äî ${e.score}`; ol.appendChild(li); });
}
async function renderVirtues(){
  const v = await DB.all('virtues'); const ul=document.getElementById('virtues'); ul.innerHTML='';
  v.forEach(x=>{ const li=document.createElement('li'); li.innerHTML=`<strong>${x.name}</strong> ‚Äî ${x.score}`; ul.appendChild(li); });
}
async function virtueBump(name, by=1){ const v=await DB.get('virtues',name)||{name,score:0}; v.score+=by; await DB.put('virtues',v); renderVirtues(); }

/* Guilds */
async function createGuild(){
  const name=document.getElementById('gName').value.trim(); if(!name) return toast('Name your guild');
  await DB.put('guilds',{name, created:Date.now()}); renderGuilds(); toast('Guild created');
}
async function renderGuilds(){
  const g=await DB.all('guilds'); const ul=document.getElementById('gList'); ul.innerHTML='';
  g.forEach(x=>{ const li=document.createElement('li'); li.textContent = x.name; ul.appendChild(li); });
}

/* Quick quest buttons from modules (optional seeds) */
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-quest]'); if(!btn) return;
  const map={
    boreholes:{title:'Rehabilitate 20 boreholes', category:'Water', target:20, unit:'boreholes'},
    berkads:{title:'Desilt 30 berkads/hafirs', category:'Water', target:30, unit:'sites'},
    corridors:{title:'Negotiate 12 corridor accords', category:'Peace', target:12, unit:'accords'},
    vet:{title:'Run 40 mobile vet outreaches', category:'Health', target:40, unit:'outreaches'},
    vax:{title:'Vaccinate 50,000 small ruminants', category:'Health', target:50000, unit:'animals'},
    fodder:{title:'Establish 25 fodder banks', category:'Fodder', target:25, unit:'banks'},
    feedblocks:{title:'Produce 10,000 feed blocks', category:'Fodder', target:10000, unit:'blocks'},
    alerts:{title:'Issue 60 early warnings', category:'Early Warning', target:60, unit:'alerts'}
  };
  const q=map[btn.dataset.quest]; if(q) await GAME.addQuest({id:crypto.randomUUID(), ...q, progress:0, t:Date.now()});
});

/* Quest CRUD */
document.getElementById('qCreate').addEventListener('click', async ()=>{
  const title=document.getElementById('qTitle').value.trim();
  const category=document.getElementById('qCat').value;
  const target=parseFloat(document.getElementById('qTarget').value||'1');
  const unit=document.getElementById('qUnit').value||'units';
  if(!title || !target) return toast('Title + target');
  await GAME.addQuest({id:crypto.randomUUID(), title, category, target, unit, progress:0, t:Date.now()});
});
document.getElementById('qSubmit').addEventListener('click', async ()=>{
  const id=document.getElementById('qPick').value; const val=parseFloat(document.getElementById('qValue').value||'0');
  const who=(document.getElementById('qWho').value||'anonymous').trim();
  if(!id || !val) return toast('Select quest + value');
  const qs = await DB.all('quests'); const q=qs.find(x=>x.id===id); if(!q) return toast('Quest not found');
  q.progress=(q.progress||0)+val; await DB.put('quests', q);
  await DB.put('progress', {quest:id, value:val, who, t:Date.now()});
  document.getElementById('qMsg').textContent=`Recorded ${val} ${q.unit} for ${who}`;
  if(q.category==='Water' || q.category==='Peace' || q.category==='Health') await virtueBump('Care',1);
  if(q.category==='Fodder' || q.category==='Livelihoods') await virtueBump('Stewardship',1);
  if(q.category==='Early Warning' || q.category==='Market' || q.category==='Mobility') await virtueBump('Clarity',1);
  renderQuests(); renderLeader();
  if(/household|herd/i.test(q.title)) KPI.bump('households', Math.max(1,val));
  if(/borehole|berkad|hafir|water/i.test(q.title)) KPI.bump('water', Math.max(1,val));
  if(/vet|outreach/i.test(q.title)) KPI.bump('vet', Math.max(1,val));
  if(/vax|vaccinate/i.test(q.title)) KPI.bump('vax', Math.max(1,val));
  if(/fodder|feed block/i.test(q.title)) KPI.bump('fodder', Math.max(1,val));
  if(/accord|corridor/i.test(q.title)) KPI.bump('accords', Math.max(1,val));
  if(/alert|warning/i.test(q.title)) KPI.bump('ew', Math.max(1,val));
});

/* Mycelial force-ish viz */
(function(){
  const canvas=document.getElementById('mycelium'), ctx=canvas.getContext('2d'), dpr=Math.min(2,devicePixelRatio||1);
  function fit(){ canvas.width=canvas.clientWidth*dpr; canvas.height=canvas.clientHeight*dpr; } fit(); addEventListener('resize',fit,{passive:true});
  const nodes=[{id:'Water',tip:'Boreholes‚Ä¢Berkads‚Ä¢Hafirs‚Ä¢Solar kits'},
               {id:'Mobility',tip:'Dry/Wet corridors‚Ä¢waypoints'},
               {id:'Accords',tip:'Neutral water points‚Ä¢truce days'},
               {id:'Health',tip:'Vax‚Ä¢Deworm‚Ä¢Cold chain'},
               {id:'Fodder',tip:'Banks‚Ä¢Reseeding‚Ä¢Blocks‚Ä¢Hay'},
               {id:'Livelihoods',tip:'Milk co-ops‚Ä¢Hides‚Ä¢Cash-for-water'},
               {id:'Markets',tip:'Livestock‚Ä¢Fodder‚Ä¢Fuel‚Ä¢Water'},
               {id:'EarlyWarn',tip:'NDVI/VCI‚Ä¢Outages‚Ä¢Conflict'},
               {id:'Guilds',tip:'Co-ops & O&M committees'}]
    .map(n=>Object.assign(n,{x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:0,vy:0,r:8*dpr}));
  const links=[['Water','Mobility'],['Mobility','Accords'],['Accords','Health'],['Health','Fodder'],['Fodder','Livelihoods'],['Livelihoods','Markets'],['Markets','EarlyWarn'],['Guilds','Water'],['Guilds','Fodder']];
  let hover=null;
  canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect(),x=(e.clientX-r.left)*dpr,y=(e.clientY-r.top)*dpr;
    hover=nodes.find(n=> (x-n.x)**2+(y-n.y)**2 < (n.r+6*dpr)**2) || null; });
  function step(){
    for(let i=0;i<nodes.length;i++)for(let j=i+1;j<nodes.length;j++){const a=nodes[i],b=nodes[j]; let dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy)||1; let f=(80*dpr)/d; a.vx+=dx/d*f; a.vy+=dy/d*f; b.vx-=dx/d*f; b.vy-=dy/d*f;}
    for(const [u,v] of links){ const a=nodes.find(n=>n.id===u), b=nodes.find(n=>n.id===v); const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy)||1; const k=.006, rest=150*dpr, f=(d-rest)*k; a.vx+=dx/d*f; a.vy+=dy/d*f; b.vx-=dx/d*f; b.vy-=dy/d*f;}
    for(const n of nodes){ n.vx*=.86; n.vy*=.86; n.x+=n.vx*.016; n.y+=n.vy*.016; n.x=Math.max(30*dpr,Math.min(canvas.width-30*dpr,n.x)); n.y=Math.max(30*dpr,Math.min(canvas.height-30*dpr,n.y)); }
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.lineWidth=1*dpr;
    for(const [u,v] of links){ const a=nodes.find(n=>n.id===u), b=nodes.find(n=>n.id===v);
      ctx.strokeStyle="rgba(122,162,255,.45)"; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();}
    for(const n of nodes){
      const g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r*2.3); g.addColorStop(0,"#dbe6ff"); g.addColorStop(1,"rgba(219,230,255,0)");
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(n.x,n.y,n.r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle="#5d78ff"; ctx.stroke();
      ctx.fillStyle="#cfe0ff"; ctx.font=`${12*dpr}px ui-sans-serif`; ctx.textAlign="center"; ctx.fillText(n.id,n.x,n.y-12*dpr);
    }
    if(hover){ const boxW=340*dpr, boxH=64*dpr, x=Math.min(canvas.width-boxW-10*dpr, hover.x+16*dpr), y=Math.max(10*dpr, hover.y-boxH-16*dpr);
      ctx.fillStyle="rgba(16,25,54,.92)"; ctx.strokeStyle="#2a3a76"; ctx.lineWidth=1*dpr; ctx.beginPath(); ctx.roundRect(x,y,boxW,boxH,8*dpr); ctx.fill(); ctx.stroke();
      ctx.fillStyle="#e8f0ff"; ctx.font=`${12*dpr}px ui-sans-serif`; wrapText(ctx,hover.tip,x+10*dpr,y+20*dpr,boxW-20*dpr,16*dpr); }
  }
  function wrapText(ctx, text, x, y, maxW, lineH){ const words=text.split(' '); let line=''; for(const w of words){ const test=line+w+' '; if(ctx.measureText(test).width>maxW){ ctx.fillText(line,x,y); line=w+' '; y+=lineH; } else line=test; } ctx.fillText(line,x,y); }
  (function anim(){ step(); draw(); requestAnimationFrame(anim); })();
})();

/* GitHub / PRA script loader */
document.getElementById('loadScript').addEventListener('click', async ()=>{
  const url=document.getElementById('scriptUrl').value.trim();
  if(!url) return toast('Paste a URL');
  const status=document.getElementById('scriptStatus'); const pre=document.getElementById('scriptPreview');
  status.textContent='Fetching‚Ä¶';
  try{
    const res=await fetch(url, {mode:'cors'});
    const txt=await res.text();
    pre.textContent = txt.slice(0, 5000);
    status.textContent='Loaded. (Preview truncated)';
    // If the script exposes register(dashboard) we run it safely
    if(/register\s*\(/.test(txt)){
      const fn = new Function('dashboard', txt + '\n//# sourceURL=external-script.js');
      fn(window.DASHBOARD_API); toast('Executed plugin');
    }else{
      toast('Loaded script. No register() found ‚Äî kept as reference.');
    }
  }catch(e){ status.textContent='Failed to load (CORS or network)'; }
});

/* Plugin API for deep gamification engines from GitHub/PRA */
window.DASHBOARD_API = {
  addBadge(b){ const ul=document.getElementById('virtues'); const li=document.createElement('li'); li.innerHTML=`üèÖ <strong>${b.name}</strong> ‚Äî ${b.desc||''}`; ul.appendChild(li); },
  addMetric(name, fn){ DASHBOARD_API[name]=fn; },
  onProgress(cb){ DASHBOARD_API._onProg=cb; },
  award(who, what){ toast(`${who} earned ${what}`) },
  ui:{ toast, addPanel(html){ const sec=document.getElementById('game'); const div=document.createElement('div'); div.className='card'; div.innerHTML=html; sec.querySelector('.grid').appendChild(div); } }
};
document.getElementById('syncGithub').addEventListener('click', ()=>{
  const u = prompt('Paste GitHub RAW URL of your gamification engine (register({...}))');
  if(u){ document.getElementById('scriptUrl').value=u; document.getElementById('loadScript').click(); }
});

/* Export/Import state */
document.getElementById('exportState').addEventListener('click', async ()=>{
  const out = {
    kv: {
      households: await DB.get('kv','households')||0, water: await DB.get('kv','water')||0,
      vet: await DB.get('kv','vet')||0, fodder: await DB.get('kv','fodder')||0,
      accords: await DB.get('kv','accords')||0, vax: await DB.get('kv','vax')||0, ew: await DB.get('kv','ew')||0
    },
    water: await DB.all('water'), corridors: await DB.all('corridors'), accords: await DB.all('accords'),
    vet: await DB.all('vet'), fodder: await DB.all('fodder'), prices: await DB.all('prices'),
    ew: await DB.all('ew'), coops: await DB.all('coops'), quests: await DB.all('quests'),
    progress: await DB.all('progress'), guilds: await DB.all('guilds')
  };
  const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pastoral-sovereignty-state.json'; a.click();
});
document.getElementById('importState').addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async ()=>{ const file=inp.files[0]; if(!file) return;
    const txt=await file.text(); const data=JSON.parse(txt);
    for(const k of ['water','corridors','accords','vet','fodder','prices','ew','coops','quests','progress','guilds']){
      for(const r of (data[k]||[])) await DB.put(k,r);
    }
    const kv=data.kv||{}; for(const [k,v] of Object.entries(kv)) await DB.put('kv', v, k);
    renderAll(); toast('State imported');
  };
  inp.click();
});

/* Wire UI events */
document.getElementById('addWaterPoint').addEventListener('click', addWaterPoint);
document.getElementById('addCorridor').addEventListener('click', addCorridor);
document.getElementById('addAccord').addEventListener('click', addAccord);
document.getElementById('addVet').addEventListener('click', addVet);
document.getElementById('addFodder').addEventListener('click', addFodder);
document.getElementById('addPrice').addEventListener('click', addPrice);
document.getElementById('addEW').addEventListener('click', addEW);
document.getElementById('addCoop').addEventListener('click', addCoop);
document.getElementById('gCreate').addEventListener('click', createGuild);

/* Theme toggle */
document.getElementById('darkness').addEventListener('change', (e)=>{
  document.body.style.filter = e.target.checked ? 'none' : 'invert(1) hue-rotate(180deg)';
});

/* Service Worker (offline shell) */
(function(){
  if(!('serviceWorker' in navigator)) return;
  const sw = `
    const C='pastoral-sovereignty-v1';
    self.addEventListener('install',e=>{ e.waitUntil(caches.open(C).then(c=>c.addAll(['./']))); self.skipWaiting()); });
    self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==C).map(k=>caches.delete(k))))); self.clients.claim(); });
    self.addEventListener('fetch',e=>{ const req=e.request; e.respondWith(caches.match(req).then(hit=>hit||fetch(req).then(r=>{const copy=r.clone(); caches.open(C).then(c=>c.put(req,copy)); return r;}).catch(()=>caches.match('./')))); });
  `;
  const blob=new Blob([sw],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url).catch(()=>{});
})();

/* Init */
(async function init(){
  await DB.open();
  await GAME.init();
  renderAll();
})();
async function renderAll(){ renderKPI(); renderWater(); renderAccords(); renderVet(); renderFodder(); analyzePrices(); renderEW(); renderCoops(); renderGuilds(); renderQuests(); renderLeader(); }

/* Bonus: plugin progress replay */
(async function pluginHooks(){
  const progList = await DB.all('progress');
  const cb = window.DASHBOARD_API && window.DASHBOARD_API._onProg;
  if(cb){ progList.forEach(p=>cb(p)); }
})();
</script>

<!-- Assistive toast element -->
<div class="toast" role="status" aria-live="polite"></div>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Edmonton ‚Ä¢ Sovereignty Dashboard ‚Äî Food ‚Ä¢ Water ‚Ä¢ Energy ‚Ä¢ Education ‚Ä¢ Health ‚Ä¢ Governance (Foster + Navi)</title>
<meta name="theme-color" content="#091223" />
<meta name="color-scheme" content="dark" />
<meta name="description" content="Offline-first, encryption-ready, gamified sovereignty dashboard for Edmonton: towers & neighbourhood gardens, stormwater & WASH, microgrids & cooling/clean-air centres, clinics & community fridges, skills & makers, markets & LRT corridors, civic pacts, and early warning. Parallax stars, IndexedDB, service worker, mnemonic backup, and GitHub/PRA plugin loader." />
<style>
  :root{
    --bg:#091223; --ink:#eaf1ff; --muted:#c9d2ffcc;
    --card:#0d1533e6; --edge:#1b2658; --glass:#0e1534b0;
    --accent:#7af5e5; --accent2:#a78bfa; --gold:#ffd166; --ok:#70ffa8; --warn:#ffcd6b; --bad:#ff6b6b;
    --shadow:0 10px 30px #0008, inset 0 1px 0 #3a49a155;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 800px at 80% -10%, #1a2346 0%, rgba(9,18,35,0) 60%),
      radial-gradient(1000px 600px at 10% -20%, #141d3a 0%, rgba(9,18,35,0) 60%),
      var(--bg);
    color:var(--ink); font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
    overflow-x:hidden;
  }
  #deep-sky,#sky,#near-sky{position:fixed; inset:0; z-index:-5}
  #sky{z-index:-4; opacity:.95} #near-sky{z-index:-3; opacity:.85}
  .nebula{position:fixed; inset:auto; z-index:-2; pointer-events:none; opacity:.28; mix-blend-mode:screen;
          filter:brightness(118%) blur(10px) saturate(130%);
          background:
            radial-gradient(780px 520px at 18% 30%, #4f46e5 0%, transparent 60%),
            radial-gradient(950px 600px at 78% 20%, #22d3ee 0%, transparent 68%),
            radial-gradient(840px 560px at 42% 76%, #8b5cf6 0%, transparent 62%);
          width:150vmax; height:110vmax; left:-10vmax; top:-12vmax}
  header{position:sticky; top:0; backdrop-filter:blur(8px);
         background:linear-gradient(180deg, rgba(16,25,54,.88), rgba(16,25,54,.42) 60%, transparent);
         border-bottom:1px solid #1f2a5a; z-index:10}
  .wrap{max-width:1280px; margin:0 auto; padding:16px clamp(12px,2.6vw,28px)}
  h1{margin:.2rem 0 .4rem; font-weight:900; font-size:clamp(22px,3.6vw,38px); letter-spacing:.2px}
  h2{margin:1.4rem 0 .5rem; font-size:clamp(18px,2.4vw,26px)}
  h3{margin:1rem 0 .3rem; font-size:clamp(16px,2vw,22px)}
  p,li{color:var(--muted)}
  a{color:var(--accent)}
  .badge{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:4px 8px; border-radius:999px;
         border:1px solid #28407a; background:#101936b3; color:#c7d2fe}
  .ribbon{display:inline-block; padding:3px 8px; border-radius:8px; background:#0f1a3dcc; border:1px solid #24306a; color:#c7d2fe}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:linear-gradient(180deg, var(--card), #0c1330cc); border:1px solid var(--edge); border-radius:16px; padding:16px; box-shadow:var(--shadow); position:relative}
  .panel{display:grid; gap:12px; grid-template-columns: repeat(12,1fr)}
  .panel > .card{grid-column: span 12}
  @media(min-width:880px){
    .span-4{grid-column: span 4} .span-6{grid-column: span 6} .span-8{grid-column: span 8} .span-12{grid-column: span 12}
  }
  .section{position:relative; margin:22px 0; padding:18px; border:1px solid var(--edge); border-radius:16px; background:linear-gradient(180deg,#0e1534c8,#0d1432aa)}
  .section[data-depth="near"]{transform:translateY(calc(var(--scroll,0)*.06px))}
  .section[data-depth="mid"]{transform:translateY(calc(var(--scroll,0)*.03px))}
  .section[data-depth="far"]{transform:translateY(calc(var(--scroll,0)*.015px))}
  .divider{height:1px; background:linear-gradient(90deg, transparent, #2a3880, transparent); margin:16px 0}
  .muted{opacity:.92}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:13px}
  .tag{position:absolute; top:10px; right:12px; font-size:11px; color:#cbd5ff; opacity:.9}
  .tooltip{border-bottom:1px dashed #7aa2ff; cursor:help}
  .btn{display:inline-flex; gap:10px; align-items:center; padding:10px 14px; border-radius:12px; text-decoration:none;
       background:linear-gradient(90deg,#233069,#192653); border:1px solid #2a3a76; color:#e4ebff; cursor:pointer}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .switch{display:inline-flex; align-items:center; gap:8px}
  .switch input{accent-color:#7aa2ff}
  .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111b3f; color:#eaf0ff; border:1px solid #2a3a76; border-radius:10px; padding:10px 14px; display:none; z-index:20}
  .okline{height:3px; background:linear-gradient(90deg, #63ff99, #7af5e5)}
  .list-tight li{margin:.25rem 0}
  .inversion{margin:10px 0 6px; padding:10px 14px; border-radius:12px; border:1px solid #28407a;
             background:linear-gradient(180deg,#0f183cdd,#0f183c80); color:#e8f0ff; font-weight:600}
  .kpis{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .kpi{padding:12px 14px; border:1px solid var(--edge); border-radius:14px; background:#0e1534cc}
  .kpi .big{font-weight:900; font-size:clamp(18px,2.6vw,28px)}
  canvas#mycelium{width:100%; height:300px; display:block; border-radius:12px; background:linear-gradient(180deg,#0f1630bb,#0a122caa); border:1px solid var(--edge)}
  footer{padding:26px 0; text-align:center; color:#a8b6f1}
  input,select,textarea{width:100%; padding:10px; border-radius:10px; border:1px solid #27356d; background:#0b1233; color:#e6ebff; margin:.2rem 0 .6rem}
</style>
</head>
<body>
<canvas id="deep-sky" aria-hidden="true"></canvas>
<canvas id="sky" aria-hidden="true"></canvas>
<canvas id="near-sky" aria-hidden="true"></canvas>
<div class="nebula" aria-hidden="true"></div>

<header>
  <div class="wrap">
    <div class="badge">Foster + Navi ‚Ä¢ Planetary Restoration Archive ‚Ä¢ Zero-Harm / Anti-Inversion</div>
    <h1>Edmonton ‚Äî Multisystem Sovereignty Dashboard (Full Reconstruction Mode)</h1>
    <p class="muted">
      Neighbourhoods & corridors: <strong>Downtown/Core</strong> ‚Ä¢ <strong>Oliver</strong> ‚Ä¢ <strong>Strathcona/Old Strathcona</strong> ‚Ä¢
      <strong>Garneau/U of A</strong> ‚Ä¢ <strong>Whyte Ave</strong> ‚Ä¢ <strong>Bonnie Doon</strong> ‚Ä¢ <strong>Mill Woods</strong> ‚Ä¢
      <strong>Clareview</strong> ‚Ä¢ <strong>NAIT/Blatchford</strong> ‚Ä¢ <strong>West Edmonton</strong> ‚Ä¢ <strong>Jasper Place</strong> ‚Ä¢
      <strong>Highlands/Beverly</strong> ‚Ä¢ <strong>Riverdale</strong>.
      Focus: urban food sovereignty, stormwater & WASH, microgrids for cooling/clean-air centres & clinics,
      markets & LRT corridors, civic pacts, and early warning ‚Äî offline-first.
    </p>
  </div>
</header>

<main class="wrap">
  <section class="section" data-depth="near">
    <div class="inversion">Hope-first, zero-harm design. Reintegration clause: anyone can rejoin civic life through transparent restitution and pro-social work. <span class="mono">Food ‚Ä¢ Water ‚Ä¢ Energy ‚Ä¢ Health ‚Ä¢ Education ‚Ä¢ Dignity</span></div>
    <div class="toolbar" role="toolbar" aria-label="Quick controls">
      <a class="btn" id="exportState">Export State (JSON)</a>
      <a class="btn" id="importState">Import State</a>
      <a class="btn" id="backupMnemonic">Backup (Mnemonic)</a>
      <a class="btn" id="restoreMnemonic">Restore (Mnemonic)</a>
      <label class="switch"><input type="checkbox" id="darkness" checked/> <span>Night mode</span></label>
      <a class="btn" id="syncGithub">Load Gamification Plugin (GitHub/PRA)</a>
    </div>
    <div class="divider"></div>
    <div class="kpis">
      <div class="kpi"><div class="muted">Households onboarded</div><div class="big" id="kpiHouseholds">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Water points restored</div><div class="big" id="kpiWater">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Stormwater fixes (km)</div><div class="big" id="kpiNetwork">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Cisterns/tanks</div><div class="big" id="kpiTanks">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">UF/RO units online</div><div class="big" id="kpiDesal">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Microgrids online</div><div class="big" id="kpiGrids">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Clinics/community hubs</div><div class="big" id="kpiClinics">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Schools/Learning hubs</div><div class="big" id="kpiSchools">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Community fridges</div><div class="big" id="kpiCold">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Food processors/kitchens</div><div class="big" id="kpiBakeries">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Neighbour pacts</div><div class="big" id="kpiPacts">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Early warnings</div><div class="big" id="kpiEW">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Co-ops registered</div><div class="big" id="kpiCoops">0</div><div class="okline"></div></div>
    </div>
  </section>

  <!-- ====================== CORE MODULES ====================== -->
  <section class="section" data-depth="mid" id="modules">
    <h2>Action Modules (click to expand)</h2>
    <div class="panel">

      <!-- FOOD & SEEDS -->
      <details class="card span-8" open>
        <summary><strong>üåø Urban Food ‚Ä¢ Towers ‚Ä¢ Community Gardens ‚Ä¢ Food Forests</strong></summary>
        <div class="grid">
          <div class="card">
            <h3>Tower/Rooftop Gardens</h3>
            <p>Sub-irrigated planters, wind baffles, snow-load anchors, double-layer row cover. Cold-hardy greens & herbs rotation.</p>
            <button class="btn" data-quest="householdGardens">Add Quest: 3,200 household gardens</button>
          </div>
          <div class="card">
            <h3>Community Food Forests</h3>
            <p>Saskatoon & haskap with apple/pear understory, pollinator lanes along greenways & LRT rights-of-way.</p>
            <button class="btn" data-quest="foodForests">Add Quest: 28 food forests</button>
          </div>
          <div class="card">
            <h3>Hydroponic/Microgreen Pods</h3>
            <p>Pods at libraries & rec centres; low-power lights; nutrient recycling; winter continuity.</p>
            <button class="btn" data-quest="hydroPods">Add Quest: 160 pods</button>
          </div>
          <div class="card">
            <h3>Rain-to-Food Systems</h3>
            <p>Rain barrels ‚Üí drip; leaf-mould hubs; curbside swales feeding edible hedgerows tolerant to de-icing salts.</p>
            <button class="btn" data-quest="rainFood">Add Quest: 110 sites</button>
          </div>
        </div>
      </details>

      <!-- WATER & STORMWATER -->
      <details class="card span-4" open>
        <summary><strong>üíß Water ‚Ä¢ UF/RO ‚Ä¢ Stormwater & WASH</strong></summary>
        <ul class="list-tight">
          <li>Rain capture (cisterns), first-flush, filters, safe storage</li>
          <li>UF/RO for emergency hubs (mobile skids); chlorine residuals</li>
          <li>Bioswales, infiltration galleries, daylighted streams</li>
          <li>Blue-green alleys; sump checks; cross-connection audits</li>
        </ul>
        <button class="btn" data-quest="stormKm">Add Quest: 160 km stormwater fixes</button>
        <button class="btn" data-quest="cisterns">Add Quest: 3,200 cisterns</button>
        <button class="btn" data-quest="waterPoints">Add Quest: 360 taps/showers</button>
      </details>

      <!-- ENERGY -->
      <details class="card span-6" open>
        <summary><strong>‚ö° Energy ‚Ä¢ Microgrids ‚Ä¢ Cooling/Clean-Air Centres</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Site</label><input id="energySite" placeholder="Library / community centre / clinic / tower" />
            <label>Action</label>
            <select id="energyAction">
              <option>PV installed (kWp)</option><option>Battery commissioned (kWh)</option>
              <option>Inverter replaced</option><option>Critical-loads wired</option>
              <option>Clean-air room commissioned</option><option>Cooling room commissioned</option>
            </select>
            <label>Quantity</label><input id="energyQty" type="number" min="0" step="0.1" />
            <button class="btn" id="addEnergy">Log Energy Action</button>
          </div>
          <div class="card">
            <h3>Microgrids & Critical Loads</h3>
            <ul id="energyList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- HEALTH & CLEAN AIR -->
      <details class="card span-6" open>
        <summary><strong>üè• Health ‚Ä¢ Clinics ‚Ä¢ Community Fridges ‚Ä¢ Clean-Air Rooms</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Facility</label><input id="clinicName" placeholder="Clinic / neighbourhood house / senior centre" />
            <label>Action</label>
            <select id="clinicAction">
              <option>Community fridge added</option><option>HEPA/HVAC service</option>
              <option>Medical outreach day</option><option>Cooling room open</option>
              <option>Air quality monitors online</option>
            </select>
            <button class="btn" id="addClinic">Log Facility Action</button>
          </div>
          <div class="card">
            <h3>Facility Actions</h3>
            <ul id="clinicList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- EDUCATION -->
      <details class="card span-6">
        <summary><strong>üìö Education ‚Ä¢ Makers ‚Ä¢ Skills ‚Ä¢ Resilience Hubs</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Hub/School</label><input id="schoolName" placeholder="School / makerspace / library" />
            <label>Program</label>
            <select id="schoolProg">
              <option>Urban gardening</option><option>Electrification & solar</option>
              <option>Air quality & sensors</option><option>First aid & mutual aid</option>
              <option>Biking & cargo logistics</option><option>Water stewardship</option>
            </select>
            <label>Learners enrolled</label><input id="schoolLearners" type="number" min="0" />
            <button class="btn" id="addSchool">Log Education Action</button>
          </div>
          <div class="card">
            <h3>Learning Hubs</h3>
            <ul id="schoolList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- PROCESSING -->
      <details class="card span-6">
        <summary><strong>ü•ñ Local Processing ‚Ä¢ Bakeries ‚Ä¢ Shared Kitchens</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Site</label><input id="bakerySite" placeholder="Community kitchen / bakery / commissary" />
            <label>Action</label>
            <select id="bakeryAction">
              <option>Fridge/freezer serviced</option><option>Electric switchover</option>
              <option>Voucher day executed</option><option>Safety inspection</option>
              <option>Food rescue partnership</option>
            </select>
            <button class="btn" id="addBakery">Log Processing Action</button>
          </div>
          <div class="card">
            <h3>Operational Ledger</h3>
            <ul id="bakeryList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- CORRIDORS -->
      <details class="card span-6">
        <summary><strong>üöä Corridors ‚Ä¢ LRT ‚Ä¢ Greenways ‚Ä¢ River</strong></summary>
        <p>Key flows: <strong>Capital Line</strong> (Clareview ‚áÑ Downtown ‚áÑ South Campus ‚áÑ Century Park), <strong>Metro Line</strong> (NAIT/Blatchford ‚áÑ Downtown), <strong>Valley Line SE</strong> (Downtown ‚áÑ Bonnie Doon ‚áÑ Mill Woods), <strong>Valley Line West</strong> (Downtown ‚áÑ West Edmonton Mall ‚áÑ Lewis Farms), <strong>River Valley trails</strong>, <strong>Yellowhead/Whitemud logistics</strong>.</p>
        <div class="grid">
          <div class="card">
            <label>Route name</label><input id="routeName" placeholder="Capital Line: Downtown ‚Üí Century Park (Cooling/Clean-air shuttles)" />
            <label>Mode</label><select id="routeMode"><option>LRT</option><option>Greenway</option><option>Road</option><option>River</option><option>Bike</option></select>
            <label>Distance (km)</label><input id="routeKm" type="number" min="0" />
            <label>Notes</label><input id="routeNotes" placeholder="waypoints, lift access, detours, alerts" />
            <button class="btn" id="addRoute">Add Route</button>
          </div>
          <div class="card">
            <h3>Routes</h3>
            <ul id="routeList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- MARKET -->
      <details class="card span-6">
        <summary><strong>üìà Price Watch ‚Ä¢ Groceries ‚Ä¢ Fuel ‚Ä¢ Transit</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Market</label>
            <select id="priceTown">
              <option>Downtown</option><option>Oliver</option><option>Strathcona</option><option>Garneau</option>
              <option>Bonnie Doon</option><option>Mill Woods</option><option>Clareview</option><option>NAIT/Blatchford</option>
              <option>West Edmonton</option><option>Jasper Place</option>
            </select>
            <label>Commodity</label>
            <select id="priceCommodity">
              <option>Rice (5kg)</option><option>Milk (L)</option><option>Eggs (dozen)</option>
              <option>Cooking oil (L)</option><option>Diesel (L)</option><option>Petrol (L)</option>
              <option>Transit pass (1-zone)</option><option>HEPA filter (unit)</option><option>Water (18.9L jug)</option>
            </select>
            <label>Price (CAD)</label><input id="priceValue" type="number" min="0" step="0.01" />
            <button class="btn" id="addPrice">Log Price</button>
          </div>
          <div class="card">
            <h3>Signals</h3>
            <ul id="priceSignals" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- DIGITAL COMMS -->
      <details class="card span-6">
        <summary><strong>üì° Digital & Radio ‚Ä¢ Mesh ‚Ä¢ Alerts</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Node</label><input id="radioNode" placeholder="Tower repeater / mesh AP / GMRS node" />
            <label>Action</label>
            <select id="radioAction">
              <option>Mesh AP online</option><option>Repeater serviced</option>
              <option>Community bulletin posted</option><option>SMS hub operational</option>
              <option>Environment Canada mirror check</option>
            </select>
            <button class="btn" id="addRadio">Log Comms Action</button>
          </div>
          <div class="card">
            <h3>Radio & Mesh</h3>
            <ul id="radioList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- GOVERNANCE -->
      <details class="card span-6">
        <summary><strong>üèõÔ∏è Governance ‚Ä¢ Co-ops ‚Ä¢ Audits ‚Ä¢ Grievances</strong></summary>
        <div class="grid">
          <div class="card">
            <label>Community/Co-op</label><input id="govName" placeholder="Tower co-op / gardeners co-op / corridor council" />
            <label>Action</label>
            <select id="govAction">
              <option>Civic charter signed</option><option>Co-op registered</option>
              <option>Public audit held</option><option>Grievance resolved</option>
              <option>Transparency board posted</option>
            </select>
            <button class="btn" id="addGov">Log Governance Action</button>
          </div>
          <div class="card">
            <h3>Civic Ledger</h3>
            <ul id="govList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- PEACE PACTS -->
      <details class="card span-6">
        <summary><strong>ü§ù Neighbour Pacts ‚Ä¢ Cooling ‚Ä¢ Clean-Air ‚Ä¢ Food Rescue</strong></summary>
        <p>‚ÄúCooling rooms, clean-air rooms, and community fridges are neutral; corridors open for care.‚Äù Wayfinding, check-ins, accessibility buddies.</p>
        <div class="grid">
          <div class="card">
            <label>Community</label><input id="pactCommunity" placeholder="Tower / block / strata / street" />
            <label>Signatories</label><input id="pactSigners" placeholder="strata council, tenants, youth, seniors" />
            <label>Terms</label><input id="pactTerms" placeholder="quiet hours, queue fairness, elevator priority, air room rules" />
            <button class="btn" id="addPact">Record Pact</button>
          </div>
          <div class="card">
            <h3>Signed Pacts</h3>
            <ul id="pactList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- EARLY WARNING -->
      <details class="card span-6">
        <summary><strong>‚ö†Ô∏è Early Warning (manual, offline-first)</strong></summary>
        <p class="muted">Enter observations to trigger advisories. Later, connect to official feeds.</p>
        <div class="grid">
          <div class="card">
            <label>Signal</label>
            <select id="ewType">
              <option>Power outage</option><option>Water main break</option><option>Storm / heavy snow</option>
              <option>Urban flood</option><option>Extreme cold window</option><option>Wildfire smoke (PM2.5)</option>
              <option>Freezing rain</option><option>Transit disruption</option><option>Price spike</option>
              <option>Clean-air room capacity</option><option>Cooling room capacity</option>
            </select>
            <label>Severity</label><select id="ewSev"><option>Low</option><option>Moderate</option><option>High</option></select>
            <label>Notes</label><input id="ewNotes" placeholder="What, where, when" />
            <button class="btn" id="addEW">Add Warning</button>
          </div>
          <div class="card">
            <h3>Advisories</h3>
            <ul id="ewList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- KNOWLEDGE & SCRIPTS -->
      <details class="card span-12">
        <summary><strong>üìö Knowledge & Scripts</strong> <span class="tag">planetaryrestorationarchive.com/scripts ‚Ä¢ GitHub loaders</span></summary>
        <p>Paste a GitHub RAW URL or PRA endpoint to load modules (if CORS permits). Keeps the dashboard light but expandable.</p>
        <div class="grid">
          <div class="card">
            <label>Load script (GitHub RAW / PRA)</label>
            <input id="scriptUrl" placeholder="https://raw.githubusercontent.com/..." />
            <button class="btn" id="loadScript">Load</button>
            <p id="scriptStatus" class="muted"></p>
            <pre id="scriptPreview" class="mono" style="white-space:pre-wrap;max-height:220px;overflow:auto"></pre>
          </div>
          <div class="card">
            <h3>Edmonton Cheatsheet</h3>
            <ul class="list-tight">
              <li><span class="tooltip" title="Sub-irrigated planters, wind screens, double row-covers">Rooftop/balcony tactics</span></li>
              <li><span class="tooltip" title="Bioswales, infiltration galleries, daylighting creeks">Stormwater patterns</span></li>
              <li><span class="tooltip" title="PV + battery at libraries/centres for cooling & clean air">Critical microgrids</span></li>
              <li><span class="tooltip" title="River Valley multi-use trails, LRT corridors for last-mile">Bike/transit logistics</span></li>
              <li><span class="tooltip" title="Neighbour pacts around fridges & clean-air rooms">Civic safe zones</span></li>
            </ul>
          </div>
        </div>
      </details>

    </div>
  </section>

  <!-- ====================== GAMIFICATION ENGINE ====================== -->
  <section class="section" data-depth="near" id="game">
    <h2>üéÆ Mycelial Gamification Engine (offline-first)</h2>
    <p class="muted">Track quests, households, virtues, guilds/co-ops, and shared wins. Only dignity-preserving actions count.</p>

    <div class="grid">
      <div class="card">
        <h3>Create Quest</h3>
        <label>Title</label><input id="qTitle" placeholder="Commission 45 clean-air rooms at community hubs" />
        <label>Category</label>
        <select id="qCat">
          <option>Food</option><option>Water</option><option>Soil</option><option>Market</option>
          <option>Logistics</option><option>Health/Cold Chain</option><option>Peace</option><option>Early Warning</option>
          <option>Energy</option><option>Education</option><option>Governance</option><option>Comms</option><option>Desalination</option>
        </select>
        <label>Target value</label><input id="qTarget" type="number" min="1" value="10" />
        <label>Unit</label><input id="qUnit" placeholder="units" />
        <button class="btn" id="qCreate">Create Quest</button>
      </div>

      <div class="card">
        <h3>Active Quests</h3>
        <ul id="qList" class="list-tight"></ul>
      </div>

      <div class="card">
        <h3>Submit Progress</h3>
        <label>Quest</label><select id="qPick"></select>
        <label>Value</label><input id="qValue" type="number" min="0" />
        <label>Household/Team</label><input id="qWho" placeholder="Team / Household ID" />
        <button class="btn" id="qSubmit">Submit</button>
        <p id="qMsg" class="muted"></p>
      </div>

      <div class="card">
        <h3>Leaderboard</h3>
        <ol id="leader" class="list-tight"></ol>
      </div>

      <div class="card">
        <h3>Virtues</h3>
        <p class="muted">Stewardship ‚Ä¢ Care ‚Ä¢ Courage ‚Ä¢ Clarity</p>
        <ul id="virtues" class="list-tight"></ul>
      </div>

      <div class="card">
        <h3>Guilds (Co-ops)</h3>
        <label>Guild Name</label><input id="gName" placeholder="River Valley Resilience Co-op" />
        <button class="btn" id="gCreate">Create Guild</button>
        <ul id="gList" class="list-tight"></ul>
      </div>
    </div>
  </section>

  <!-- ====================== MYCELIAL MAP ====================== -->
  <section class="section" data-depth="far">
    <h2>Mycelial Synergy Map</h2>
    <p class="muted">Nodes are actions; edges show helpful synergies. Hover for hints.</p>
    <canvas id="mycelium" aria-label="Mycelial action network"></canvas>
  </section>

  <section class="section" data-depth="near" id="license">
    <h2>Zero-Harm / Anti-Inversion License Banner</h2>
    <p class="mono">Humanitarian, ecological, and dignity-preserving use only. Any repurposing for coercion or deprivation violates the license spirit.</p>
  </section>

  <footer>
    <div class="divider"></div>
    <p class="mono">Local & offline-first. Add connectors later for live feeds; this file will cache via service worker.</p>
    <p class="mono">Foster + Navi ‚Ä¢ PRA ‚Ä¢ Edmonton Sovereignty ‚Äî Full Reconstruction Edition</p>
  </footer>
</main>

<!-- ====================== JS: Parallax Sky + Engine + DB + Crypto ====================== -->
<script>
/* Parallax constellation sky */
(function(){
  function stars(canvas, count, blurSpread){
    const dpr=Math.min(2, devicePixelRatio||1), ctx=canvas.getContext('2d');
    function resize(){ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; draw(); }
    const pts=[...Array(count)].map(()=>({x:Math.random(), y:Math.random(), r:Math.random()*1.3+.2, a:.35+.65*Math.random()}));
    function draw(){ const w=canvas.width,h=canvas.height; ctx.clearRect(0,0,w,h);
      for(const s of pts){ const x=s.x*w,y=s.y*h;
        ctx.globalAlpha=s.a;
        const g=ctx.createRadialGradient(x,y,0,x,y,s.r*dpr*blurSpread);
        g.addColorStop(0,'rgba(255,255,255,.95)'); g.addColorStop(1,'rgba(255,255,255,0)');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,s.r*dpr,0,Math.PI*2); ctx.fill();
      } ctx.globalAlpha=1;
    }
    addEventListener('resize', resize, {passive:true}); resize();
    return {draw};
  }
  stars(document.getElementById('near-sky'),1800,2.8);
  stars(document.getElementById('sky'),     1200,2.2);
  stars(document.getElementById('deep-sky'), 900,1.8);
  let t=0; (function tick(){ t+=.0025;
    document.querySelector('.nebula').style.transform=`translate3d(${Math.sin(t)*8}px,${Math.cos(t*.6)*6}px,0) rotate(${t*.02}rad)`;
    requestAnimationFrame(tick);
  })();
  addEventListener('scroll', ()=>{ document.documentElement.style.setProperty('--scroll', String(scrollY||0)); }, {passive:true});
})();

/* IndexedDB helper */
const DB = (function(){
  let db; const name='edmonton-sovereignty-v1', ver=1;
  function open(){ return new Promise((res,rej)=>{
    const r = indexedDB.open(name, ver);
    r.onupgradeneeded = e=>{
      const d = e.target.result;
      d.createObjectStore('kv'); // small counters
      for(const store of [
        'prices','routes','pacts','ew','quests','progress','guilds',
        'bakeries','water','irrigation','energy','schools','clinics','radio','governance'
      ]) d.createObjectStore(store,{keyPath:'id', autoIncrement:true});
      d.createObjectStore('virtues',{keyPath:'name'});
      d.createObjectStore('secure',{keyPath:'k'}); // crypto items
    };
    r.onsuccess = ()=>{db=r.result; res();}; r.onerror=()=>rej(r.error);
  });}
  function put(store, value, key){ return tx(store,'readwrite').store.put(value, key).complete }
  function get(store, key){ return tx(store).store.get(key) }
  function all(store){ return new Promise((res,rej)=>{ const t=tx(store), req=t.store.getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error)})}
  function tx(store, mode='readonly'){ const t=db.transaction(store, mode); t.store=t.objectStore(store); t.complete=new Promise((res,rej)=>{t.oncomplete=()=>res(); t.onerror=()=>rej(t.error);}); return t;}
  return {open,put,get,all};
})();

/* Mnemonic mini-kit (PBKDF2 ‚Üí AES-GCM) */
const CryptoKit = (function(){
  const words = "abandon ability able about above absent absorb abstract absurd abuse access accident account accuse achieve acid across act actor adapt add addict address adjust admit adult advance advice aerobic affair afford afraid again age agent agree ahead aim air airport aisle alarm album alcohol alert alien alike alive all alloy alpha alter always amaze among amount amused analyst anchor ancient anger angle angry animal ankle announce annual another answer antenna antique anxiety any apart apology appeal appear apple approve april arch arctic area arena argue arm armed armor army around arrange arrest arrive arrow art artefact artist artwork ask aspect assault asset assist assume athlete atom attack attend attitude attract auction audit august aunt author auto autumn average avocado avoid awake aware away awesome axis baby bachelor bacon badge bag balance balcony ball bamboo banana banner bar barely bargain barrel base basic basket battle beach bean beauty because become beef before begin behave behind believe below belt bench benefit best betray better between beyond bicycle bid bike bind biology bird birth bitter black blade blame blanket blast blend bless blind blood blossom blur blush board boat body boil bomb bone bonus book boost border boring borrow boss bottom bounce bowl box boy bracket brain brand brass brave bread breeze brick bridge brief bright bring brisk broccoli broken bronze broom brother brown brush bubble buddy budget buffalo build bulb bulk bullet bundle burger burst bus business busy butter buyer buzz cabbage cabin cable cactus cage cake call calm camera camp can canal cancel candy cannon canoe canvas canyon capable capital captain car carbon card cargo carpet carry cart case cash casino castle casual cat catalog catch category cattle caught cause caution cave ceiling celery cement census century cereal certain chair chalk champion change chaos chapter charge chase chat cheap check cheese chef cherry chest chicken chief child chimney choice choose chronic chuckle chunk churn cigar cinnamon circle citizen city civil claim clap clarify claw clay clean clerk clever click client cliff climb clinic clip clock clog close cloth cloud clown club clump cluster clutch coach coast coconut code coffee coil coin collect color column combine come comfort comic common company concert conduct confirm congress connect consider control convince cook cool copper copy coral core corn correct cost cotton couch country couple course cousin cover coyote crack cradle craft cram crane crash crater crawl crazy cream credit creek crew cricket crime crisp critic crop cross crouch crowd crucial cruel cruise crumble crunch crush cry crystal cube culture cup cupboard curious current curtain curve cushion custom cute cycle dad damage damp dance danger daring dash daughter dawn day deal debate debris decade december decide decline decorate decrease deer defense define defy degree delay deliver demand demise denial dentist deny depart depend deposit depth deputy derive describe desert design desk despair destroy detail detect develop device devote diagram dial diamond diary dice diesel diet differ digital dignity dilemma dinner dinosaur direct dirt disagree discover disease dish dismiss disorder display distance divert divide divorce dizzy doctor document dog doll dolphin domain donate donkey donor door dose double dove draft dragon drama drastic draw dream dress drift drill drink drip drive drop drum dry duck dumb dune during dust dutch duty dwarf dynamic eager eagle early earn earth easily east easy echo ecology economy edge edit educate effort egg eight either elbow elder electric elegant element elephant elevator elite else embark embody embrace emerge emotion employ empower empty enable enact end endless endorse enemy energy enforce engage engine enhance enjoy enlist enough enrich enroll ensure enter entire entry envelope episode equal equip era erase erode erosion error erupt escape essay essence estate eternal ethics evidence evil evoke evolve exact example excess exchange excite exclude excuse execute exercise exhaust exhibit exile exist exit exotic expand expect expire explain expose express extend extra eye eyebrow fabric".split(" ");
  function randomMnemonic(n=12){ const out=[]; for(let i=0;i<n;i++){ out.push(words[Math.floor(Math.random()*words.length)]);} return out.join(' '); }
  async function deriveKey(mnemonic){
    const enc=new TextEncoder(); const salt=enc.encode('edmonton-sovereignty-v1');
    const keyMaterial=await crypto.subtle.importKey('raw', enc.encode(mnemonic), {name:'PBKDF2'}, false, ['deriveKey']);
    return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:100000, hash:'SHA-256'},
      keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
  }
  async function encryptJson(key, obj){
    const iv=crypto.getRandomValues(new Uint8Array(12));
    const data=new TextEncoder().encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
    return {iv:Array.from(iv), ct:Array.from(new Uint8Array(ct))};
  }
  async function decryptJson(key, pack){
    const iv=new Uint8Array(pack.iv); const ct=new Uint8Array(pack.ct);
    const pt=await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
    return JSON.parse(new TextDecoder().decode(pt));
  }
  return {randomMnemonic, deriveKey, encryptJson, decryptJson};
})();

/* Toast */
function toast(msg){
  const el=document.querySelector('.toast') || (()=>{ const t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); return t;})();
  el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2200);
}

/* KPI rendering */
async function renderKPI(){
  const pairs = [
    ['households','kpiHouseholds'],['water','kpiWater'],['network','kpiNetwork'],['tanks','kpiTanks'],
    ['desal','kpiDesal'],['grids','kpiGrids'],['clinics','kpiClinics'],['schools','kpiSchools'],
    ['bakeries','kpiBakeries'],['cold','kpiCold'],['pacts','kpiPacts'],['ew','kpiEW'],['coops','kpiCoops']
  ];
  for(const [k,id] of pairs){ const v = (await DB.get('kv', k)) || 0; const el = document.getElementById(id);
    if(el) el.textContent = (typeof v==='number'?v:0).toLocaleString();
  }
}
const KPI = {
  async bump(key, by=1){
    const cur = (await DB.get('kv', key)) || 0; await DB.put('kv', Number(cur)+Number(by), key);
    renderKPI();
  }
};

/* ENERGY */
async function addEnergy(){
  const site=document.getElementById('energySite').value.trim();
  const action=document.getElementById('energyAction').value;
  const qty=parseFloat(document.getElementById('energyQty').value||'0');
  if(!site) return toast('Site required');
  await DB.put('energy',{site,action,qty,t:Date.now()});
  const bump = /PV|Battery|Inverter|Critical|clean-air|Cooling/i.test(action) ? 1 : 0.2;
  await KPI.bump('grids', bump);
  if(/clean-air|Cooling/i.test(action)) await KPI.bump('clinics', 1);
  renderEnergy(); toast('Energy action logged.');
}
async function renderEnergy(){
  const data=await DB.all('energy'); const ul=document.getElementById('energyList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.site} ‚Äî ${d.action}${d.qty?` (${d.qty})`:''}`; ul.appendChild(li); });
}

/* EDUCATION */
async function addSchool(){
  const n=document.getElementById('schoolName').value.trim();
  const p=document.getElementById('schoolProg').value;
  const s=parseInt(document.getElementById('schoolLearners').value||'0',10);
  if(!n) return toast('School/Hub required');
  await DB.put('schools',{name:n,prog:p,learners:s,t:Date.now()});
  await KPI.bump('schools',1);
  renderSchools(); toast('Education action logged.');
}
async function renderSchools(){
  const data=await DB.all('schools'); const ul=document.getElementById('schoolList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.name} ‚Äî ${d.prog} ‚Äî ${d.learners||0} learners`; ul.appendChild(li); });
}

/* HEALTH */
async function addClinic(){
  const n=document.getElementById('clinicName').value.trim();
  const a=document.getElementById('clinicAction').value;
  if(!n) return toast('Facility required');
  await DB.put('clinics',{name:n,action:a,t:Date.now()});
  if(/fridge/i.test(a)) await KPI.bump('cold',1);
  await KPI.bump('clinics',1);
  renderClinics(); toast('Facility action logged.');
}
async function renderClinics(){
  const data=await DB.all('clinics'); const ul=document.getElementById('clinicList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.name} ‚Äî ${d.action}`; ul.appendChild(li); });
}

/* Processing */
async function addBakery(){
  const site=document.getElementById('bakerySite').value.trim();
  const action=document.getElementById('bakeryAction').value;
  if(!site) return toast('Site required');
  await DB.put('bakeries',{site,action,t:Date.now()});
  await KPI.bump('bakeries',1);
  if(/fridge|freezer/i.test(action)) await KPI.bump('cold',1);
  renderBakeries(); toast('Logged.');
}
async function renderBakeries(){
  const data=await DB.all('bakeries'); const ul=document.getElementById('bakeryList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.site} ‚Äî ${d.action}`; ul.appendChild(li); });
}

/* Water & Stormwater helpers */
async function logWaterPoint(desc){ await DB.put('water',{desc,t:Date.now()}); await KPI.bump('water',1); }
async function logStormKm(lenKm, notes){ await DB.put('irrigation',{km:lenKm, notes, t:Date.now()}); await KPI.bump('network', Number(lenKm)||0); }

/* ROUTES */
async function addRoute(){
  const name = document.getElementById('routeName').value.trim();
  const mode = document.getElementById('routeMode').value;
  const km = parseFloat(document.getElementById('routeKm').value||'0');
  const notes = document.getElementById('routeNotes').value.trim();
  if(!name || !km) return toast('Enter route + km');
  await DB.put('routes', {name, mode, km, notes, t:Date.now()});
  renderRoutes(); toast('Route added');
}
async function renderRoutes(){
  const data = await DB.all('routes'); const ul=document.getElementById('routeList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.mode} ‚Ä¢ ${d.name} ‚Äî ${d.km} km ‚Ä¢ ${d.notes||''}`; ul.appendChild(li); });
}

/* PACTS */
async function addPact(){
  const c = document.getElementById('pactCommunity').value.trim();
  const s = document.getElementById('pactSigners').value.trim();
  const t = document.getElementById('pactTerms').value.trim();
  if(!c||!s||!t) return toast('Community + signers + terms');
  await DB.put('pacts', {c, s, terms:t, ts:Date.now()}); await KPI.bump('pacts',1);
  renderPacts(); toast('Pact recorded');
}
async function renderPacts(){
  const data = await DB.all('pacts'); const ul=document.getElementById('pactList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.c}: ${d.s} ‚Äî ${d.terms}`; ul.appendChild(li); });
}

/* GOVERNANCE */
async function addGov(){
  const n=document.getElementById('govName').value.trim();
  const a=document.getElementById('govAction').value;
  if(!n) return toast('Community/Co-op required');
  await DB.put('governance',{name:n,action:a,t:Date.now()});
  if(a.includes('Co-op')) await KPI.bump('coops',1);
  renderGov(); toast('Governance action logged.');
}
async function renderGov(){
  const data=await DB.all('governance'); const ul=document.getElementById('govList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.name} ‚Äî ${d.action}`; ul.appendChild(li); });
}

/* DIGITAL COMMS */
async function addRadio(){
  const node=document.getElementById('radioNode').value.trim();
  const action=document.getElementById('radioAction').value;
  if(!node) return toast('Node required');
  await DB.put('radio',{node,action,t:Date.now()});
  renderRadio(); toast('Comms action logged.');
}
async function renderRadio(){
  const data=await DB.all('radio'); const ul=document.getElementById('radioList'); if(!ul) return;
  ul.innerHTML=''; data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.node} ‚Äî ${d.action}`; ul.appendChild(li); });
}

/* Market & Price Watch */
async function addPrice(){
  const town=document.getElementById('priceTown').value;
  const com = document.getElementById('priceCommodity').value;
  const v = parseFloat(document.getElementById('priceValue').value||'0');
  if(!v) return toast('Enter a price.');
  await DB.put('prices', {town, commodity:com, value:v, t:Date.now()});
  analyzePrices(); toast('Logged.');
}
async function analyzePrices(){
  const list = await DB.all('prices');
  const by = {};
  for(const r of list){ const key=r.town+'|'+r.commodity; (by[key] ||= []).push(r.value); }
  const ul = document.getElementById('priceSignals'); if(!ul) return;
  ul.innerHTML='';
  Object.entries(by).forEach(([key, arr])=>{
    const [town, com]=key.split('|'); arr.sort((a,b)=>a-b); const n=arr.length, med=arr[Math.floor(n/2)];
    const last = arr[arr.length-1]; const jump = last>med*1.25;
    const li = document.createElement('li'); li.innerHTML = `<strong>${town}</strong> ‚Äî ${com}: latest ${last.toFixed(2)} ‚Äî ${jump?'<span class="bad">SPIKE</span>':'ok'}`;
    ul.appendChild(li);
  });
}

/* Early Warning */
async function addEW(){
  const type=document.getElementById('ewType').value; const sev=document.getElementById('ewSev').value; const notes=document.getElementById('ewNotes').value;
  await DB.put('ew', {type, sev, notes, t:Date.now()}); await KPI.bump('ew',1);
  renderEW(); toast('Advisory logged');
}
async function renderEW(){
  const data=await DB.all('ew'); const ul=document.getElementById('ewList'); if(!ul) return;
  ul.innerHTML='';
  data.sort((a,b)=>b.t-a.t).slice(0,220).forEach(d=>{
    const li=document.createElement('li');
    const color = d.sev==='High'?'bad': (d.sev==='Moderate'?'warn':'ok');
    li.innerHTML=`<strong class="${color}">${d.sev}</strong> ‚Ä¢ ${d.type} ‚Äî <span class="muted">${d.notes||''}</span>`;
    ul.appendChild(li);
  });
}

/* Gamification core */
const GAME = {
  async init(){
    for (const v of ['Stewardship','Care','Courage','Clarity']){
      if(!(await DB.get('virtues',v))) await DB.put('virtues',{name:v, score:0});
    }
    // seed quests (Edmonton context)
    const seeds = [
      {id:crypto.randomUUID(), title:'Create 3,200 household gardens', category:'Food', target:3200, unit:'gardens', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Build 28 community food forests', category:'Food', target:28, unit:'forests', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Install 160 hydro/microgreen pods', category:'Food', target:160, unit:'pods', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Implement 160 km stormwater fixes', category:'Water', target:160, unit:'km', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Place 3,200 rain cisterns', category:'Water', target:3200, unit:'cisterns', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Open 360 public taps/showers', category:'Water', target:360, unit:'points', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Commission 75 microgrids', category:'Energy', target:75, unit:'grids', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Stand up 45 clean-air rooms', category:'Health/Cold Chain', target:45, unit:'rooms', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Add 50 cooling rooms', category:'Health/Cold Chain', target:50, unit:'rooms', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Launch 28 food-rescue kitchens', category:'Market', target:28, unit:'sites', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Register 65 neighbourhood co-ops', category:'Governance', target:65, unit:'co-ops', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Sign 65 neighbour pacts', category:'Peace', target:65, unit:'pacts', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Issue 210 early warnings', category:'Early Warning', target:210, unit:'alerts', progress:0, t:Date.now()}
    ];
    if((await DB.all('quests')).length===0){ for(const q of seeds){ await DB.put('quests', q); } }
    renderVirtues(); renderQuests(); renderLeader(); renderGuilds();
  },
  async addQuest(q){ await DB.put('quests', q); renderQuests(); toast('Quest created'); }
};
async function renderQuests(){
  const list = await DB.all('quests');
  const ul=document.getElementById('qList'); const pick=document.getElementById('qPick');
  if(!ul || !pick) return;
  ul.innerHTML=''; pick.innerHTML='';
  list.forEach(q=>{
    const done=(q.progress||0); const pct=Math.min(100, Math.round(100*done/(q.target||1)));
    const li=document.createElement('li');
    li.innerHTML = `<strong>${q.title}</strong> (${q.category}) ‚Äî ${done.toLocaleString()}/${q.target.toLocaleString()} ${q.unit} <span class="ribbon">${pct}%</span>`;
    ul.appendChild(li);
    const opt=document.createElement('option'); opt.value=q.id; opt.textContent=q.title; pick.appendChild(opt);
  });
}
async function renderLeader(){
  const prog = await DB.all('progress'); const by={};
  for(const p of prog){ by[p.who] = (by[p.who]||0) + (p.value||0); }
  const arr = Object.entries(by).map(([k,v])=>({who:k, score:v})).sort((a,b)=>b.score-a.score).slice(0,20);
  const ol=document.getElementById('leader'); if(!ol) return; ol.innerHTML='';
  arr.forEach(e=>{ const li=document.createElement('li'); li.textContent = `${e.who} ‚Äî ${e.score}`; ol.appendChild(li); });
}
async function renderVirtues(){
  const v = await DB.all('virtues'); const ul=document.getElementById('virtues'); if(!ul) return; ul.innerHTML='';
  v.forEach(x=>{ const li=document.createElement('li'); li.innerHTML=`<strong>${x.name}</strong> ‚Äî ${x.score}`; ul.appendChild(li); });
}
async function virtueBump(name, by=1){ const v=await DB.get('virtues',name)||{name,score:0}; v.score+=by; await DB.put('virtues',v); renderVirtues(); }

/* Guilds */
async function createGuild(){
  const name=document.getElementById('gName').value.trim(); if(!name) return toast('Name your guild');
  await DB.put('guilds',{name, created:Date.now()}); renderGuilds(); toast('Guild created');
}
async function renderGuilds(){
  const g=await DB.all('guilds'); const ul=document.getElementById('gList'); if(!ul) return; ul.innerHTML='';
  g.forEach(x=>{ const li=document.createElement('li'); li.textContent = x.name; ul.appendChild(li); });
}

/* Quick quest buttons */
document.querySelectorAll('[data-quest]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const map={
      householdGardens:{title:'Create 3,200 household gardens', category:'Food', target:3200, unit:'gardens'},
      foodForests:{title:'Build 28 community food forests', category:'Food', target:28, unit:'forests'},
      hydroPods:{title:'Install 160 hydro/microgreen pods', category:'Food', target:160, unit:'pods'},
      rainFood:{title:'Build 110 rain-to-food systems', category:'Food', target:110, unit:'sites'},
      stormKm:{title:'Implement 160 km stormwater fixes', category:'Water', target:160, unit:'km'},
      cisterns:{title:'Place 3,200 rain cisterns', category:'Water', target:3200, unit:'cisterns'},
      waterPoints:{title:'Open 360 public taps/showers', category:'Water', target:360, unit:'points'}
    };
    const q=map[btn.dataset.quest];
    await GAME.addQuest({id:crypto.randomUUID(), ...q, progress:0, t:Date.now()});
  });
});

/* Quest CRUD */
document.getElementById('qCreate')?.addEventListener('click', async ()=>{
  const title=document.getElementById('qTitle').value.trim();
  const category=document.getElementById('qCat').value;
  const target=parseFloat(document.getElementById('qTarget').value||'1');
  const unit=document.getElementById('qUnit').value||'units';
  if(!title || !target) return toast('Title + target');
  await GAME.addQuest({id:crypto.randomUUID(), title, category, target, unit, progress:0, t:Date.now()});
});
document.getElementById('qSubmit')?.addEventListener('click', async ()=>{
  const id=document.getElementById('qPick').value; const val=parseFloat(document.getElementById('qValue').value||'0');
  const who=(document.getElementById('qWho').value||'anonymous').trim();
  if(!id || !val) return toast('Select quest + value');
  const qs = await DB.all('quests'); const q=qs.find(x=>x.id===id); if(!q) return toast('Quest not found');
  q.progress=(q.progress||0)+val; await DB.put('quests', q);
  await DB.put('progress', {quest:id, value:val, who, t:Date.now()});
  document.getElementById('qMsg').textContent=`Recorded ${val} ${q.unit} for ${who}`;

  // Virtues
  if(['Water','Peace','Health/Cold Chain'].includes(q.category)) await virtueBump('Care',1);
  if(['Food','Soil','Market','Energy','Education','Governance','Desalination'].includes(q.category)) await virtueBump('Stewardship',1);
  if(['Early Warning','Logistics','Comms'].includes(q.category)) await virtueBump('Clarity',1);

  // KPI heuristics
  if(/household|garden|balcony|rooftop|pod|food forest|plot/i.test(q.title)) KPI.bump('households', Math.max(1,val));
  if(/storm|stormwater|pipe|network|swale|greenway|drain/i.test(q.title)) KPI.bump('network', Math.max(1,val));
  if(/cistern|tank|barrel/i.test(q.title)) KPI.bump('tanks', Math.max(1,val));
  if(/tap|shower|water/i.test(q.title)) KPI.bump('water', Math.max(1,val));
  if(/microgrid|pv|battery|inverter|clean-air|cooling/i.test(q.title)) KPI.bump('grids', Math.max(1,val));
  if(/clinic|facility|fridge|freezer|clean-air|cooling/i.test(q.title)) KPI.bump('clinics', Math.max(1,val));
  if(/fridge|freezer|cold/i.test(q.title)) KPI.bump('cold', Math.max(1,val));
  if(/pact|neighbour/i.test(q.title)) KPI.bump('pacts', Math.max(1,val));
  if(/alert|warning/i.test(q.title)) KPI.bump('ew', Math.max(1,val));
  if(/school|hub|makerspace|learning/i.test(q.title)) KPI.bump('schools', Math.max(1,val));
  if(/co-?op|cooperative|charter|audit|grievance/i.test(q.title)) KPI.bump('coops', Math.max(1,val));
  if(/bakery|kitchen|processing/i.test(q.title)) KPI.bump('bakeries', Math.max(1,val));

  renderQuests(); renderLeader();
});

/* Wire UI events */
document.getElementById('addPrice')?.addEventListener('click', addPrice);
document.getElementById('addRoute')?.addEventListener('click', addRoute);
document.getElementById('addPact')?.addEventListener('click', addPact);
document.getElementById('addEW')?.addEventListener('click', addEW);
document.getElementById('addBakery')?.addEventListener('click', addBakery);
document.getElementById('gCreate')?.addEventListener('click', createGuild);
document.getElementById('addEnergy')?.addEventListener('click', addEnergy);
document.getElementById('addSchool')?.addEventListener('click', addSchool);
document.getElementById('addClinic')?.addEventListener('click', addClinic);
document.getElementById('addRadio')?.addEventListener('click', addRadio);
document.getElementById('addGov')?.addEventListener('click', addGov);

/* GitHub / PRA script loader */
document.getElementById('loadScript')?.addEventListener('click', async ()=>{
  const url=document.getElementById('scriptUrl').value.trim();
  if(!url) return toast('Paste a URL');
  const status=document.getElementById('scriptStatus'); const pre=document.getElementById('scriptPreview');
  status.textContent='Fetching‚Ä¶';
  try{
    const res=await fetch(url, {mode:'cors'});
    const txt=await res.text();
    pre.textContent = txt.slice(0, 6000);
    status.textContent='Loaded. (Preview truncated)';
    if(/register\s*\(/.test(txt)){
      const fn = new Function('dashboard', txt + '\n//# sourceURL=external-script.js');
      fn(window.DASHBOARD_API); toast('Executed plugin');
    }else{
      toast('Loaded script. No register() found ‚Äî kept as reference.');
    }
  }catch(e){ status.textContent='Failed to load (CORS or network)'; }
});
window.DASHBOARD_API = {
  addBadge(b){ const ul=document.getElementById('virtues'); if(!ul) return; const li=document.createElement('li'); li.innerHTML=`üèÖ <strong>${b.name}</strong> ‚Äî ${b.desc||''}`; ul.appendChild(li); },
  addMetric(name, fn){ DASHBOARD_API[name]=fn; },
  onProgress(cb){ DASHBOARD_API._onProg=cb; },
  award(who, what){ toast(`${who} earned ${what}`) },
  ui:{ toast, addPanel(html){ const sec=document.getElementById('game'); if(!sec) return; const div=document.createElement('div'); div.className='card'; div.innerHTML=html; sec.querySelector('.grid').appendChild(div); } }
};
document.getElementById('syncGithub')?.addEventListener('click', ()=>{
  const u = prompt('Paste GitHub RAW/PRA URL of your gamification engine (register({...}))');
  if(u){ document.getElementById('scriptUrl').value=u; document.getElementById('loadScript').click(); }
});

/* Export/Import state */
document.getElementById('exportState')?.addEventListener('click', async ()=>{
  const out = {
    kv: {
      households: await DB.get('kv','households')||0, water: await DB.get('kv','water')||0,
      network: await DB.get('kv','network')||0, tanks: await DB.get('kv','tanks')||0,
      desal: await DB.get('kv','desal')||0, grids: await DB.get('kv','grids')||0, clinics: await DB.get('kv','clinics')||0,
      schools: await DB.get('kv','schools')||0, bakeries: await DB.get('kv','bakeries')||0, cold: await DB.get('kv','cold')||0,
      pacts: await DB.get('kv','pacts')||0, ew: await DB.get('kv','ew')||0, coops: await DB.get('kv','coops')||0
    },
    prices: await DB.all('prices'), routes: await DB.all('routes'),
    pacts: await DB.all('pacts'), ew: await DB.all('ew'), quests: await DB.all('quests'),
    progress: await DB.all('progress'), guilds: await DB.all('guilds'), bakeries: await DB.all('bakeries'),
    water: await DB.all('water'), irrigation: await DB.all('irrigation'),
    energy: await DB.all('energy'), schools: await DB.all('schools'),
    clinics: await DB.all('clinics'), radio: await DB.all('radio'), governance: await DB.all('governance'),
    virtues: await DB.all('virtues')
  };
  const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='edmonton-sovereignty-state.json'; a.click();
});
document.getElementById('importState')?.addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async ()=>{ const file=inp.files[0]; if(!file) return;
    const txt=await file.text(); const data=JSON.parse(txt);
    for(const k of ['prices','routes','pacts','ew','quests','progress','guilds','bakeries','water','irrigation','energy','schools','clinics','radio','governance','virtues']){
      for(const r of (data[k]||[])) await DB.put(k,r);
    }
    const kv=data.kv||{}; for(const [k,v] of Object.entries(kv)) await DB.put('kv', v, k);
    renderAll(); toast('State imported');
  };
  inp.click();
});

/* Mnemonic backup/restore (encrypts the exported JSON) */
document.getElementById('backupMnemonic')?.addEventListener('click', async ()=>{
  const mnemonic = CryptoKit.randomMnemonic(12);
  const key = await CryptoKit.deriveKey(mnemonic);
  const out = {
    kv: {
      households: await DB.get('kv','households')||0, water: await DB.get('kv','water')||0,
      network: await DB.get('kv','network')||0, tanks: await DB.get('kv','tanks')||0,
      desal: await DB.get('kv','desal')||0, grids: await DB.get('kv','grids')||0, clinics: await DB.get('kv','clinics')||0,
      schools: await DB.get('kv','schools')||0, bakeries: await DB.get('kv','bakeries')||0, cold: await DB.get('kv','cold')||0,
      pacts: await DB.get('kv','pacts')||0, ew: await DB.get('kv','ew')||0, coops: await DB.get('kv','coops')||0
    },
    prices: await DB.all('prices'), routes: await DB.all('routes'),
    pacts: await DB.all('pacts'), ew: await DB.all('ew'), quests: await DB.all('quests'),
    progress: await DB.all('progress'), guilds: await DB.all('guilds'), bakeries: await DB.all('bakeries'),
    water: await DB.all('water'), irrigation: await DB.all('irrigation'),
    energy: await DB.all('energy'), schools: await DB.all('schools'),
    clinics: await DB.all('clinics'), radio: await DB.all('radio'), governance: await DB.all('governance'),
    virtues: await DB.all('virtues')
  };
  const pack = await CryptoKit.encryptJson(key, out);
  await DB.put('secure', {k:'mnemonic-pack', v:pack});
  await DB.put('secure', {k:'mnemonic-words', v:mnemonic});
  toast('Encrypted backup saved to IndexedDB. WRITE DOWN THESE WORDS:');
  alert(`Write this mnemonic down (offline-safe):\n\n${mnemonic}\n\nKeep it secret. It unlocks your local data backup.`);
});
document.getElementById('restoreMnemonic')?.addEventListener('click', async ()=>{
  const words = prompt('Enter your 12-word mnemonic to restore:');
  if(!words) return;
  try{
    const key = await CryptoKit.deriveKey(words.trim());
    const pack = (await DB.get('secure','mnemonic-pack'))?.v;
    if(!pack) return toast('No backup pack found.');
    const data = await CryptoKit.decryptJson(key, pack);
    for(const k of ['prices','routes','pacts','ew','quests','progress','guilds','bakeries','water','irrigation','energy','schools','clinics','radio','governance','virtues']){
      for(const r of (data[k]||[])) await DB.put(k,r);
    }
    const kv=data.kv||{}; for(const [k,v] of Object.entries(kv)) await DB.put('kv', v, k);
    renderAll(); toast('Mnemonic restore complete');
  }catch(e){ toast('Restore failed. Check words.'); }
});

/* Mycelial map */
(function(){
  const c=document.getElementById('mycelium'); if(!c) return; const ctx=c.getContext('2d');
  function resize(){ const dpr=Math.min(2,devicePixelRatio||1); c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); draw(); }
  addEventListener('resize', resize, {passive:true}); resize();
  let nodes=[]; let links=[];
  async function rebuild(){
    const qs=await DB.all('quests');
    nodes = qs.slice(0,60).map((q,i)=>({id:q.id, x:60+ (i*27)% (c.clientWidth-120), y:60+ ((i*53)% (c.clientHeight-120)), r:4+Math.min(16, Math.max(2, (q.progress||0)/(q.target||1)*16)), cat:q.category, title:q.title}));
    links = [];
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        if(nodes[i].cat===nodes[j].cat || /(Water|Energy)/.test(nodes[i].cat+nodes[j].cat)){
          if(Math.random()<0.06) links.push({a:i,b:j});
        }
      }
    }
    draw();
  }
  function draw(){
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    ctx.globalAlpha=0.25;
    links.forEach(L=>{ const a=nodes[L.a], b=nodes[L.b]; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle='#7af5e5'; ctx.lineWidth=1; ctx.stroke(); });
    ctx.globalAlpha=1;
    nodes.forEach(n=>{ ctx.beginPath(); ctx.arc(n.x,n.y,n.r,0,Math.PI*2); ctx.fillStyle='#a78bfa'; ctx.fill(); });
  }
  c.addEventListener('mousemove', e=>{
    const rect=c.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
    let hovered=null;
    for(const n of nodes){ const dx=n.x-x, dy=n.y-y; if(dx*dx+dy*dy<(n.r+4)*(n.r+4)){ hovered=n; break; } }
    c.title = hovered ? `${hovered.title}` : 'Mycelial action network';
  });
  DB.open().then(rebuild);
  window.addEventListener('storage', rebuild);
  window.rebuildMycelium = rebuild;
})();

/* Theme toggle */
document.getElementById('darkness')?.addEventListener('change', (e)=>{
  document.documentElement.style.colorScheme = e.target.checked ? 'dark' : 'light';
});

/* Render-all */
async function renderAll(){
  await renderKPI();
  renderEnergy(); renderSchools(); renderClinics(); renderBakeries();
  renderRoutes(); renderPacts(); renderGov(); renderRadio(); renderEW();
  renderQuests(); renderLeader(); renderVirtues(); renderGuilds();
  if(window.rebuildMycelium) window.rebuildMycelium();
}

/* Init */
(async function init(){
  await DB.open();
  await GAME.init();
  await renderAll();
  // Service worker (optional, file-local)
  if('serviceWorker' in navigator){
    try{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }catch(_){}
  }
  toast('Edmonton dashboard ready ‚Äî offline-first.');
})();
</script>
</body>
</html>

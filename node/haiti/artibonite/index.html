<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PRA Water Sovereignty Guide — Haiti (Artibonite &amp; Sud)</title>
<meta name="description" content="Ultra‑longform Haiti water sovereignty guide with local fabrication blueprints, IndexedDB offline ledgers, Habitica tasks, WebLLM advisor, and a photorealistic morphing‑constellations UI." />
<link rel="canonical" href="https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid/haiti/water-sovereignty/index.html" />
<meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />

<!-- Open Graph -->
<meta property="og:type" content="article" />
<meta property="og:title" content="PRA Water Sovereignty — Haiti (Artibonite & Sud)" />
<meta property="og:description" content="Deployment‑ready water sovereignty: rain capture, gravity lines, shallow‑well rehab, chlorine kiosks, biosand filters; with local sourcing & DIY fabrication." />
<meta property="og:image" content="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'><rect fill='%23060b12' width='100%' height='100%'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23b7f4ff' font-family='system-ui' font-size='46'>PRA • Haiti Water Sovereignty</text></svg>" />
<meta property="og:url" content="https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid/haiti/water-sovereignty/index.html" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="PRA Water Sovereignty — Haiti" />
<meta name="twitter:description" content="Local innovation + DIY blueprints. IndexedDB offline ledgers, Habitica, WebLLM." />
<meta name="twitter:image" content="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'><rect fill='%23060b12' width='100%' height='100%'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23b7f4ff' font-family='system-ui' font-size='46'>PRA • Haiti Water Sovereignty</text></svg>" />

<!-- JSON-LD using requested presentation schema -->
<script type="application/ld+json">
{
  "@context": "https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid",
  "@type": "PRAHybridGuide",
  "name": "PRA Water Sovereignty Guide — Haiti (Artibonite & Sud)",
  "version": "1.0",
  "jurisdiction": "HT",
  "regions": ["Artibonite Valley","Sud Department"],
  "focus": ["Water sovereignty","Rain capture","Gravity lines","Well rehab","Chlorination kiosks","Biosand"],
  "author": {"@type":"Organization","name":"Planetary Restoration Archive"},
  "license": "CC-BY-4.0",
  "datePublished": "2025-10-21",
  "keywords": ["Haiti","Artibonite","Sud","rain tank","first-flush","ferrocement","rope pump","biosand","chlorination","MonCash","IndexedDB","WebLLM","Habitica"]
}
</script>

<style>
:root{
  --bg:#060a12; --fg:#e9f6ff; --dim:#a9bed0; --accent:#72d0ff;
  --panel: rgba(12,18,28,.62); --glass: rgba(14,22,36,.55); --border: rgba(140,190,240,.25);
  --ui: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;
  --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Ubuntu Mono,Consolas,monospace;
  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--ui);line-height:1.6}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
header.hero{position:relative;min-height:58vh;display:grid;place-items:center;overflow:hidden}
#stars,#constel{position:absolute;inset:0;width:100%;height:100%;display:block}
.hero-inner{position:relative;z-index:2;text-align:center;padding:4rem 1rem;max-width:1160px;
  background: radial-gradient(1200px 600px at 50% -10%, rgba(114,208,255,0.16), transparent 70%);
}
h1{margin:0 0 .4rem 0;font-weight:900;letter-spacing:.2px;font-size: clamp(1.8rem, 4vw, 3.2rem)}
.sub{color:var(--dim);margin:.25rem 0 .75rem 0}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.18rem .6rem;margin-right:.3rem;color:var(--dim)}
.cta-row{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center}
.pill{background:rgba(114,208,255,.18);border:1px solid var(--border);padding:.28rem .6rem;border-radius:999px}
button,input,select,textarea{background:#0b1320;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:.55rem .7rem;font:inherit}
button{cursor:pointer} .small{font-size:.92rem;color:var(--dim)}
.grid{display:grid;gap:1rem}
@media(min-width:900px){.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:1fr 1fr 1fr}}
.panel{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:1rem 1rem .6rem;margin:1rem auto;max-width:1160px}
.panel h2,.panel h3{margin-top:.2rem}
.note{border-left:3px solid var(--accent);padding-left:.8rem;margin:.6rem 0}
.warnbox{border-left:3px solid var(--warn);background:rgba(245,158,11,.08);padding:.6rem .8rem;border-radius:10px}
.okbox{border-left:3px solid var(--good);background:rgba(34,197,94,.08);padding:.6rem .8rem;border-radius:10px}
.table{width:100%;border-collapse:collapse;margin:.3rem 0 .9rem}
.table th,.table td{border:1px dashed var(--border);padding:.45rem .5rem;vertical-align:top} .table th{text-align:left;color:var(--dim)}
nav.megatop{position:sticky;top:0;z-index:4;backdrop-filter:saturate(1.2) blur(6px);
  background:linear-gradient(to bottom,rgba(6,10,18,.92),rgba(6,10,18,.70));border-bottom:1px solid var(--border)}
nav.megatop .wrap{display:flex;gap:.6rem;overflow:auto;padding:.5rem .8rem;align-items:center}
nav.megatop a.drop{white-space:nowrap;padding:.38rem .7rem;border:1px solid var(--border);border-radius:999px}
.mega{position:absolute;left:0;right:0;transform-origin:50% 0;transform:perspective(1000px) rotateX(-12deg) translateY(-6px) scale(.98);
  opacity:0;pointer-events:none;transition:all .35s cubic-bezier(.2,.7,.2,1);background:linear-gradient(180deg,rgba(20,28,44,.96),rgba(20,28,44,.80));
  border-bottom:1px solid var(--border);box-shadow:0 30px 80px rgba(0,0,0,.35)}
.mega.open{opacity:1;pointer-events:auto;transform:perspective(1000px) rotateX(0) translateY(0) scale(1)}
.mega .inner{max-width:1160px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
@media(min-width:900px){.mega .inner{grid-template-columns:2fr 1fr}}
.parallax-layer{position:absolute;inset:auto 0 0 0;height:40vh;background:
  radial-gradient(800px 400px at 50% -10%, rgba(114,208,255,0.08), transparent 70%);
  transform:translateZ(0)}
footer.footer{text-align:center;color:var(--dim);padding:2rem 0 4rem}
.mono{font-family:var(--mono)}
/* dropdown toggles */
.toggle{display:inline-flex;align-items:center;gap:.45rem}
.toggle svg{width:16px;height:16px;opacity:.8;transition:transform .25s}
.toggle[aria-expanded="true"] svg{transform:rotate(180deg)}
/* gallery cards */
.card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:.6rem}
.card img{display:block;width:100%;height:auto;border-radius:10px}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0}
.kpi{display:flex;gap:.8rem;flex-wrap:wrap}
.kpi div{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;padding:.6rem .8rem}
.sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px}
/* dropdown menu content labels */
.tag{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.18rem .6rem;margin:.15rem;color:var(--dim)}
/* sticky mini-header inside sections */
.sticky-head{position:sticky;top:3.2rem;z-index:1;background:rgba(6,10,18,.75);backdrop-filter:blur(6px);border:1px solid var(--border);
  border-radius:10px;padding:.35rem .6rem;margin:-.3rem 0 .6rem}
</style>
</head>
<body>
<header class="hero" role="banner" aria-label="Photorealistic morphing‑constellations header">
  <canvas id="stars" aria-hidden="true"></canvas>
  <canvas id="constel" aria-hidden="true"></canvas>
  <div class="hero-inner">
    <h1>PRA Water Sovereignty — Haiti <span class="badge">Artibonite &amp; Sud</span></h1>
    <p class="sub">Rain capture • Gravity lines • Shallow‑well rehab • Chlorination kiosks • Biosand • Local fabrication &amp; sourcing — fully offline‑capable with IndexedDB</p>
    <div class="cta-row" role="group" aria-label="Quick actions">
      <a href="#exec" class="pill">Executive Intent</a>
      <a href="#modules" class="pill">Modules</a>
      <a href="#ledger" class="pill">Open Water Ledger</a>
      <a href="#advisor" class="pill">Start Local Advisor</a>
    </div>
  </div>
  <div class="parallax-layer" aria-hidden="true"></div>
</header>

<nav class="megatop" role="navigation" aria-label="Main">
  <div class="wrap">
    <a href="#exec" class="drop">Overview</a>
    <button class="drop toggle" data-mega="mega-water" aria-expanded="false" aria-controls="mega-water">
      Water Systems
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
    </button>
    <button class="drop toggle" data-mega="mega-fab" aria-expanded="false" aria-controls="mega-fab">
      Fabrication &amp; Sourcing
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
    </button>
    <button class="drop toggle" data-mega="mega-ledger" aria-expanded="false" aria-controls="mega-ledger">
      Ledgers &amp; Uploads
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
    </button>
    <button class="drop toggle" data-mega="mega-tools" aria-expanded="false" aria-controls="mega-tools">
      Calculators &amp; Advisor
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
    </button>
  </div>
  <!-- Mega: Water -->
  <div id="mega-water" class="mega" role="region" aria-label="Water Systems dropdown">
    <div class="inner">
      <div>
        <h3>Deployment modules</h3>
        <div class="tag">Roof rain capture</div>
        <div class="tag">First‑flush diverter</div>
        <div class="tag">Ferrocement / IBC / drum tanks</div>
        <div class="tag">Gravity lines &amp; standpipes</div>
        <div class="tag">Shallow‑well rehab</div>
        <div class="tag">Biosand filters</div>
        <div class="tag">Chlorination kiosks</div>
        <div class="tag">SODIS &amp; protective storage</div>
      </div>
      <div>
        <h4 class="small">Jump</h4>
        <p><a href="#module-rain">Rain capture</a> · <a href="#module-gravity">Gravity lines</a> · <a href="#module-well">Well rehab</a> · <a href="#module-biosand">Biosand</a> · <a href="#module-chlorkiosk">Chlorine kiosk</a></p>
      </div>
    </div>
  </div>
  <!-- Mega: Fabrication -->
  <div id="mega-fab" class="mega" role="region" aria-label="Fabrication dropdown">
    <div class="inner">
      <div>
        <h3>Local sourcing &amp; DIY</h3>
        <p class="small">Prefer Haitian markets &amp; workshops: rebar, wire, PVC/HDPE, food‑grade drums, IBC totes, sharp sand, pea gravel, cement, tin sheet, lumber, tire inner tubes, bicycle parts, buckets.</p>
        <div class="tag">Gutter from sheet‑metal</div>
        <div class="tag">PVC first‑flush</div>
        <div class="tag">Ferrocement tank</div>
        <div class="tag">Rope pump</div>
        <div class="tag">Biosand mold</div>
        <div class="tag">Tap stand box</div>
      </div>
      <div>
        <h4 class="small">Jump</h4>
        <p><a href="#fab-gutter">Gutter build</a> · <a href="#fab-fflush">First‑flush build</a> · <a href="#fab-ferro">Ferrocement tank</a> · <a href="#fab-ropepump">Rope pump</a> · <a href="#fab-biosand">Biosand mold</a></p>
      </div>
    </div>
  </div>
  <!-- Mega: Ledger & Uploads -->
  <div id="mega-ledger" class="mega" role="region" aria-label="Ledgers dropdown">
    <div class="inner">
      <div>
        <h3>Offline‑first data</h3>
        <div class="tag">Water assets</div><div class="tag">MEL metrics</div><div class="tag">Discoveries</div><div class="tag">Images</div><div class="tag">Alternatives</div>
        <p class="small">Data stored in your browser with IndexedDB. Export/Import JSON; images kept as Blobs with previews.</p>
      </div>
      <div>
        <h4 class="small">Jump</h4>
        <p><a href="#ledger">Ledgers</a> · <a href="#uploads">Uploads</a> · <a href="#gallery">Gallery</a></p>
      </div>
    </div>
  </div>
  <!-- Mega: Tools & Advisor -->
  <div id="mega-tools" class="mega" role="region" aria-label="Tools dropdown">
    <div class="inner">
      <div>
        <h3>Field tools</h3>
        <div class="tag">Rain yield calc</div>
        <div class="tag">Pipe friction</div>
        <div class="tag">Chlorine residual (target)</div>
        <div class="tag">Habitica tasks</div>
        <div class="tag">WebLLM advisor</div>
      </div>
      <div>
        <h4 class="small">Jump</h4>
        <p><a href="#calc-rain">Rain calc</a> · <a href="#calc-friction">Friction</a> · <a href="#calc-chlorine">Chlorine</a> · <a href="#habitica">Habitica</a> · <a href="#advisor">Advisor</a></p>
      </div>
    </div>
  </div>
</nav>

<main id="content" role="main" aria-label="Haiti Water Sovereignty Guide">
  <section id="exec" class="panel">
    <div class="sticky-head small mono">0) Executive intent</div>
    <p><strong>Objective:</strong> Stand up two water nodes (Artibonite + Sud) that deliver safe, reliable community water within 90–180 days via rain capture, gravity distribution, shallow‑well rehab, point‑of‑use treatment, and transparent, locally governed kiosks.</p>
    <div class="kpi">
      <div><strong>50–100</strong><br><span class="small">HH served / node (starter)</span></div>
      <div><strong>30–60 L/HH/d</strong><br><span class="small">Target access (laddered)</span></div>
      <div><strong>≤10 min</strong><br><span class="small">Max queue time aim</span></div>
      <div><strong>0.2–0.5 mg/L</strong><br><span class="small">Free chlorine after 30 min (if chlorinated)</span></div>
    </div>
    <div class="warnbox small">Use local public‑health guidance for disinfection. Field test residual; don’t rely on rules of thumb alone.</div>
  </section>

  <section id="modules" class="panel">
    <h2>1) Modules (design &amp; SOPs)</h2>
    <div class="grid cols-2">
      <div id="module-rain">
        <h3>Roof rain capture</h3>
        <ul>
          <li>Leaf screen → gutter → first‑flush → tank → tapstand (optional sand pre‑filter).</li>
          <li>Tank choices: food‑grade drums, IBC totes, ferrocement, or masonry + liner.</li>
          <li>Distribution: gravity (elevated stand) or bucket‑fill; keep inlet/outlet screens.</li>
        </ul>
      </div>
      <div id="module-gravity">
        <h3>Gravity lines</h3>
        <ul>
          <li>HDPE or PVC main, ≥1% slope if possible, air‑release at high points.</li>
          <li>Tapstands in concrete/stone boxes; drain to soak pit or garden.</li>
        </ul>
      </div>
      <div id="module-well">
        <h3>Shallow‑well rehab</h3>
        <ul>
          <li>Pump out, de‑sludge, scrub casing; reconstruct sanitary seal and apron.</li>
          <li>Shock chlorinate, flush, then test; rope pump or handpump per depth.</li>
        </ul>
      </div>
      <div id="module-biosand">
        <h3>Biosand (household/cluster)</h3>
        <ul>
          <li>Concrete or HDPE shell; graded media (fine sand + pea gravel); diffuser plate; safe outlet.</li>
          <li>Commission with daily dosing; protect from contamination; periodic swirl‑cleaning.</li>
        </ul>
      </div>
      <div id="module-chlorkiosk">
        <h3>Chlorination kiosk</h3>
        <ul>
          <li>Batch or drip dosing; test strips to verify 0.2–0.5 mg/L after 30 min contact.</li>
          <li>Keep logs: batch ID, date, dose, operator, residual result, user complaints.</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="fab" class="panel">
    <h2>2) Local innovation, sourcing &amp; DIY fabrication</h2>
    <div class="grid cols-2">
      <div id="fab-gutter">
        <h3>Sheet‑metal gutter (tin/aluminum)</h3>
        <ol>
          <li>Cut 2.4–3.0&nbsp;m lengths from 0.4–0.6&nbsp;mm sheet; mark thirds.</li>
          <li>Fold on wood form: bottom 100&nbsp;mm; sides 60–70&nbsp;mm; hem edges inward to stiffen.</li>
          <li>Hangers from strap or wire every 60&nbsp;cm; fall at ~2–5&nbsp;mm/m.</li>
          <li>Seal seams with bitumen or silicone; paint if coastal.</li>
        </ol>
        <p class="small">Sourcing: sheet‑metal stalls, roofing shops, recycled roofing offcuts; screws, wire, bitumen, silicone at hardware markets.</p>
      </div>
      <div id="fab-fflush">
        <h3>First‑flush diverter (PVC)</h3>
        <ol>
          <li>Vertical PVC 75–110&nbsp;mm with end‑cap; drill cap for drain screw or ball‑valve.</li>
          <li>Install a floating ball (table‑tennis or rubber) in T‑junction: it seals when pipe fills.</li>
          <li>Add outlet to tank after diverter; size diverter volume ≈ 0.5–1&nbsp;L/m² roof (adjust to debris load).</li>
        </ol>
      </div>
      <div id="fab-ferro">
        <h3>Ferrocement tank (3–10&nbsp;m³)</h3>
        <ol>
          <li>Base: compacted subgrade + 10&nbsp;cm concrete pad with mesh; include drain stub.</li>
          <li>Armature: rebar ribs (8&nbsp;mm) + chicken wire (two layers) tied with binding wire.</li>
          <li>Plaster: multiple thin coats (1:2.5 cement:sand) inside and out; keep damp for 7&nbsp;days.</li>
          <li>Roof: light ferro dome or timber lid with insect‑screened vent.</li>
        </ol>
        <p class="small">Sourcing: sharp sand, cement, rebar, wire, plasticizer (optional), HDPE fittings, insect screen.</p>
      </div>
      <div id="fab-ropepump">
        <h3>Rope pump (well 5–25&nbsp;m)</h3>
        <ol>
          <li>Head: bicycle crank + flywheel; PVC riser; guide pulley at bottom (stainless/HDPE).</li>
          <li>Rope with spaced pistons: cut rubber disks from inner tubes; sandwich with washers; knot spacers.</li>
          <li>Seat well with sanitary seal; apron with fall; drainage channel to soak pit.</li>
        </ol>
        <p class="small">Sourcing: bicycle parts, PVC, inner tubes, washers, bearings, timber/metal frame.</p>
      </div>
      <div id="fab-biosand">
        <h3>Biosand filter mold (community re‑use)</h3>
        <ol>
          <li>Build split mold (plywood + bolts) sized ~0.9–1.0&nbsp;m tall; 0.3–0.35&nbsp;m square internal.</li>
          <li>Pour 1:2.5 concrete; vibrate; cure 7&nbsp;days; smooth edges.</li>
          <li>Media: wash and grade fine sand (effective size ~0.15–0.35&nbsp;mm) &amp; pea gravel.</li>
        </ol>
      </div>
    </div>
    <div class="okbox small">Document every local tweak in “Discoveries” with photos and part references. Share via Export JSON.</div>
  </section>

  <section id="ledger" class="panel">
    <h2>3) IndexedDB: Water assets &amp; MEL</h2>
    <div class="grid cols-2">
      <div>
        <h3>Add water asset</h3>
        <label>ID<br><input id="wa-id" placeholder="W-2025-001"></label><br/>
        <label>Type<br>
          <select id="wa-type">
            <option>Rain tank</option><option>Gutter</option><option>First-flush</option>
            <option>Gravity line</option><option>Tapstand</option><option>Shallow well</option>
            <option>Rope pump</option><option>Biosand</option><option>Chlorine kiosk</option>
          </select>
        </label><br/>
        <label>Location (free text)<br><input id="wa-loc" placeholder="Local landmark / communal section"></label><br/>
        <label>Notes<br><textarea id="wa-notes" rows="4" placeholder="Capacity, material, operator, issues…"></textarea></label><br/>
        <div class="toolbar">
          <button id="wa-add" class="pill">Add</button>
          <button id="wa-reset">Reset</button>
        </div>
      </div>
      <div>
        <h3>Inventory</h3>
        <div class="toolbar">
          <button id="wa-refresh">Refresh</button>
          <button id="db-export">Export JSON</button>
          <label class="pill">Import JSON <input id="db-import" type="file" accept="application/json" class="sr-only"></label>
        </div>
        <table class="table" id="wa-table">
          <thead><tr><th>ID</th><th>Type</th><th>Location</th><th>Notes</th><th>Del</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <h3>MEL quick log</h3>
    <div class="grid cols-3">
      <div>
        <label>Households served<br><input id="mel-hh" type="number" min="0" step="1" placeholder="0"></label>
      </div>
      <div>
        <label>Avg queue time (min)<br><input id="mel-queue" type="number" min="0" step="1" placeholder="0"></label>
      </div>
      <div>
        <label>Residual free chlorine (mg/L)<br><input id="mel-fc" type="number" min="0" step=".01" placeholder="0.3"></label>
      </div>
    </div>
    <div class="toolbar">
      <button id="mel-save" class="pill">Save MEL snapshot</button>
      <button id="mel-list">List</button>
      <button id="mel-clear" class="warn">Clear</button>
    </div>
    <ul id="mel-rows"></ul>
  </section>

  <section id="calc" class="panel">
    <h2>4) Field calculators</h2>
    <div class="grid cols-3">
      <div id="calc-rain" class="card">
        <h3>Rain yield</h3>
        <label>Roof area (m²)<br><input id="ry-area" type="number" step=".1" placeholder="80"></label><br/>
        <label>Monthly rainfall (mm)<br><input id="ry-rain" type="number" step="1" placeholder="150"></label><br/>
        <label>Runoff coefficient<br>
          <select id="ry-k"><option value="0.9">Metal (0.9)</option><option value="0.8">Tile (0.8)</option><option value="0.7">Concrete (0.7)</option><option value="0.6">Thatch (0.6)</option></select>
        </label><br/>
        <button id="ry-calc">Estimate</button>
        <p class="small">Result: <span id="ry-out" class="mono">—</span> liters / month</p>
      </div>
      <div id="calc-friction" class="card">
        <h3>Pipe friction (Hazen‑Williams)</h3>
        <label>Flow (L/min)<br><input id="pf-q" type="number" step="1" placeholder="20"></label><br/>
        <label>Pipe ID (mm)<br><input id="pf-d" type="number" step="1" placeholder="32"></label><br/>
        <label>Length (m)<br><input id="pf-l" type="number" step="1" placeholder="120"></label><br/>
        <label>C (roughness)<br><input id="pf-c" type="number" step="1" value="150"></label><br/>
        <button id="pf-calc">Headloss</button>
        <p class="small">Head loss: <span id="pf-out" class="mono">—</span> m</p>
      </div>
      <div id="calc-chlorine" class="card">
        <h3>Chlorine (target residual)</h3>
        <label>Volume (L)<br><input id="cl-v" type="number" step="1" placeholder="1000"></label><br/>
        <label>Target residual (mg/L)<br><input id="cl-target" type="number" step=".01" value="0.5"></label><br/>
        <label>Stock NaOCl (%)<br><input id="cl-stock" type="number" step=".1" value="5"></label><br/>
        <button id="cl-calc">Suggest dose</button>
        <p class="small">Add approx: <span id="cl-out" class="mono">—</span> mL of stock. <br/>Always verify with test strips; adjust to 0.2–0.5&nbsp;mg/L after 30&nbsp;min.</p>
      </div>
    </div>
  </section>

  <section id="habitica" class="panel">
    <h2>5) Habitica water tasks</h2>
    <div class="grid cols-2">
      <div>
        <h3>Credentials</h3>
        <label>User ID<br><input id="habUser" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off"></label><br/>
        <label>API Token<br><input id="habToken" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off"></label><br/>
        <div class="toolbar">
          <button id="hab-save" class="pill">Save (IndexedDB)</button>
          <button id="hab-load">Load</button>
          <button id="hab-clear" class="warn">Clear</button>
        </div>
        <p id="hab-status" class="small"></p>
      </div>
      <div>
        <h3>Quick Activation To‑Dos</h3>
        <textarea id="habTasks" rows="10">Install leaf screens & gutters on Site A; set fall 3 mm/m; hem edges.
Build PVC first-flush at Site A; set diverter to ~0.8 L/m².
Erect 10 m³ ferrocement tank at Site A; cure 7 days damp.
Lay 32 mm HDPE line 120 m to tapstand; air release at high point.
Rehab shallow well at Site B; sanitary seal + apron; rope pump fit.
Commission biosand unit (household); log day‑by‑day turbidity.
Chlorination kiosk: prepare stock, dose batch, test residual at 30 min.
Create MEL snapshot: HH served, queue time, residual.</textarea>
        <div class="toolbar">
          <button id="hab-push">Create Habitica To‑Dos</button>
        </div>
        <p class="small mono">POST https://habitica.com/api/v3/tasks/user &nbsp;|&nbsp; Headers: x-api-user, x-api-key</p>
      </div>
    </div>
  </section>

  <section id="advisor" class="panel">
    <h2>6) WebLLM Field Advisor</h2>
    <p class="small">Runs a small model in‑browser. First load fetches weights; then can run offline.</p>
    <div class="toolbar">
      <select id="modelSelect">
        <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama‑3.2‑1B‑Instruct</option>
        <option value="Phi-4-mini-4k-instruct-q4f16_1-MLC">Phi‑4‑mini‑instruct</option>
      </select>
      <button id="llm-start" class="pill">Start Advisor</button>
      <button id="llm-stop" class="warn">Stop</button>
      <span id="llm-status" class="small"></span>
    </div>
    <div id="chat" style="max-height:340px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:.6rem;background:rgba(255,255,255,.03);margin-top:.5rem">
      <div class="small">System prompt: “You are a PRA field advisor. Be concise, actionable, Haiti‑specific. Ask for missing info.”</div>
    </div>
    <div class="toolbar">
      <input id="chatInput" placeholder="Ask: How to size first‑flush diverter for a 60 m² roof?" />
      <button id="chatSend">Send</button>
    </div>
  </section>

  <!-- PART 1 continues with script; Part 2 will add Uploads/Gallery/Footer and close the document -->
</main>

<!-- ====== Core Script (Starfield/Constellations, Menus, IndexedDB, Tools, Habitica, WebLLM) ====== -->
<script>
/* ==============================
   Photorealistic Stars + Morphing Constellations
   ============================== */
(function(){
  const stars = document.getElementById('stars');
  const constel = document.getElementById('constel');
  let gl = stars.getContext('webgl', {antialias:false, alpha:true});
  function resize(){
    const dpr = Math.min(devicePixelRatio||1, 2);
    const r1 = stars.getBoundingClientRect();
    stars.width = r1.width*dpr; stars.height = r1.height*dpr;
    if(gl) gl.viewport(0,0,gl.drawingBufferWidth, gl.drawingBufferHeight);
    const r2 = constel.getBoundingClientRect();
    constel.width = r2.width*dpr; constel.height = r2.height*dpr;
  }
  addEventListener('resize', resize, {passive:true}); resize();

  if(!gl){
    // graceful 2D fallback for stars
    const ctx = stars.getContext('2d');
    const pop = 1400, pts = Array.from({length:pop},()=>({x:Math.random(),y:Math.random(),z:Math.random(),s:Math.random()}));
    function draw2D(t){
      const w=stars.width,h=stars.height; ctx.clearRect(0,0,w,h);
      const g=ctx.createRadialGradient(w*.5,h*.5,0, w*.5,h*.5, Math.max(w,h)*.6);
      g.addColorStop(0,'rgba(255,255,255,0.02)'); g.addColorStop(1,'rgba(6,10,18,0.2)'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
      for(const p of pts){
        const tw=0.5+0.5*Math.sin(t*0.001 + p.x*13 + p.y*7); const a=0.25+0.65*tw;
        ctx.fillStyle=`rgba(178,212,255,${a})`; const px=p.x*w, py=p.y*h; const r=(p.s*1.5+tw*1.2)*(w/1400+0.3);
        ctx.beginPath(); ctx.arc(px,py,r,0,6.283); ctx.fill();
      }
      requestAnimationFrame(draw2D);
    }
    requestAnimationFrame(draw2D);
  }else{
    // WebGL points shader for star glow
    const vs = `
      attribute vec2 a;
      attribute float s;
      uniform vec2 r;
      uniform float t;
      varying float v;
      void main(){
        vec2 p = a*2.0-1.0;
        p.y *= r.x/r.y;
        float tw = 0.5 + 0.5*sin(t*0.7 + a.x*11.0 + a.y*6.0 + s*17.0);
        v = mix(0.18,1.0,tw);
        gl_Position = vec4(p,0.0,1.0);
        gl_PointSize = mix(0.6,2.8,s) * (r.x/550.0 + 0.2);
      }`;
    const fs = `
      precision mediump float;
      varying float v;
      void main(){
        vec2 pc = gl_PointCoord-vec2(0.5);
        float d = length(pc);
        float core = smoothstep(0.5,0.0,d);
        float glow = smoothstep(0.9,0.0,d);
        vec3 col = mix(vec3(0.60,0.78,1.0), vec3(0.90,0.95,1.0), core);
        float a = clamp(core*0.9 + glow*0.25, 0.0, 1.0) * v;
        gl_FragColor = vec4(col,a);
      }`;
    function sh(type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);
      if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw gl.getShaderInfoLog(s); return s;}
    const pr=gl.createProgram(); gl.attachShader(pr,sh(gl.VERTEX_SHADER,vs)); gl.attachShader(pr,sh(gl.FRAGMENT_SHADER,fs));
    gl.linkProgram(pr); if(!gl.getProgramParameter(pr,gl.LINK_STATUS)) throw gl.getProgramInfoLog(pr); gl.useProgram(pr);
    const N=6000, arr=new Float32Array(N*2), sz=new Float32Array(N);
    for(let i=0;i<N;i++){arr[i*2]=Math.random();arr[i*2+1]=Math.random();sz[i]=Math.random();}
    const bA=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,bA); gl.bufferData(gl.ARRAY_BUFFER,arr,gl.STATIC_DRAW);
    const lA=gl.getAttribLocation(pr,'a'); gl.enableVertexAttribArray(lA); gl.vertexAttribPointer(lA,2,gl.FLOAT,false,0,0);
    const bS=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,bS); gl.bufferData(gl.ARRAY_BUFFER,sz,gl.STATIC_DRAW);
    const lS=gl.getAttribLocation(pr,'s'); gl.enableVertexAttribArray(lS); gl.vertexAttribPointer(lS,1,gl.FLOAT,false,0,0);
    const uR=gl.getUniformLocation(pr,'r'), uT=gl.getUniformLocation(pr,'t');
    function frame(now){ gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight);
      gl.clearColor(0,0,0,0); gl.clear(gl.COLOR_BUFFER_BIT);
      gl.uniform2f(uR,gl.drawingBufferWidth,gl.drawingBufferHeight); gl.uniform1f(uT,now*0.001);
      gl.drawArrays(gl.POINTS,0,N); requestAnimationFrame(frame);}
    requestAnimationFrame(frame);
  }

  // Morphing constellations overlay (2D): interpolate between patterns
  const ctx = constel.getContext('2d');
  const patterns = [
    // Abstracted, culturally‑neutral patterns
    [{x:.15,y:.25},{x:.22,y:.30},{x:.29,y:.33},{x:.34,y:.28},{x:.40,y:.22},{x:.47,y:.26}],
    [{x:.20,y:.60},{x:.27,y:.55},{x:.34,y:.58},{x:.41,y:.52},{x:.48,y:.57},{x:.55,y:.50}],
    [{x:.65,y:.18},{x:.70,y:.24},{x:.76,y:.20},{x:.82,y:.26},{x:.88,y:.22},{x:.93,y:.28}],
    [{x:.62,y:.70},{x:.69,y:.64},{x:.75,y:.69},{x:.81,y:.63},{x:.87,y:.68},{x:.93,y:.62}]
  ];
  let a=0, idx=0;
  function lerp(a,b,t){return a+(b-a)*t}
  function drawConstel(){
    const w=constel.width,h=constel.height;
    ctx.clearRect(0,0,w,h);
    const p1=patterns[idx], p2=patterns[(idx+1)%patterns.length];
    const t = 0.5+0.5*Math.sin(a*0.002);
    // lines
    ctx.lineWidth = Math.max(1, w/900); ctx.strokeStyle='rgba(178,212,255,.35)'; ctx.beginPath();
    for(let i=0;i<p1.length-1;i++){
      const x1=lerp(p1[i].x*w, p2[i].x*w, t), y1=lerp(p1[i].y*h, p2[i].y*h, t);
      const x2=lerp(p1[i+1].x*w, p2[i+1].x*w, t), y2=lerp(p1[i+1].y*h, p2[i+1].y*h, t);
      ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
    }
    ctx.stroke();
    // nodes
    for(let i=0;i<p1.length;i++){
      const x=lerp(p1[i].x*w, p2[i].x*w, t), y=lerp(p1[i].y*h, p2[i].y*h, t);
      const r = (1.4 + 1.0*Math.sin(a*0.01+i)) * (w/1500 + 0.2);
      const grad = ctx.createRadialGradient(x,y,0,x,y,r*4);
      grad.addColorStop(0,'rgba(200,240,255,.9)'); grad.addColorStop(1,'rgba(200,240,255,0)');
      ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y,r,0,6.283); ctx.fill();
    }
    a+=16; if(a%4000<20) idx=(idx+1)%patterns.length;
    requestAnimationFrame(drawConstel);
  }
  requestAnimationFrame(drawConstel);
})();

/* ==============================
   Parallax dropdown mega‑menus
   ============================== */
(function(){
  const toggles = document.querySelectorAll('.toggle');
  const megas = new Map();
  toggles.forEach(t=>{
    const id = t.getAttribute('data-mega');
    const panel = document.getElementById(id);
    megas.set(t, panel);
    t.addEventListener('click', ()=>{
      const open = panel.classList.toggle('open');
      t.setAttribute('aria-expanded', open ? 'true':'false');
      // close others
      toggles.forEach(o=>{ if(o!==t){ o.setAttribute('aria-expanded','false'); megas.get(o).classList.remove('open'); }});
    });
  });
  document.addEventListener('click', (e)=>{
    if(!e.target.closest('.megatop')){ megas.forEach(p=>p.classList.remove('open')); toggles.forEach(t=>t.setAttribute('aria-expanded','false')); }
  });
  // gentle parallax
  const layer = document.querySelector('.parallax-layer');
  addEventListener('scroll', ()=>{
    const y = scrollY; layer.style.transform = `translateY(${y*0.08}px)`;
  }, {passive:true});
})();

/* ==============================
   IndexedDB schema & helpers
   Stores: water_assets, mel, discoveries, images, alternatives, settings, habitica
   ============================== */
const DB_NAME='pra_water_ht', DB_VER=1; let db=null;
function openDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('water_assets')){ d.createObjectStore('water_assets',{keyPath:'id'}); }
      if(!d.objectStoreNames.contains('mel')){ d.createObjectStore('mel',{keyPath:'ts'}); }
      if(!d.objectStoreNames.contains('discoveries')){ d.createObjectStore('discoveries',{keyPath:'id', autoIncrement:true}); }
      if(!d.objectStoreNames.contains('images')){ d.createObjectStore('images',{keyPath:'id', autoIncrement:true}); }
      if(!d.objectStoreNames.contains('alternatives')){ d.createObjectStore('alternatives',{keyPath:'id', autoIncrement:true}); }
      if(!d.objectStoreNames.contains('settings')){ d.createObjectStore('settings',{keyPath:'key'}); }
      if(!d.objectStoreNames.contains('habitica')){ d.createObjectStore('habitica',{keyPath:'id'}); }
    };
    req.onsuccess = ()=>{ db=req.result; res(db); };
    req.onerror = ()=> rej(req.error);
  });
}
function store(name, mode='readonly'){ return db.transaction(name, mode).objectStore(name); }
async function put(storeName, val){ return new Promise((res,rej)=>{ const r=store(storeName,'readwrite').put(val); r.onsuccess=res; r.onerror=()=>rej(r.error); }); }
async function getAll(storeName){ return new Promise((res,rej)=>{ const arr=[]; const cur=store(storeName).openCursor(); cur.onsuccess=e=>{const c=e.target.result; if(c){arr.push(c.value); c.continue();} else res(arr)}; cur.onerror=()=>rej(cur.error); }); }
async function del(storeName, key){ return new Promise((res,rej)=>{ const r=store(storeName,'readwrite').delete(key); r.onsuccess=res; r.onerror=()=>rej(r.error); }); }
async function getSetting(key){ return new Promise((res,rej)=>{ const r=store('settings').get(key); r.onsuccess=()=>res(r.result?.value); r.onerror=()=>rej(r.error); }); }
async function setSetting(key,value){ return put('settings',{key,value}); }

/* ====== Water Assets & MEL UI ====== */
async function refreshAssets(){
  const rows = await getAll('water_assets');
  const tb = document.querySelector('#wa-table tbody'); if(!tb) return;
  tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.id}</td><td>${r.type}</td><td>${r.loc||''}</td><td>${r.notes||''}</td>
      <td><button data-del="${r.id}">×</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=> b.onclick = async()=>{ await del('water_assets', b.dataset.del); refreshAssets(); });
}
async function bindLedger(){
  document.getElementById('wa-add').onclick = async ()=>{
    const id = document.getElementById('wa-id').value.trim();
    if(!id) return alert('ID required');
    const item = {
      id, type: document.getElementById('wa-type').value,
      loc: document.getElementById('wa-loc').value.trim(),
      notes: document.getElementById('wa-notes').value.trim()
    };
    try{ await put('water_assets', item); refreshAssets(); } catch(e){ alert('Error: '+e); }
  };
  document.getElementById('wa-reset').onclick = ()=> ['wa-id','wa-loc','wa-notes'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('wa-refresh').onclick = refreshAssets;
  refreshAssets();

  // MEL
  document.getElementById('mel-save').onclick = async ()=>{
    const row = {
      ts: Date.now(),
      hh: +document.getElementById('mel-hh').value||0,
      queue: +document.getElementById('mel-queue').value||0,
      fc: +document.getElementById('mel-fc').value||0
    };
    await put('mel', row); alert('MEL snapshot saved.');
  };
  document.getElementById('mel-list').onclick = async ()=>{
    const list = await getAll('mel'); const ul = document.getElementById('mel-rows'); ul.innerHTML='';
    list.sort((a,b)=>b.ts-a.ts).forEach(r=>{
      const li=document.createElement('li'); const dt=new Date(r.ts).toLocaleString();
      li.innerHTML = `<span class="mono">${dt}</span> — HH ${r.hh}, Queue ${r.queue} min, FC ${r.fc} mg/L`; ul.appendChild(li);
    });
  };
  document.getElementById('mel-clear').onclick = async ()=>{ await new Promise((res,rej)=>{ const r=store('mel','readwrite').clear(); r.onsuccess=res; r.onerror=()=>rej(r.error); }); document.getElementById('mel-rows').innerHTML=''; };

  // Export
  document.getElementById('db-export').onclick = async ()=>{
    const data = {
      water_assets: await getAll('water_assets'),
      mel: await getAll('mel'),
      discoveries: await getAll('discoveries'),
      alternatives: await getAll('alternatives'),
      // images exported as data URLs to keep it single‑file
      images: await Promise.all((await getAll('images')).map(async img=>{
        const b = img.blob; const buf = await b.arrayBuffer();
        const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        return { id: img.id, name: img.name, type: b.type, tags: img.tags||[], notes: img.notes||'', data: `data:${b.type};base64,${b64}` };
      })),
      settings: await getAll('settings')
    };
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'pra_water_haiti_export.json'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  document.getElementById('db-import').onchange = async (e)=>{
    const f=e.target.files[0]; if(!f) return; const text=await f.text(); const data=JSON.parse(text);
    // upsert
    for(const row of (data.water_assets||[])) await put('water_assets', row);
    for(const row of (data.mel||[])) await put('mel', row);
    for(const row of (data.discoveries||[])) await put('discoveries', row);
    for(const row of (data.alternatives||[])) await put('alternatives', row);
    for(const row of (data.settings||[])) await put('settings', row);
    // images back to blobs
    for(const img of (data.images||[])){
      const resp = await fetch(img.data); const blob = await resp.blob();
      await put('images', { id: img.id, name: img.name, tags: img.tags||[], notes: img.notes||'', blob });
    }
    refreshAssets(); alert('Import complete.');
  };
}

/* ==============================
   Calculators
   ============================== */
function calcRain(){ // liters = area(m²) * rain(mm) * k
  const A=+document.getElementById('ry-area').value||0;
  const R=+document.getElementById('ry-rain').value||0;
  const k=+document.getElementById('ry-k').value||0.8;
  document.getElementById('ry-out').textContent = Math.round(A*R*k).toLocaleString();
}
function calcFriction(){ // Hazen-Williams, headloss h_f ≈ 10.67 * L * Q^1.852 / (C^1.852 * D^4.87)
  const Qlpm=+document.getElementById('pf-q').value||0; const Q=Qlpm/1000/60; // m³/s
  const Dmm=+document.getElementById('pf-d').value||1; const D=Dmm/1000; // m
  const L=+document.getElementById('pf-l').value||0; const C=+document.getElementById('pf-c').value||150;
  const hf = 10.67*L*Math.pow(Q,1.852)/(Math.pow(C,1.852)*Math.pow(D,4.87));
  document.getElementById('pf-out').textContent = isFinite(hf)? (hf.toFixed(2)) : '—';
}
function calcChlorine(){
  const V=+document.getElementById('cl-v').value||0; // liters
  const target=+document.getElementById('cl-target').value||0.5; // mg/L
  const pct=+document.getElementById('cl-stock').value||5; // %
  // mg needed = target * V ; mg per mL stock ≈ pct(%) * 10,000 mg/L => mg/mL ~ pct * 100
  const mg = target * V; const mgPerMl = pct * 100;
  const ml = mg / mgPerMl;
  document.getElementById('cl-out').textContent = isFinite(ml)? ml.toFixed(1) : '—';
}

/* ==============================
   Habitica
   ============================== */
async function habSave(u,t){ await put('habitica',{id:'creds', user:u, token:t}); }
async function habLoad(){ return new Promise((res)=>{ const r=store('habitica').get('creds'); r.onsuccess=()=>res(r.result||null); }); }
async function bindHabitica(){
  const s=document.getElementById('hab-status');
  document.getElementById('hab-save').onclick = async ()=>{
    await habSave(document.getElementById('habUser').value.trim(), document.getElementById('habToken').value.trim());
    s.textContent='Saved locally.';
  };
  document.getElementById('hab-load').onclick = async ()=>{ const c=await habLoad(); if(c){ habUser.value=c.user||''; habToken.value=c.token||''; s.textContent='Loaded.' } else s.textContent='No creds saved.'; };
  document.getElementById('hab-clear').onclick = async ()=>{ await del('habitica','creds'); habUser.value=''; habToken.value=''; s.textContent='Cleared.'; };
  document.getElementById('hab-push').onclick = async ()=>{
    const c = await habLoad(); if(!c||!c.user||!c.token) return alert('Save credentials first.');
    const todos = document.getElementById('habTasks').value.split('\n').map(v=>v.trim()).filter(Boolean);
    let ok=0, fail=0;
    for(const t of todos){
      try{
        const r=await fetch('https://habitica.com/api/v3/tasks/user',{method:'POST',headers:{'x-api-user':c.user,'x-api-key':c.token,'Content-Type':'application/json'},body:JSON.stringify({text:t,type:'todo',priority:1})});
        if(!r.ok) throw 0; ok++;
      }catch(e){ fail++; }
    }
    s.textContent = `Created ${ok} To‑Dos${fail?`, ${fail} failed`:''}.`;
  };
}

/* ==============================
   WebLLM (on-demand)
   ============================== */
let engine=null, chatHistory=[];
async function ensureWebLLM(){ if(window.webllm) return; await import('https://unpkg.com/@mlc-ai/web-llm@0.2.53/dist/web-llm.min.js'); }
async function bindLLM(){
  const stat=document.getElementById('llm-status');
  document.getElementById('llm-start').onclick = async ()=>{
    try{
      stat.textContent='Loading model…';
      await ensureWebLLM();
      const model=document.getElementById('modelSelect').value;
      engine = await webllm.CreateMLCEngine(model,{initProgressCallback:(i)=>{ stat.textContent=i.text||'Loading…'; }});
      chatHistory=[{role:'system',content:'You are a PRA field advisor. Be concise, actionable, Haiti‑specific. Ask for missing info.'}];
      stat.textContent='Ready.';
    }catch(e){ stat.textContent='Error loading model.'; console.error(e); }
  };
  document.getElementById('llm-stop').onclick = ()=>{ engine=null; stat.textContent='Stopped.'; };
  document.getElementById('chatSend').onclick = async ()=>{
    const input=document.getElementById('chatInput'); const msg=input.value.trim(); if(!msg) return;
    const chat=document.getElementById('chat');
    const add=(who,txt)=>{ const d=document.createElement('div'); d.innerHTML=`<div class="small"><strong>${who}</strong></div><div style="white-space:pre-wrap">${txt}</div><hr style="border:0;border-top:1px dashed var(--border)"/>`; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; };
    add('You',msg); input.value='';
    if(!engine){ add('Advisor','Start the Advisor first.'); return; }
    chatHistory.push({role:'user',content:msg});
    const r=await engine.chat.completions.create({messages:chatHistory,temperature:.2});
    const text=r.choices?.[0]?.message?.content||'(no output)'; add('Advisor',text);
    chatHistory.push({role:'assistant',content:text});
  };
}

/* ==============================
   Bootstrap all
   ============================== */
openDB().then(async ()=>{
  await bindLedger(); await bindHabitica(); await bindLLM();
  // calculators
  document.getElementById('ry-calc').onclick = calcRain;
  document.getElementById('pf-calc').onclick = calcFriction;
  document.getElementById('cl-calc').onclick = calcChlorine;
});
</script>
<!-- CONTINUES SAME DOCUMENT: add uploads, gallery, extra modules, and close -->
<section id="uploads" class="panel">
  <h2>7) Discoveries • Images • Alternatives (Uploads)</h2>
  <p class="small">Everything stays in your browser (IndexedDB). Export to JSON to share. Images are stored as Blobs and can be exported as data URLs.</p>
  <div class="grid cols-3">
    <div class="card">
      <h3>Discovery</h3>
      <label>Title<br><input id="disc-title" placeholder="E.g., Low‑cost swirl filter from paint bucket"></label><br/>
      <label>Tags (comma)<br><input id="disc-tags" placeholder="swirl, prefilter, bucket"></label><br/>
      <label>Description<br><textarea id="disc-body" rows="6" placeholder="How it works, why it helps, parts list, cost…"></textarea></label><br/>
      <div class="toolbar">
        <button id="disc-save" class="pill">Save discovery</button>
      </div>
    </div>
    <div class="card">
      <h3>Alternative</h3>
      <label>Title<br><input id="alt-title" placeholder="E.g., Using IBC tote instead of ferrocement"></label><br/>
      <label>Tags (comma)<br><input id="alt-tags" placeholder="IBC,tank,alternatives"></label><br/>
      <label>Notes<br><textarea id="alt-body" rows="6" placeholder="Tradeoffs, local sourcing, maintenance…"></textarea></label><br/>
      <div class="toolbar">
        <button id="alt-save" class="pill">Save alternative</button>
      </div>
    </div>
    <div class="card">
      <h3>Images</h3>
      <label class="pill">Choose files <input id="img-files" type="file" accept="image/*" multiple class="sr-only"></label>
      <label>Tags (comma)<br><input id="img-tags" placeholder="gutter,install,siteA"></label><br/>
      <label>Notes<br><input id="img-notes" placeholder="Include angle, context, person (if consented)"></label><br/>
      <div class="toolbar">
        <button id="img-add" class="pill">Add images</button>
        <button id="img-list">List</button>
        <button id="img-clear" class="warn">Clear all (images)</button>
      </div>
      <p class="small">Respect consent; avoid faces unless permission was granted.</p>
    </div>
  </div>
</section>

<section id="gallery" class="panel">
  <h2>8) Gallery &amp; Knowledge Base</h2>
  <div class="toolbar">
    <button id="gb-refresh">Refresh all</button>
    <input id="gb-search" placeholder="Search title/tags…">
    <button id="gb-find">Find</button>
  </div>
  <div class="grid cols-3" id="gallery-grid"></div>
  <h3>Discoveries</h3>
  <ul id="disc-list"></ul>
  <h3>Alternatives</h3>
  <ul id="alt-list"></ul>
</section>

<section id="sourcing" class="panel">
  <h2>9) Sourcing checklist — Haiti</h2>
  <div class="grid cols-2">
    <div>
      <h3>Common hardware &amp; materials</h3>
      <ul>
        <li><strong>Sheet‑metal</strong> (0.4–0.6&nbsp;mm), strap/hangers, screws, silicone/bitumen.</li>
        <li><strong>PVC/HDPE</strong> pipe &amp; fittings (tees, elbows, unions, valves), Teflon tape.</li>
        <li><strong>Food‑grade</strong> drums (200&nbsp;L), IBC totes (1000&nbsp;L).</li>
        <li><strong>Sharp sand</strong>, pea gravel, cement; <strong>rebar</strong> (8&nbsp;mm), chicken wire.</li>
        <li><strong>Insect screen</strong>, leaf screen mesh, geotextile for soak pits.</li>
        <li><strong>Test strips</strong> for free chlorine; turbidity tube (DIY possible).</li>
      </ul>
    </div>
    <div>
      <h3>Local workshops &amp; vendors (generic lenses)</h3>
      <ul>
        <li>Roofing &amp; sheet‑metal shops: gutters, bends, custom flashing.</li>
        <li>Plumbing supply: PVC/HDPE, valves, thread adapters.</li>
        <li>Welders: tank stands, rope‑pump frames, tapstand cages.</li>
        <li>Concrete yards: sand, gravel, cement; advice on local aggregates.</li>
        <li>Recyclers: food‑grade drums, IBC totes; verify previous contents.</li>
        <li>Bike repair: cranks, pedals, bearings, inner tubes for rope pumps.</li>
      </ul>
      <p class="small note">Record shop names & contacts in <em>Discoveries</em> so nodes can reuse vetted sources.</p>
    </div>
  </div>
</section>

<section id="risk-more" class="panel">
  <h2>10) Safety notes &amp; QA</h2>
  <ul>
    <li>Protect intakes with leaf screens; keep tank inlets/outlets screened and covered.</li>
    <li>Keep first‑flush diverter draining properly; clean after storms.</li>
    <li>Chlorination: always verify residual (test strips) after 30&nbsp;min. Target 0.2–0.5&nbsp;mg/L; follow local public‑health guidance.</li>
    <li>Biosand: keep diffuser in place; don’t disturb biolayer except during proper maintenance.</li>
    <li>Shallow wells: maintain sanitary seal and apron; fix cracks immediately.</li>
  </ul>
</section>

<footer class="footer">
  <p>© Planetary Restoration Archive • CC‑BY‑4.0 • “PRA Hybrid” schema</p>
  <p class="small">This page stores operational data only in your browser (IndexedDB). Export regularly for backup.</p>
  <div class="cta-row">
    <button id="toggleStars">Pause/Resume Sky</button>
  </div>
</footer>

<!-- PART 2 helper scripts attach to IndexedDB stores created in Part 1 -->
<script>
/* ====== Part 2: Uploads, Gallery binder ====== */
function byId(id){ return document.getElementById(id); }

async function saveDiscovery(){
  const title=byId('disc-title').value.trim();
  const tags=(byId('disc-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const body=byId('disc-body').value.trim();
  if(!title && !body) return alert('Add a title or body');
  await new Promise((res,rej)=>{ const r=store('discoveries','readwrite').add({ title, tags, body, ts:Date.now() }); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  byId('disc-title').value=''; byId('disc-tags').value=''; byId('disc-body').value='';
}
async function saveAlternative(){
  const title=byId('alt-title').value.trim();
  const tags=(byId('alt-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const body=byId('alt-body').value.trim();
  if(!title && !body) return alert('Add a title or body');
  await new Promise((res,rej)=>{ const r=store('alternatives','readwrite').add({ title, tags, body, ts:Date.now() }); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  byId('alt-title').value=''; byId('alt-tags').value=''; byId('alt-body').value='';
}
async function addImages(files, tags, notes){
  for(const f of files){
    const blob = f; await new Promise((res,rej)=>{ const r=store('images','readwrite').add({ name:f.name, tags, notes, blob, ts:Date.now() }); r.onsuccess=res; r.onerror=()=>rej(r.error); });
  }
}
async function listImages(filter){
  const rows = await getAll('images');
  const grid = byId('gallery-grid'); grid.innerHTML='';
  for(const r of rows){
    if(filter && filter.length){
      const hay = (r.name+' '+(r.tags||[]).join(' ')+' '+(r.notes||'')).toLowerCase();
      if(!filter.some(k=>hay.includes(k))) continue;
    }
    const url = URL.createObjectURL(r.blob);
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `<img src="${url}" alt="${r.name}"/><div class="small mono">${r.name}</div><div class="small">${(r.tags||[]).join(', ')}</div>`;
    grid.appendChild(card);
  }
}
async function listText(name, ulId, filter){
  const rows = await getAll(name); rows.sort((a,b)=>b.ts-a.ts);
  const ul = byId(ulId); ul.innerHTML='';
  for(const r of rows){
    const hay = (r.title+' '+(r.tags||[]).join(' ')+' '+(r.body||'')).toLowerCase();
    if(filter && filter.length && !filter.some(k=>hay.includes(k))) continue;
    const li=document.createElement('li');
    const dt=new Date(r.ts).toLocaleString();
    li.innerHTML = `<strong>${r.title||'(untitled)'}</strong> <span class="small">— ${dt}</span><br>${(r.body||'').replace(/\n/g,'<br>')}<br><span class="small">${(r.tags||[]).join(', ')}</span>`;
    ul.appendChild(li);
  }
}

openDB().then(()=>{
  byId('disc-save').onclick = saveDiscovery;
  byId('alt-save').onclick = saveAlternative;

  byId('img-add').onclick = async ()=>{
    const f = byId('img-files').files; if(!f || !f.length) return alert('Choose image(s)');
    const tags = (byId('img-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const notes = byId('img-notes').value.trim();
    await addImages(f, tags, notes); alert('Images added.');
  };
  byId('img-list').onclick = ()=> listImages();
  byId('img-clear').onclick = async ()=>{
    await new Promise((res,rej)=>{ const r=store('images','readwrite').clear(); r.onsuccess=res; r.onerror=()=>rej(r.error); });
    byId('gallery-grid').innerHTML='';
  };

  byId('gb-refresh').onclick = async ()=>{
    await listImages(); await listText('discoveries','disc-list'); await listText('alternatives','alt-list');
  };
  byId('gb-find').onclick = async ()=>{
    const q = (byId('gb-search').value||'').toLowerCase().trim();
    const keys = q? q.split(/\s+/) : [];
    await listImages(keys); await listText('discoveries','disc-list',keys); await listText('alternatives','alt-list',keys);
  };

  // Star toggle hook from Part 1
  const t = document.getElementById('toggleStars'); let paused=false;
  if(t){
    // Pause only the 2D overlay to save a bit of CPU
    t.onclick = ()=>{ const canvas=document.getElementById('constel'); paused=!paused; constel.style.display = paused?'none':'block'; };
  }
});
</script>
</body>
</html>

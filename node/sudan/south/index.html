<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>South Sudan ‚Ä¢ Food & Water Sovereignty ‚Äî Multisystem Dashboard (Foster + Navi)</title>
<meta name="theme-color" content="#0b1020" />
<meta name="color-scheme" content="dark" />
<meta name="description" content="Offline-first sovereignty dashboard for South Sudan: seeds‚Üísoil‚Üíwater‚Üífisheries‚Üímarkets‚Üíriver/road logistics‚Üíearly warning‚Üípeace pacts. Mycelial gamification, anti-inversion guardrails, service-worker caching." />
<style>
  :root{
    --bg:#0b1020; --ink:#e8f0ff; --muted:#c9d2ffcc;
    --card:#0e1534e6; --edge:#1b2658; --glass:#0e1534b0;
    --accent:#7af5e5; --accent2:#a78bfa; --gold:#ffd166; --ok:#70ffa8; --warn:#ffcd6b; --bad:#ff6b6b;
    --shadow:0 10px 30px #0008, inset 0 1px 0 #3a49a155;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 800px at 80% -10%, #1a2346 0%, rgba(11,16,32,0) 60%),
                     radial-gradient(1000px 600px at 10% -20%, #141d3a 0%, rgba(11,16,32,0) 60%), var(--bg);
    color:var(--ink); font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
    overflow-x:hidden;
  }
  /* Photorealistic constellation parallax (3 layers) */
  #deep-sky,#sky,#near-sky{position:fixed; inset:0; z-index:-5}
  #sky{z-index:-4; opacity:.95} #near-sky{z-index:-3; opacity:.85}
  .nebula{position:fixed; inset:auto; z-index:-2; pointer-events:none; opacity:.28; mix-blend-mode:screen;
          filter:brightness(115%) blur(10px) saturate(130%);
          background:radial-gradient(650px 400px at 15% 30%, #4f46e5 0%, transparent 60%),
                     radial-gradient(800px 500px at 80% 20%, #22d3ee 0%, transparent 65%),
                     radial-gradient(700px 500px at 45% 75%, #8b5cf6 0%, transparent 60%);
          width:140vmax; height:100vmax; left:-10vmax; top:-10vmax}
  header{position:sticky; top:0; backdrop-filter:blur(8px);
         background:linear-gradient(180deg, rgba(16,25,54,.88), rgba(16,25,54,.42) 60%, transparent);
         border-bottom:1px solid #1f2a5a; z-index:10}
  .wrap{max-width:1280px; margin:0 auto; padding:16px clamp(12px,2.6vw,28px)}
  h1{margin:.2rem 0 .4rem; font-weight:900; font-size:clamp(22px,3.6vw,38px); letter-spacing:.2px}
  h2{margin:1.4rem 0 .5rem; font-size:clamp(18px,2.4vw,26px)}
  h3{margin:1rem 0 .3rem; font-size:clamp(16px,2vw,22px)}
  p,li{color:var(--muted)}
  a{color:var(--accent)}
  .badge{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:4px 8px; border-radius:999px;
         border:1px solid #28407a; background:#101936b3; color:#c7d2fe}
  .ribbon{display:inline-block; padding:3px 8px; border-radius:8px; background:#0f1a3dcc; border:1px solid #24306a; color:#c7d2fe}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:linear-gradient(180deg, var(--card), #0c1330cc); border:1px solid var(--edge); border-radius:16px; padding:16px; box-shadow:var(--shadow); position:relative}
  .panel{display:grid; gap:12px; grid-template-columns: repeat(12,1fr)}
  .panel > .card{grid-column: span 12}
  @media(min-width:880px){
    .span-4{grid-column: span 4} .span-6{grid-column: span 6} .span-8{grid-column: span 8} .span-12{grid-column: span 12}
  }
  .section{position:relative; margin:22px 0; padding:18px; border:1px solid var(--edge); border-radius:16px; background:linear-gradient(180deg,#0e1534c8,#0d1432aa)}
  .section[data-depth="near"]{transform:translateY(calc(var(--scroll,0)*.06px))}
  .section[data-depth="mid"]{transform:translateY(calc(var(--scroll,0)*.03px))}
  .section[data-depth="far"]{transform:translateY(calc(var(--scroll,0)*.015px))}
  .divider{height:1px; background:linear-gradient(90deg, transparent, #2a3880, transparent); margin:16px 0}
  .muted{opacity:.92}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:13px}
  .tag{position:absolute; top:10px; right:12px; font-size:11px; color:#cbd5ff; opacity:.9}
  .tooltip{border-bottom:1px dashed #7aa2ff; cursor:help}
  .btn{display:inline-flex; gap:10px; align-items:center; padding:10px 14px; border-radius:12px; text-decoration:none;
       background:linear-gradient(90deg,#233069,#192653); border:1px solid #2a3a76; color:#e4ebff}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .switch{display:inline-flex; align-items:center; gap:8px}
  .switch input{accent-color:#7aa2ff}
  .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111b3f; color:#eaf0ff; border:1px solid #2a3a76; border-radius:10px; padding:10px 14px; display:none; z-index:20}
  .okline{height:3px; background:linear-gradient(90deg, #63ff99, #7af5e5)}
  .list-tight li{margin:.25rem 0}
  /* Inversion banner */
  .inversion{margin:10px 0 6px; padding:10px 14px; border-radius:12px; border:1px solid #28407a;
             background:linear-gradient(180deg,#0f183cdd,#0f183c80); color:#e8f0ff; font-weight:600}
  /* Small HUD counters */
  .kpis{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .kpi{padding:12px 14px; border:1px solid var(--edge); border-radius:14px; background:#0e1534cc}
  .kpi .big{font-weight:900; font-size:clamp(18px,2.6vw,28px)}
  /* Mycelial viz */
  canvas#mycelium{width:100%; height:240px; display:block; border-radius:12px; background:linear-gradient(180deg,#0f1630bb,#0a122caa); border:1px solid var(--edge)}
  footer{padding:26px 0; text-align:center; color:#a8b6f1}
</style>
</head>
<body>
<canvas id="deep-sky" aria-hidden="true"></canvas>
<canvas id="sky" aria-hidden="true"></canvas>
<canvas id="near-sky" aria-hidden="true"></canvas>
<div class="nebula" aria-hidden="true"></div>

<header>
  <div class="wrap">
    <div class="badge">Foster + Navi ‚Ä¢ Planetary Restoration Archive ‚Ä¢ Zero-Harm / Anti-Inversion</div>
    <h1>South Sudan ‚Äî Food & Water Sovereignty ‚Ä¢ Multisystem Dashboard</h1>
    <p class="muted">Offline-first blueprint for seeds ‚Üí soil ‚Üí water ‚Üí fisheries ‚Üí markets ‚Üí river/road logistics ‚Üí early warning ‚Üí peace pacts ‚Äî with mycelial gamification to coordinate action and dignity-preserving wins.</p>
  </div>
</header>

<main class="wrap">
  <section class="section" data-depth="near">
    <div class="toolbar" role="toolbar" aria-label="Quick controls">
      <a class="btn" id="exportState">Export State (JSON)</a>
      <a class="btn" id="importState">Import State</a>
      <label class="switch"><input type="checkbox" id="darkness" checked/> <span>Night mode</span></label>
      <a class="btn" id="openQuestEditor">Quest Editor</a>
      <a class="btn" id="syncGithub">Load Gamification Plugin (GitHub)</a>
    </div>
    <div class="divider"></div>
    <div class="kpis">
      <div class="kpi"><div class="muted">Households onboarded</div><div class="big" id="kpiHouseholds">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Seed/Tool kits distributed</div><div class="big" id="kpiSeeds">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Water points (handpumps/solar) online</div><div class="big" id="kpiWater">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Community peace pacts</div><div class="big" id="kpiPacts">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Dyke/raised-bed segments built</div><div class="big" id="kpiDykes">0</div><div class="okline"></div></div>
      <div class="kpi"><div class="muted">Fishing kits & smokers</div><div class="big" id="kpiFish">0</div><div class="okline"></div></div>
    </div>
  </section>

  <!-- ====================== CORE MODULES (Mycelial Morph) ====================== -->
  <section class="section" data-depth="mid" id="modules">
    <h2>Action Modules (click to expand)</h2>
    <div class="panel">
      <!-- FOOD SYSTEM -->
      <details class="card span-8" open>
        <summary><strong>üåæ Seed ‚Üí Soil ‚Üí Harvest (Rainfed + Floodplain)</strong></summary>
        <div class="grid">
          <div class="card">
            <h3>Micro-Nursery Spokes</h3>
            <p>Steward model (1 ‚Üí 10 homes) using cut bottles/bags as pots, sack-shade, and simple ledgers.</p>
            <ul class="list-tight">
              <li>Timeline: 2‚Äì6 weeks to transplant</li>
              <li>Inputs: bottles/bags, soil, sticks; optional biochar</li>
              <li>Risks: theft ‚Üí dispersion, community roster</li>
            </ul>
            <button class="btn" data-quest="nursery">Add Quest: 10√ó households</button>
          </div>
          <div class="card">
            <h3>Vegetative Propagation</h3>
            <p>Cassava, sweet potato, moringa via cuttings; rapid calories & micronutrients while cereals mature.</p>
            <button class="btn" data-quest="cuttings">Add Quest: 1000 cuttings</button>
          </div>
          <div class="card">
            <h3>Zai Pits ‚Ä¢ Contour Bunds ‚Ä¢ Mulch</h3>
            <p>Micro-catchments with manure; add <em>cowpea/mucuna/groundnut</em> as green manures.</p>
            <button class="btn" data-quest="zai">Add Quest: 300 zai</button>
          </div>
          <div class="card">
            <h3>Raised Beds & Floating Gardens</h3>
            <p>For Sudd floods/seasonal pooling: bamboo/reed rafts or soil mounds for vegetables & legumes.</p>
            <button class="btn" data-quest="raisedbeds">Add Quest: 80 raised beds</button>
          </div>
          <div class="card">
            <h3>Staple Varieties (local-fit)</h3>
            <p>Sorghum, millet, maize (short-cycle), cowpea, groundnut, sesame; intercropping rows (2:1 cereals:legumes).</p>
            <button class="btn" data-quest="seedmix">Add Quest: 200 seed packs</button>
          </div>
        </div>
      </details>

      <!-- WATER SYSTEM -->
      <details class="card span-4" open>
        <summary><strong>üíß Water Sovereignty (Handpumps ‚Ä¢ Solar Piped ‚Ä¢ Safe Storage)</strong></summary>
        <ul class="list-tight">
          <li>Handpump rehab (India Mark II/III) & spare kits</li>
          <li>Solar-piped schemes (head/flow logs)</li>
          <li>Greywater pin-hole drips to seedling lines</li>
          <li>Chlorination tabs ‚Ä¢ covered jerrycans</li>
        </ul>
        <button class="btn" data-quest="handpumps">Add Quest: Rehab 10 handpumps</button>
        <button class="btn" data-quest="solar">Add Quest: 3 solar schemes</button>
        <button class="btn" data-quest="drip">Add Quest: 150 greywater drips</button>
      </details>

      <!-- FISHERIES -->
      <details class="card span-6">
        <summary><strong>üêü Fisheries & Preservation (White Nile ‚Ä¢ Sudd wetlands)</strong></summary>
        <p>Fishing kits, improved smoking racks (reduced wood), salt-drying, and cold-box rotation for markets.</p>
        <div class="grid">
          <div class="card">
            <label>Kits</label><input id="fishKits" type="number" min="0" placeholder="e.g., 25" />
            <button class="btn" id="addFish">Add Fishing Kits</button>
          </div>
          <div class="card">
            <h3>Preservation Sites</h3>
            <ul id="fishList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- DYKES / FLOOD MITIGATION -->
      <details class="card span-6">
        <summary><strong>üõ°Ô∏è Dykes ‚Ä¢ Culverts ‚Ä¢ Raised Footpaths</strong></summary>
        <p>Community-built earthen dykes & culverts to protect plots, with raised footpaths as flood egress lines.</p>
        <div class="grid">
          <div class="card">
            <label>Segment (m)</label><input id="dykeLen" type="number" min="0" />
            <label>Location</label><input id="dykeLoc" placeholder="Payam/Boma" />
            <button class="btn" id="addDyke">Log Dyke Segment</button>
          </div>
          <div class="card">
            <h3>Segments</h3>
            <ul id="dykeList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- MARKETS & PRICE WATCH -->
      <details class="card span-6">
        <summary><strong>üìà Market & Price Watch (Juba ‚Ä¢ Wau ‚Ä¢ Malakal)</strong></summary>
        <p>Track staple prices (sorghum/millet/maize/oil/fuel). Spikes ‚Üí trigger vouchers or swaps.</p>
        <div class="grid">
          <div class="card">
            <label>Town</label>
            <select id="priceTown">
              <option>Juba</option><option>Wau</option><option>Malakal</option><option>Bor</option><option>Rumbek</option>
            </select>
            <label>Commodity</label>
            <select id="priceCommodity">
              <option>Sorghum</option><option>Millet</option><option>Maize</option><option>Cooking oil</option><option>Fuel (diesel)</option>
            </select>
            <label>Price (SDG/kg or liter)</label>
            <input id="priceValue" type="number" min="0" step="0.01" />
            <button class="btn" id="addPrice">Log Price</button>
          </div>
          <div class="card">
            <h3>Signals</h3>
            <ul id="priceSignals" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- LOGISTICS -->
      <details class="card span-6">
        <summary><strong>üöö River & Road Logistics</strong></summary>
        <p>Build route books for barge/boat (Nile) & trucks; track fuel, cold-chain assets, and last-mile partners.</p>
        <div class="grid">
          <div class="card">
            <label>Route name</label><input id="routeName" placeholder="Juba ‚Üí Bor (river)" />
            <label>Mode</label>
            <select id="routeMode"><option>River</option><option>Road</option></select>
            <label>Distance (km)</label><input id="routeKm" type="number" min="0" />
            <button class="btn" id="addRoute">Add Route</button>
          </div>
          <div class="card">
            <h3>Routes</h3>
            <ul id="routeList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- COMMUNITY PEACE PACTS -->
      <details class="card span-6">
        <summary><strong>ü§ù Community Peace Pacts (plots & river access)</strong></summary>
        <p>‚ÄúFood plots & water points are neutral.‚Äù Micro-MOUs with markers; link to mutual-aid rosters.</p>
        <div class="grid">
          <div class="card">
            <label>Community</label><input id="pactCommunity" placeholder="Village/Block" />
            <label>Signatories</label><input id="pactSigners" placeholder="Names or roles" />
            <button class="btn" id="addPact">Record Pact</button>
          </div>
          <div class="card">
            <h3>Signed Pacts</h3>
            <ul id="pactList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- EARLY WARNING -->
      <details class="card span-6">
        <summary><strong>‚ö†Ô∏è Early Warning (manual, offline-first)</strong></summary>
        <p class="muted">No live feeds in this file. Enter observations to trigger advisories. Later, wire to official feeds.</p>
        <div class="grid">
          <div class="card">
            <label>Signal</label>
            <select id="ewType">
              <option>Price spike</option>
              <option>Conflict movement</option>
              <option>Road closure</option>
              <option>Fuel shortage</option>
              <option>White Nile flood watch</option>
              <option>Heat alert</option>
              <option>Epidemic rumor</option>
            </select>
            <label>Severity</label>
            <select id="ewSev">
              <option>Low</option><option>Moderate</option><option>High</option>
            </select>
            <label>Notes</label><input id="ewNotes" placeholder="What, where, when" />
            <button class="btn" id="addEW">Add Warning</button>
          </div>
          <div class="card">
            <h3>Advisories</h3>
            <ul id="ewList" class="list-tight"></ul>
          </div>
        </div>
      </details>

      <!-- KNOWLEDGE BANK -->
      <details class="card span-12">
        <summary><strong>üìö Knowledge & Scripts</strong> <span class="tag">planetaryrestorationarchive.com/scripts ‚Ä¢ GitHub loaders</span></summary>
        <p>Curated scripts/patterns. Paste a GitHub RAW URL to load modules (if CORS permits). PRA endpoints can be mirrored offline.</p>
        <div class="grid">
          <div class="card">
            <label>Load script (GitHub RAW / PRA)</label>
            <input id="scriptUrl" placeholder="https://raw.githubusercontent.com/..." />
            <button class="btn" id="loadScript">Load</button>
            <p id="scriptStatus" class="muted"></p>
            <pre id="scriptPreview" class="mono" style="white-space:pre-wrap;max-height:200px;overflow:auto"></pre>
          </div>
          <div class="card">
            <h3>Seed & Propagation Cheatsheet</h3>
            <ul class="list-tight">
              <li><span class="tooltip" title="Keep nodes in water 24‚Äì48h; plant at rains">Cassava cuttings</span></li>
              <li><span class="tooltip" title="Leaf/vine cuttings root quickly; great for greens">Sweet potato vines</span></li>
              <li><span class="tooltip" title="Moringa from seed & cuttings; prune for leaf yield">Moringa</span></li>
              <li><span class="tooltip" title="Intercrop legumes; living roots year-round">Green manures (cowpea/mucuna)</span></li>
            </ul>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- ====================== GAMIFICATION ENGINE ====================== -->
  <section class="section" data-depth="near" id="game">
    <h2>üéÆ Mycelial Gamification Engine (offline-first)</h2>
    <p class="muted">Track households, quests, streaks, virtues, guilds/co-ops, and shared wins. Anti-inversion: only non-violent, dignity-preserving actions count.</p>

    <div class="grid">
      <div class="card">
        <h3>Create Quest</h3>
        <label>Title</label><input id="qTitle" placeholder="Rehabilitate 10 handpumps" />
        <label>Category</label>
        <select id="qCat"><option>Food</option><option>Water</option><option>Fisheries</option><option>Market</option><option>Logistics</option><option>Peace</option><option>Early Warning</option><option>Flood</option></select>
        <label>Target value</label><input id="qTarget" type="number" min="1" value="5" />
        <label>Unit</label><input id="qUnit" placeholder="handpumps" />
        <button class="btn" id="qCreate">Create Quest</button>
      </div>

      <div class="card">
        <h3>Active Quests</h3>
        <ul id="qList" class="list-tight"></ul>
      </div>

      <div class="card">
        <h3>Submit Progress</h3>
        <label>Quest</label>
        <select id="qPick"></select>
        <label>Value</label><input id="qValue" type="number" min="0" />
        <label>Household/Team</label><input id="qWho" placeholder="Team / Household ID" />
        <button class="btn" id="qSubmit">Submit</button>
        <p id="qMsg" class="muted"></p>
      </div>

      <div class="card">
        <h3>Leaderboard</h3>
        <ol id="leader" class="list-tight"></ol>
      </div>

      <div class="card">
        <h3>Virtues</h3>
        <p class="muted">Earn marks for Stewardship, Care, Courage, Clarity. Multipliers apply to streaks.</p>
        <ul id="virtues" class="list-tight"></ul>
      </div>

      <div class="card">
        <h3>Guilds (Co-ops)</h3>
        <label>Guild Name</label><input id="gName" placeholder="Nile Nurseries Co-op ‚Äî Central" />
        <button class="btn" id="gCreate">Create Guild</button>
        <ul id="gList" class="list-tight"></ul>
      </div>
    </div>
  </section>

  <!-- ====================== MYCELIAL MAP ====================== -->
  <section class="section" data-depth="far">
    <h2>Mycelial Synergy Map</h2>
    <p class="muted">Nodes are actions; edges show helpful synergies. Hover for hints.</p>
    <canvas id="mycelium" aria-label="Mycelial action network"></canvas>
  </section>

  <section class="section" data-depth="near" id="license">
    <h2>Zero-Harm / Anti-Inversion License Banner</h2>
    <p class="mono">This dashboard and associated scripts are intended exclusively for humanitarian, ecological, and dignity-preserving use. Any repurposing for coercion, violence, or deprivation violates the license spirit. Reintegration clause: all corrupt actors are invited back into peaceful civic life through transparent restitution and pro-social labor.</p>
  </section>

  <footer>
    <div class="divider"></div>
    <p class="mono">Local & offline-first. To wire in live feeds later, add connectors; this file will cache via service worker.</p>
    <p class="mono">Foster + Navi ‚Ä¢ PRA ‚Ä¢ South Sudan Sovereignty Edition</p>
  </footer>
</main>

<!-- ====================== JS: Parallax Sky + Engine ====================== -->
<script>
/* Parallax sky */
(function(){
  function stars(canvas, count, blurSpread){
    const dpr=Math.min(2, devicePixelRatio||1), ctx=canvas.getContext('2d');
    function resize(){ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; draw(); }
    const pts=[...Array(count)].map(()=>({x:Math.random(), y:Math.random(), r:Math.random()*1.3+.2, a:.35+.65*Math.random()}));
    function draw(){ const w=canvas.width,h=canvas.height; ctx.clearRect(0,0,w,h);
      for(const s of pts){ const x=s.x*w,y=s.y*h;
        ctx.globalAlpha=s.a;
        const g=ctx.createRadialGradient(x,y,0,x,y,s.r*dpr*blurSpread);
        g.addColorStop(0,'rgba(255,255,255,.95)'); g.addColorStop(1,'rgba(255,255,255,0)');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,s.r*dpr,0,Math.PI*2); ctx.fill();
      } ctx.globalAlpha=1;
    }
    addEventListener('resize', resize, {passive:true}); resize();
    return {draw};
  }
  stars(document.getElementById('near-sky'),1800,2.8);
  stars(document.getElementById('sky'),     1200,2.2);
  stars(document.getElementById('deep-sky'), 900,1.8);
  let t=0; (function tick(){ t+=.0025;
    document.querySelector('.nebula').style.transform=`translate3d(${Math.sin(t)*8}px,${Math.cos(t*.6)*6}px,0) rotate(${t*.02}rad)`;
    requestAnimationFrame(tick);
  })();
  addEventListener('scroll', ()=>{ document.documentElement.style.setProperty('--scroll', String(scrollY||0)); }, {passive:true});
})();

/* Tiny IndexedDB helper */
const DB = (function(){
  let db; const name='south-sudan-sovereignty', ver=1;
  function open(){ return new Promise((res,rej)=>{
    const r = indexedDB.open(name, ver);
    r.onupgradeneeded = e=>{
      const d = e.target.result;
      d.createObjectStore('kv'); d.createObjectStore('prices',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('routes',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('pacts',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('ew',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('quests',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('progress',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('guilds',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('fisheries',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('dykes',{keyPath:'id', autoIncrement:true});
      d.createObjectStore('virtues',{keyPath:'name'});
    };
    r.onsuccess = ()=>{db=r.result; res();}; r.onerror=()=>rej(r.error);
  });}
  function put(store, value, key){ return tx(store,'readwrite').store.put(value, key).complete }
  function get(store, key){ return tx(store).store.get(key) }
  function all(store){ return new Promise((res,rej)=>{ const t=tx(store), req=t.store.getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error)})}
  function tx(store, mode='readonly'){ const t=db.transaction(store, mode); t.store=t.objectStore(store); t.complete=new Promise((res,rej)=>{t.oncomplete=()=>res(); t.onerror=()=>rej(t.error);}); return t;}
  return {open,put,get,all};
})();

/* Toast */
function toast(msg){ const el=document.querySelector('.toast') || (()=>{
  const t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); return t;})();
  el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2200);
}

/* KPIs */
const KPI = {
  async bump(key, by=1){
    const cur = await DB.get('kv', key) || 0; await DB.put('kv', cur+by, key);
    renderKPI();
  },
  async set(key, val){ await DB.put('kv', val, key); renderKPI(); }
};
async function renderKPI(){
  const pairs = [
    ['households','kpiHouseholds'],
    ['seeds','kpiSeeds'],
    ['water','kpiWater'],
    ['pacts','kpiPacts'],
    ['dykes','kpiDykes'],
    ['fish','kpiFish']
  ];
  for(const [k,id] of pairs){ const v = await DB.get('kv', k) || 0; const el = document.getElementById(id);
    if(el) el.textContent = v.toLocaleString(); }
}

/* Market & Price Watch */
async function addPrice(){
  const town=document.getElementById('priceTown').value;
  const com = document.getElementById('priceCommodity').value;
  const v = parseFloat(document.getElementById('priceValue').value||'0');
  if(!v) return toast('Enter a price.');
  await DB.put('prices', {town, commodity:com, value:v, t:Date.now()});
  analyzePrices(); toast('Logged.');
}
async function analyzePrices(){
  const list = await DB.all('prices');
  const by = {};
  for(const r of list){ const key=r.town+'|'+r.commodity; (by[key] ||= []).push(r.value); }
  const ul = document.getElementById('priceSignals'); ul.innerHTML='';
  Object.entries(by).forEach(([key, arr])=>{
    const [town, com]=key.split('|'); arr.sort((a,b)=>a-b); const n=arr.length, med=arr[Math.floor(n/2)];
    const last = arr[arr.length-1]; const jump = last>med*1.25;
    const li = document.createElement('li'); li.innerHTML = `<strong>${town}</strong> ‚Äî ${com}: latest ${last.toFixed(2)} ‚Äî ${jump?'<span class="bad">SPIKE</span>':'ok'}`;
    ul.appendChild(li);
  });
}

/* Routes */
async function addRoute(){
  const name = document.getElementById('routeName').value.trim();
  const mode = document.getElementById('routeMode').value;
  const km = parseFloat(document.getElementById('routeKm').value||'0');
  if(!name || !km) return toast('Enter route + km');
  await DB.put('routes', {name, mode, km, t:Date.now()});
  renderRoutes(); toast('Route added');
}
async function renderRoutes(){
  const data = await DB.all('routes'); const ul=document.getElementById('routeList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.mode} ‚Ä¢ ${d.name} ‚Äî ${d.km} km`; ul.appendChild(li); });
}

/* Pacts */
async function addPact(){
  const c = document.getElementById('pactCommunity').value.trim();
  const s = document.getElementById('pactSigners').value.trim();
  if(!c||!s) return toast('Community + signers');
  await DB.put('pacts', {c, s, t:Date.now()}); await KPI.bump('pacts',1);
  renderPacts(); toast('Pact recorded');
}
async function renderPacts(){
  const data = await DB.all('pacts'); const ul=document.getElementById('pactList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.c}: ${d.s}`; ul.appendChild(li); });
}

/* Early Warning */
async function addEW(){
  const type=document.getElementById('ewType').value; const sev=document.getElementById('ewSev').value; const notes=document.getElementById('ewNotes').value;
  await DB.put('ew', {type, sev, notes, t:Date.now()}); renderEW(); toast('Advisory logged');
}
async function renderEW(){
  const data=await DB.all('ew'); const ul=document.getElementById('ewList'); ul.innerHTML='';
  data.sort((a,b)=>b.t-a.t).slice(0,50).forEach(d=>{
    const li=document.createElement('li');
    const color = d.sev==='High'?'bad': (d.sev==='Moderate'?'warn':'ok');
    li.innerHTML=`<strong class="${color}">${d.sev}</strong> ‚Ä¢ ${d.type} ‚Äî <span class="muted">${d.notes||''}</span>`;
    ul.appendChild(li);
  });
}

/* Fisheries */
async function addFish(){
  const kits = parseInt(document.getElementById('fishKits').value||'0',10);
  if(!kits) return toast('Enter kit count');
  await DB.put('fisheries',{kits, t:Date.now()}); await KPI.bump('fish',kits);
  renderFish(); toast('Fishing kits recorded');
}
async function renderFish(){
  const data = await DB.all('fisheries'); const ul=document.getElementById('fishList'); ul.innerHTML='';
  let total=0; data.forEach(d=>{ total+=d.kits; const li=document.createElement('li'); li.textContent = `Kits: ${d.kits}`; ul.appendChild(li); });
  // Update KPI already done in addFish
}

/* Dykes */
async function addDyke(){
  const len = parseFloat(document.getElementById('dykeLen').value||'0');
  const loc = document.getElementById('dykeLoc').value.trim();
  if(!len||!loc) return toast('Length + location');
  await DB.put('dykes',{len, loc, t:Date.now()}); await KPI.bump('dykes', len);
  renderDykes(); toast('Dyke segment logged');
}
async function renderDykes(){
  const data = await DB.all('dykes'); const ul=document.getElementById('dykeList'); ul.innerHTML='';
  data.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.loc} ‚Äî ${d.len} m`; ul.appendChild(li); });
}

/* Gamification */
const GAME = {
  async init(){
    for (const v of ['Stewardship','Care','Courage','Clarity']){
      if(!(await DB.get('virtues',v))) await DB.put('virtues',{name:v, score:0});
    }
    // Seed useful default quests for South Sudan context
    const seedDefaults = [
      {id:crypto.randomUUID(), title:'Rehabilitate 10 handpumps', category:'Water', target:10, unit:'handpumps', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Install 150 greywater drips', category:'Water', target:150, unit:'drips', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Distribute 1000 cuttings', category:'Food', target:1000, unit:'cuttings', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Construct 300 zai pits', category:'Food', target:300, unit:'pits', progress:0, t:Date.Now},
      {id:crypto.randomUUID(), title:'Build 80 raised beds', category:'Flood', target:80, unit:'beds', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Deploy 25 fishing kits', category:'Fisheries', target:25, unit:'kits', progress:0, t:Date.now()},
      {id:crypto.randomUUID(), title:'Sign 12 peace pacts', category:'Peace', target:12, unit:'pacts', progress:0, t:Date.now()}
    ];
    const existing = await DB.all('quests');
    if(existing.length===0){ for(const q of seedDefaults){ await DB.put('quests', q); } }
    renderVirtues(); renderQuests(); renderLeader(); renderGuilds(); renderFish(); renderDykes();
  },
  async addQuest(q){ await DB.put('quests', q); renderQuests(); toast('Quest created'); },
  async addProgress(p){ await DB.put('progress', p); renderLeader(); }
};
async function renderQuests(){
  const list = await DB.all('quests');
  const ul=document.getElementById('qList'); const pick=document.getElementById('qPick');
  ul.innerHTML=''; pick.innerHTML='';
  list.forEach(q=>{
    const li=document.createElement('li');
    const done=(q.progress||0); const pct=Math.min(100, Math.round(100*done/(q.target||1)));
    li.innerHTML = `<strong>${q.title}</strong> (${q.category}) ‚Äî ${done}/${q.target} ${q.unit} <span class="ribbon">${pct}%</span>`;
    ul.appendChild(li);
    const opt=document.createElement('option'); opt.value=q.id; opt.textContent=q.title; pick.appendChild(opt);
  });
}
async function renderLeader(){
  const prog = await DB.all('progress'); const by={};
  for(const p of prog){ by[p.who] = (by[p.who]||0) + (p.value||0); }
  const arr = Object.entries(by).map(([k,v])=>({who:k, score:v})).sort((a,b)=>b.score-a.score).slice(0,20);
  const ol=document.getElementById('leader'); ol.innerHTML='';
  arr.forEach(e=>{ const li=document.createElement('li'); li.textContent = `${e.who} ‚Äî ${e.score}`; ol.appendChild(li); });
}
async function renderVirtues(){
  const v = await DB.all('virtues'); const ul=document.getElementById('virtues'); ul.innerHTML='';
  v.forEach(x=>{ const li=document.createElement('li'); li.innerHTML=`<strong>${x.name}</strong> ‚Äî ${x.score}`; ul.appendChild(li); });
}
async function virtueBump(name, by=1){ const v=await DB.get('virtues',name)||{name,score:0}; v.score+=by; await DB.put('virtues',v); renderVirtues(); }

/* Guilds */
async function createGuild(){
  const name=document.getElementById('gName').value.trim(); if(!name) return toast('Name your guild');
  await DB.put('guilds',{name, created:Date.now()}); renderGuilds(); toast('Guild created');
}
async function renderGuilds(){
  const g=await DB.all('guilds'); const ul=document.getElementById('gList'); ul.innerHTML='';
  g.forEach(x=>{ const li=document.createElement('li'); li.textContent = x.name; ul.appendChild(li); });
}

/* Quick quest buttons in modules */
document.querySelectorAll('[data-quest]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const map={
      nursery:{title:'Micro-Nursery 10√ó households', category:'Food', target:10, unit:'households'},
      cuttings:{title:'Distribute 1000 cuttings', category:'Food', target:1000, unit:'cuttings'},
      zai:{title:'Construct 300 zai pits', category:'Food', target:300, unit:'pits'},
      raisedbeds:{title:'Build 80 raised beds', category:'Flood', target:80, unit:'beds'},
      seedmix:{title:'Distribute 200 seed packs', category:'Food', target:200, unit:'packs'},
      handpumps:{title:'Rehabilitate 10 handpumps', category:'Water', target:10, unit:'handpumps'},
      solar:{title:'Activate 3 solar-piped schemes', category:'Water', target:3, unit:'schemes'},
      drip:{title:'Install 150 greywater drips', category:'Water', target:150, unit:'drips'}
    };
    const q=map[btn.dataset.quest];
    await GAME.addQuest({id:crypto.randomUUID(), ...q, progress:0, t:Date.now()});
  });
});

/* Quest CRUD */
document.getElementById('qCreate').addEventListener('click', async ()=>{
  const title=document.getElementById('qTitle').value.trim();
  const category=document.getElementById('qCat').value;
  const target=parseFloat(document.getElementById('qTarget').value||'1');
  const unit=document.getElementById('qUnit').value||'units';
  if(!title || !target) return toast('Title + target');
  await GAME.addQuest({id:crypto.randomUUID(), title, category, target, unit, progress:0, t:Date.now()});
});
document.getElementById('qSubmit').addEventListener('click', async ()=>{
  const id=document.getElementById('qPick').value; const val=parseFloat(document.getElementById('qValue').value||'0');
  const who=(document.getElementById('qWho').value||'anonymous').trim();
  if(!id || !val) return toast('Select quest + value');
  const qs = await DB.all('quests'); const q=qs.find(x=>x.id===id); if(!q) return toast('Quest not found');
  q.progress=(q.progress||0)+val; await DB.put('quests', q);
  await DB.put('progress', {quest:id, value:val, who, t:Date.now()});
  document.getElementById('qMsg').textContent=`Recorded ${val} ${q.unit} for ${who}`;
  // Virtue logic
  if(q.category==='Water' || q.category==='Peace') await virtueBump('Care',1);
  if(q.category==='Food' || q.category==='Logistics' || q.category==='Fisheries') await virtueBump('Stewardship',1);
  if(q.category==='Early Warning' || q.category==='Market' || q.category==='Flood') await virtueBump('Clarity',1);
  renderQuests(); renderLeader();
  // KPIs (rough mapping)
  if(/household|garden/i.test(q.title)) KPI.bump('households', val);
  if(/seed|cutting|kit/i.test(q.title)) KPI.bump('seeds', val);
  if(/handpump|drip|water|solar/i.test(q.title)) KPI.bump('water', val);
  if(/dyke|raised bed/i.test(q.title)) KPI.bump('dykes', val);
  if(/fishing|kit/i.test(q.title)) KPI.bump('fish', val);
});

/* Fisheries & Dyke buttons */
document.getElementById('addFish').addEventListener('click', addFish);
document.getElementById('addDyke').addEventListener('click', addDyke);

/* GitHub / PRA script loader */
document.getElementById('loadScript').addEventListener('click', async ()=>{
  const url=document.getElementById('scriptUrl').value.trim();
  if(!url) return toast('Paste a URL');
  const status=document.getElementById('scriptStatus'); const pre=document.getElementById('scriptPreview');
  status.textContent='Fetching‚Ä¶';
  try{
    const res=await fetch(url, {mode:'cors'});
    const txt=await res.text();
    pre.textContent = txt.slice(0, 5000);
    status.textContent='Loaded. (Preview truncated)';
    // Optional: execute if it looks safe and declares a register() function
    if(/register\s*\(/.test(txt)){
      const fn = new Function('dashboard', txt + '\n//# sourceURL=external-script.js');
      fn(window.DASHBOARD_API); toast('Executed plugin');
    }else{
      toast('Loaded script. No register() found ‚Äî kept as reference.');
    }
  }catch(e){ status.textContent='Failed to load (CORS or network)'; }
});

/* ‚ÄúMost in-depth gamification on GitHub‚Äù ‚Äî plugin hook */
window.DASHBOARD_API = {
  addBadge(b){ const ul=document.getElementById('virtues'); const li=document.createElement('li'); li.innerHTML=`üèÖ <strong>${b.name}</strong> ‚Äî ${b.desc||''}`; ul.appendChild(li); },
  addMetric(name, fn){ DASHBOARD_API[name]=fn; },
  onProgress(cb){ DASHBOARD_API._onProg=cb; },
  award(who, what){ toast(`${who} earned ${what}`) },
  ui:{ toast, addPanel(html){ const sec=document.getElementById('game'); const div=document.createElement('div'); div.className='card'; div.innerHTML=html; sec.querySelector('.grid').appendChild(div); } }
};
document.getElementById('syncGithub').addEventListener('click', ()=>{
  const u = prompt('Paste GitHub RAW URL of your gamification engine (register({...}))');
  if(u){ document.getElementById('scriptUrl').value=u; document.getElementById('loadScript').click(); }
});

/* Export/Import state */
document.getElementById('exportState').addEventListener('click', async ()=>{
  const out = {
    prices: await DB.all('prices'), routes: await DB.all('routes'),
    pacts: await DB.all('pacts'), ew: await DB.all('ew'),
    quests: await DB.all('quests'), progress: await DB.all('progress'),
    guilds: await DB.all('guilds'), fisheries: await DB.all('fisheries'), dykes: await DB.all('dykes'),
    kpi: {
      households: await DB.get('kv','households')||0, seeds: await DB.get('kv','seeds')||0,
      water: await DB.get('kv','water')||0, pacts: await DB.get('kv','pacts')||0,
      dykes: await DB.get('kv','dykes')||0, fish: await DB.get('kv','fish')||0
    }
  };
  const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='south-sudan-sovereignty-state.json'; a.click();
});
document.getElementById('importState').addEventListener('click', async ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async ()=>{ const file=inp.files[0]; if(!file) return;
    const txt=await file.text(); const data=JSON.parse(txt);
    for(const k of ['prices','routes','pacts','ew','quests','progress','guilds','fisheries','dykes']){
      for(const r of (data[k]||[])) await DB.put(k,r);
    }
    const kpi=data.kpi||{}; for(const [k,v] of Object.entries(kpi)) await DB.put('kv', v, k);
    renderAll(); toast('State imported');
  };
  inp.click();
});

/* Mycelial force-ish viz */
(function(){
  const canvas=document.getElementById('mycelium'), ctx=canvas.getContext('2d'), dpr=Math.min(2,devicePixelRatio||1);
  function fit(){ canvas.width=canvas.clientWidth*dpr; canvas.height=canvas.clientHeight*dpr; } fit(); addEventListener('resize',fit,{passive:true});
  const nodes=[{id:'Nurseries',tip:'1‚Üí10 households'},
               {id:'Cuttings',tip:'Cassava/Sweet Potato/Moringa'},
               {id:'Zai',tip:'Micro-catchments + legumes'},
               {id:'RaisedBeds',tip:'Flood-resilient vegetables'},
               {id:'Handpumps',tip:'India Mark II/III rehab'},
               {id:'Solar',tip:'Solar piped schemes'},
               {id:'Fisheries',tip:'Kits + smoking racks'},
               {id:'Dykes',tip:'Protect plots & paths'},
               {id:'Markets',tip:'Price watch towns'},
               {id:'EW',tip:'Manual warnings'}]
    .map(n=>Object.assign(n,{x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:0,vy:0,r:8*dpr}));
  const links=[['Nurseries','Cuttings'],['Nurseries','Zai'],['Zai','RaisedBeds'],['Handpumps','Solar'],['Fisheries','Markets'],['Dykes','RaisedBeds'],['Markets','EW']];
  let hover=null;
  canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect(),x=(e.clientX-r.left)*dpr,y=(e.clientY-r.top)*dpr;
    hover=nodes.find(n=> (x-n.x)**2+(y-n.y)**2 < (n.r+6*dpr)**2) || null; });
  function step(){
    for(let i=0;i<nodes.length;i++)for(let j=i+1;j<nodes.length;j++){const a=nodes[i],b=nodes[j]; let dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy)||1; let f=(80*dpr)/d; a.vx+=dx/d*f; a.vy+=dy/d*f; b.vx-=dx/d*f; b.vy-=dy/d*f;}
    for(const [u,v] of links){ const a=nodes.find(n=>n.id===u), b=nodes.find(n=>n.id===v); const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy)||1; const k=.006, rest=140*dpr, f=(d-rest)*k; a.vx+=dx/d*f; a.vy+=dy/d*f; b.vx-=dx/d*f; b.vy-=dy/d*f;}
    for(const n of nodes){ n.vx*=.86; n.vy*=.86; n.x+=n.vx*.016; n.y+=n.vy*.016; n.x=Math.max(30*dpr,Math.min(canvas.width-30*dpr,n.x)); n.y=Math.max(30*dpr,Math.min(canvas.height-30*dpr,n.y)); }
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.lineWidth=1*dpr;
    for(const [u,v] of links){ const a=nodes.find(n=>n.id===u), b=nodes.find(n=>n.id===v);
      ctx.strokeStyle="rgba(122,162,255,.45)"; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();}
    for(const n of nodes){
      const g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r*2.3); g.addColorStop(0,"#dbe6ff"); g.addColorStop(1,"rgba(219,230,255,0)");
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(n.x,n.y,n.r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle="#5d78ff"; ctx.stroke();
      ctx.fillStyle="#cfe0ff"; ctx.font=`${12*dpr}px ui-sans-serif`; ctx.textAlign="center"; ctx.fillText(n.id,n.x,n.y-12*dpr);
    }
    if(hover){ const boxW=260*dpr, boxH=60*dpr, x=Math.min(canvas.width-boxW-10*dpr, hover.x+16*dpr), y=Math.max(10*dpr, hover.y-boxH-16*dpr);
      ctx.fillStyle="rgba(16,25,54,.92)"; ctx.strokeStyle="#2a3a76"; ctx.lineWidth=1*dpr; ctx.beginPath(); ctx.roundRect(x,y,boxW,boxH,8*dpr); ctx.fill(); ctx.stroke();
      ctx.fillStyle="#e8f0ff"; ctx.font=`${12*dpr}px ui-sans-serif`; wrapText(ctx,hover.tip,x+10*dpr,y+20*dpr,boxW-20*dpr,16*dpr); }
  }
  function wrapText(ctx, text, x, y, maxW, lineH){ const words=text.split(' '); let line=''; for(const w of words){ const test=line+w+' '; if(ctx.measureText(test).width>maxW){ ctx.fillText(line,x,y); line=w+' '; y+=lineH; } else line=test; } ctx.fillText(line,x,y); }
  (function anim(){ step(); draw(); requestAnimationFrame(anim); })();
})();

/* Accessibility */
document.querySelectorAll('.tooltip').forEach(el=>{
  el.setAttribute('role','note'); el.addEventListener('keydown', e=>{ if(e.key==='Enter') alert(el.title||el.dataset.title||''); });
});

/* Service Worker (offline shell) */
(function(){
  if(!('serviceWorker' in navigator)) return;
  const sw = `
    const C='south-sudan-sovereignty-v1';
    self.addEventListener('install',e=>{ e.waitUntil(caches.open(C).then(c=>c.addAll(['./']))); self.skipWaiting(); });
    self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==C).map(k=>caches.delete(k))))); self.clients.claim(); });
    self.addEventListener('fetch',e=>{ const req=e.request; e.respondWith(caches.match(req).then(hit=>hit||fetch(req).then(r=>{const copy=r.clone(); caches.open(C).then(c=>c.put(req,copy)); return r;}).catch(()=>caches.match('./')))); });
  `;
  const blob=new Blob([sw],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url).catch(()=>{});
})();

/* Wire UI events */
document.getElementById('addPrice').addEventListener('click', addPrice);
document.getElementById('addRoute').addEventListener('click', addRoute);
document.getElementById('addPact').addEventListener('click', addPact);
document.getElementById('addEW').addEventListener('click', addEW);
document.getElementById('gCreate').addEventListener('click', createGuild);

/* Theme toggle (cosmetic) */
document.getElementById('darkness').addEventListener('change', (e)=>{
  document.body.style.filter = e.target.checked ? 'none' : 'invert(1) hue-rotate(180deg)';
});

/* Initial load */
(async function init(){
  await DB.open();
  renderAll();
  await GAME.init();
})();
async function renderAll(){ renderKPI(); analyzePrices(); renderRoutes(); renderPacts(); renderEW(); renderFish(); renderDykes(); }

/* Bonus: plugin progress replay */
(async function pluginHooks(){
  const progList = await DB.all('progress');
  const cb = DASHBOARD_API._onProg;
  if(cb){ progList.forEach(p=>cb(p)); }
})();
</script>

<!-- Assistive toast element -->
<div class="toast" role="status" aria-live="polite"></div>
</body>
</html>
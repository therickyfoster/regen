<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bangladesh Youth Venture‚ÄëFactory ¬∑ Democratic Renewal PWA</title>
  <meta name="description" content="Feature‚Äërich, animated, offline‚Äëcapable single‚Äëfile tool for youth‚Äëled job creation in Bangladesh after the July Revolution. Includes safety design, micro‚Äëenterprise scaffolding, civic‚Äëtech modules, ROSCA calculator, datasets, dashboards, and export tools." />
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b1025"/>

  <!-- Security posture for single-file demo. If you later split JS/CSS to separate files, remove 'unsafe-inline' and use SRI/hashes. -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' blob:; connect-src 'self' data: blob:; frame-ancestors 'none'; object-src 'none'; base-uri 'none';" />

  <!-- Minimal web app manifest embedded as data URL -->
  <link rel="manifest" href='data:application/manifest+json,{
    "name":"Youth Venture-Factory Bangladesh",
    "short_name":"VentureFactory",
    "start_url":"./",
    "display":"standalone",
    "background_color":"#06091a",
    "theme_color":"#0b1025",
    "icons":[]
  }'>

  <style>
    :root{
      --bg:#06091a;--fg:#f4f6ff;--muted:#b7c1ff;--accent:#76e4f7;--accent2:#a1ffb0;--card:#0b1025aa;--glass:rgba(11,16,37,.5);
      --focus: 0 0 0 3px #76e4f7AA;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%;}
    body{margin:0; font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--fg);}
    /* Galactic animated background */
    #stars{position:fixed; inset:0; z-index:-2; background:#030615;}
    #nebula{position:fixed; inset:-20% -20% -20% -20%; z-index:-1; background: radial-gradient(60% 60% at 60% 40%, rgba(118,228,247,.18), transparent 60%),
      radial-gradient(50% 50% at 40% 60%, rgba(161,255,176,.12), transparent 65%),
      radial-gradient(80% 80% at 80% 20%, rgba(167,129,255,.12), transparent 70%);
      filter: blur(40px);}

    /* Layout */
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(10px); background:linear-gradient(180deg, rgba(6,9,26,.85), rgba(6,9,26,.4)); border-bottom:1px solid #1c2346;}
    .wrap{max-width:1200px; margin:0 auto; padding:24px;}
    nav{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    nav a{padding:10px 14px; border-radius:999px; background:#0f1635; color:#dce3ff; border:1px solid #1f2a64; text-decoration:none; box-shadow:var(--shadow)}
    nav a:focus{outline:none; box-shadow: var(--focus)}

    .hero{display:grid; gap:18px; grid-template-columns: 1.2fr .8fr; align-items:center}
    .hero h1{font-size:clamp(1.8rem,3.2vw,3rem); margin:.25rem 0}
    .tag{display:inline-flex; align-items:center; gap:8px; background:#0f1635; border:1px solid #1e2650; border-radius:999px; padding:6px 10px; color:#a9b7ff}

    .card{background:linear-gradient(180deg, rgba(15,22,53,.8), rgba(15,22,53,.55)); border:1px solid #1e2650; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .card h2,.card h3{margin:.6rem 0 0.4rem}
    .card .content{padding:18px}
    .grid{display:grid; gap:18px}
    @media (min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:repeat(3,1fr)}}

    /* Collapsible */
    details{background:rgba(12,18,46,.6); border:1px solid #1d2550; border-radius:14px; padding:14px;}
    details[open]{background:rgba(12,18,46,.75)}
    summary{cursor:pointer; font-weight:600}

    /* Floating export orb */
    #orb{position:fixed; right:2.5vw; bottom:10vh; width:min(70px,6vw); height:min(70px,6vw); border-radius:50%; background:radial-gradient(circle at 30% 30%, #76e4f7, #6b8cff 50%, #4d2ea6 75%); box-shadow:0 0 30px 6px rgba(118,228,247,.4), inset 0 0 20px rgba(255,255,255,.25); animation:float 6s ease-in-out infinite; z-index:20}
    #orb:hover{animation-play-state:paused}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-12px)}100%{transform:translateY(0)}}
    #orbMenu{position:fixed; right:2.5vw; bottom: calc(10vh + min(80px,7vw)); background:#0f1635; border:1px solid #1f2a64; border-radius:14px; padding:10px; box-shadow:var(--shadow); display:none}
    #orbMenu button{display:block; width:100%; margin:6px 0; padding:8px 10px; border-radius:10px; background:#122061; color:#e9efff; border:1px solid #22307b}

    .kbd{font: 12px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0b143d; border:1px solid #24307e; border-radius:6px; padding:2px 6px}

    /* Print */
    @media print{#orb, #orbMenu, header nav, .hero .viz, #stars, #nebula{display:none !important}}

    /* Accessibility helpers */
    .skip{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden}
    .skip:focus{left:10px; top:10px; width:auto; height:auto; z-index:1000; background:#122061; color:#fff; padding:8px 12px; border-radius:8px}
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="nebula" aria-hidden="true"></div>

  <a href="#main" class="skip">Skip to content</a>
  <header>
    <div class="wrap">
      <nav aria-label="Primary">
        <a href="#overview">Overview</a>
        <a href="#venture">Venture‚ÄëFactory</a>
        <a href="#safety">Women‚ÄëFirst Safety</a>
        <a href="#civic">Civic‚ÄëTech</a>
        <a href="#rosca">ROSCA Calculator</a>
        <a href="#dashboard">Dashboards</a>
        <a href="#export">Export</a>
      </nav>
    </div>
  </header>

  <main id="main" class="wrap">
    <section class="hero grid cols-2" id="overview" aria-labelledby="h1">
      <div class="card">
        <div class="content">
          <span class="tag" title="Context & mission">üß≠ Democratic Renewal ‚Ä¢ üáßüá© Youth Majority ‚Ä¢ üõ°Ô∏è Zero‚Äëharm</span>
          <h1 id="h1">Youth Venture‚ÄëFactory ‚Äî Bangladesh (Post‚ÄìJuly Revolution)</h1>
          <p>
            This single‚Äëfile app is a practical playbook and working tool to help Bangladesh‚Äôs youth majority transition from <strong>authoritarian rule ‚Üí democratic renewal</strong> by shifting from <strong>job seekers ‚Üí job creators</strong>. It includes long‚Äëform guidance, interactive checklists, data schemas, a safety stack designed for women and marginalized youth, and offline‚Äëfriendly export.
          </p>
          <ul>
            <li>üéØ <strong>Immediate (0‚Äì6 mo)</strong>: 100 micro‚Äëenterprises per district via sprint cohorts.</li>
            <li>üõ°Ô∏è <strong>Women‚Äëfirst safety</strong>: safe routes, anti‚Äëharassment protocols, grievance fast‚Äëlanes.</li>
            <li>üèõÔ∏è <strong>Democratic resilience</strong>: civic apprenticeships + open fix dashboards.</li>
          </ul>
          <p><span class="kbd">Tip</span> Use the floating orb to export raw text / HTML / print‚Äëto‚ÄëPDF and to save a local backup.</p>
        </div>
      </div>
      <div class="viz card" aria-hidden="true">
        <div class="content">
          <h3>Galactic Metrics Constellation ‚ú®</h3>
          <p>As ventures launch, this canvas animates stars for: ventures, women co‚Äëfounders, jobs, safety resolutions, and civic fixes.</p>
          <canvas id="constellation" height="280" style="width:100%; border-radius:12px; background:linear-gradient(180deg,#0a0f2c,#0b153e)"></canvas>
        </div>
      </div>
    </section>

    <section id="venture" class="grid cols-2" aria-labelledby="venture-h2">
      <div class="card">
        <div class="content">
          <h2 id="venture-h2">Venture‚ÄëFactory (180‚ÄëDay Launch)</h2>
          <p>
            Build on Bangladesh‚Äôs MSME backbone. Each district runs rolling 6‚Äëweek sprints: problem interviews ‚Üí paper MVP ‚Üí market pilot ‚Üí sales day ‚Üí iterate. Prioritize women co‚Äëfounders, essential goods/services, and local input chains.
          </p>
          <details open>
            <summary>Scouting rubric (field form)</summary>
            <form id="scoutForm">
              <label>Team name <input required name="team"/></label><br>
              <label>Women co‚Äëfounders (%) <input type="number" min="0" max="100" name="women_pct"/></label><br>
              <label>Problem to solve <textarea name="problem" required></textarea></label><br>
              <label>Access to inputs (nearby suppliers) <input name="inputs" placeholder="who / where"/></label><br>
              <label>Route to market (stalls, online, door‚Äëto‚Äëdoor) <input name="route"/></label><br>
              <button type="submit">Save candidate</button>
            </form>
          </details>
          <details>
            <summary>Lean track (6‚Äëweek)
            </summary>
            <ol>
              <li>Week 1: problem interviews; decide value prop.</li>
              <li>Week 2: paper MVP; materials list; safety plan.</li>
              <li>Week 3: market pilot; log harassment risks & mitigations.</li>
              <li>Week 4: pricing + supplier locking; micro‚Äëgrant released.</li>
              <li>Week 5: sales day; cohort marketplace festival.</li>
              <li>Week 6: iterate, formalize vendor contracts, register.</li>
            </ol>
          </details>
        </div>
      </div>
      <div class="card">
        <div class="content">
          <h3>Templates (auto‚Äëgenerated)</h3>
          <ul>
            <li><button data-template="grantRules">Micro‚Äëgrant Rules</button></li>
            <li><button data-template="vendorContract">Vendor Contract</button></li>
            <li><button data-template="cba">Community Benefit Agreement</button></li>
            <li><button data-template="mentorMou">Mentor MOU</button></li>
            <li><button data-template="grievance">Grievance & Safety SOP</button></li>
          </ul>
          <textarea id="templateOut" rows="10" style="width:100%" placeholder="Generated template will appear here‚Ä¶"></textarea>
          <div>
            <button id="copyTemplate">Copy</button>
            <button id="downloadTemplate">Download .txt</button>
          </div>
        </div>
      </div>
    </section>

    <section id="safety" class="grid cols-2" aria-labelledby="safety-h2">
      <div class="card">
        <div class="content">
          <h2 id="safety-h2">Women‚ÄëFirst Safety Stack</h2>
          <p>
            Safety by design across travel, stalls, storage, and online presence. Implement <em>safe routes</em>, vendor compacts, incident logging, and escalation pathways with civil society partners.
          </p>
          <details open>
            <summary>Safety Board (log incidents, assign responders)</summary>
            <form id="safetyForm">
              <label>Date <input type="date" name="date" required></label>
              <label>Market/area <input name="area" required></label>
              <label>Type <select name="type"><option>Harassment</option><option>Threat</option><option>Theft</option><option>Other</option></select></label>
              <label>Description <textarea name="desc" required></textarea></label>
              <label>Assigned responder circle <input name="responder" placeholder="names/orgs"></label>
              <button type="submit">Log incident</button>
            </form>
            <ul id="safetyList" aria-live="polite"></ul>
          </details>
          <details>
            <summary>Market Code of Conduct (quick view)</summary>
            <ul>
              <li>Zero tolerance for harassment; repeat offenders lose stall access.</li>
              <li>‚ÄúNo harassment, no rent‚Äù clause in leases.</li>
              <li>Pair‚Äëtravel for opening/closing hours; verified rickshaw list.</li>
              <li>Shared night storage; lighting near women‚Äôs stalls.</li>
            </ul>
          </details>
        </div>
      </div>
      <div class="card">
        <div class="content">
          <h3>Safe‚ÄëRoute Mapper (lightweight)</h3>
          <p>Click to mark safe spots (‚úÖ) and risk spots (‚ö†Ô∏è). Works offline; exports GeoJSON.</p>
          <div>
            <button id="addSafe">Mark ‚úÖ Safe</button>
            <button id="addRisk">Mark ‚ö†Ô∏è Risk</button>
            <button id="exportGeo">Export GeoJSON</button>
          </div>
          <div id="map" style="height:300px; background:conic-gradient(from 90deg at 50% 50%, #0c1438, #0a1030); border-radius:12px; margin-top:10px; position:relative"></div>
        </div>
      </div>
    </section>

    <section id="civic" class="grid cols-2" aria-labelledby="civic-h2">
      <div class="card"><div class="content">
        <h2 id="civic-h2">Civic‚ÄëTech Apprenticeships</h2>
        <p>Three‚Äëmonth placements on city fixes: potholes, water leaks, waste pickup. Each fix becomes a portfolio artifact; dashboards provide trust through transparency.</p>
        <form id="civicForm">
          <label>Project <input name="project" required></label>
          <label>Category <select name="cat"><option>Pothole</option><option>Water Leak</option><option>Waste</option><option>Lighting</option><option>Other</option></select></label>
          <label>Ward/Area <input name="ward"></label>
          <label>Status <select name="status"><option>Reported</option><option>Assigned</option><option>Completed</option></select></label>
          <button type="submit">Add fix</button>
        </form>
        <ul id="civicList" aria-live="polite"></ul>
      </div></div>
      <div class="card"><div class="content">
        <h3>Open Data & Accountability</h3>
        <p>All records stored locally in your browser for privacy. Export/import JSON to sync across devices or publish to an open data portal later.</p>
        <div>
          <button id="exportJSON">Export All JSON</button>
          <input type="file" id="importJSON" accept="application/json"/>
        </div>
      </div></div>
    </section>

    <section id="rosca" class="grid cols-2" aria-labelledby="rosca-h2">
      <div class="card"><div class="content">
        <h2 id="rosca-h2">ROSCA / SHG Calculator</h2>
        <p>Simulate rotating savings for a 20‚Äëperson cohort with flexible pot size, rotation order, and contribution schedule.</p>
        <form id="roscaForm">
          <label>Participants <input type="number" min="2" max="200" value="20" name="n"></label>
          <label>Monthly contribution (‡ß≥) <input type="number" value="1000" name="c"></label>
          <label>Rotation months <input type="number" value="12" name="m"></label>
          <button type="submit">Simulate</button>
        </form>
        <div id="roscaOut" role="table" aria-label="ROSCA schedule" style="margin-top:10px"></div>
      </div></div>
      <div class="card"><div class="content">
        <h3>Guidance</h3>
        <ul>
          <li>Prefer women‚Äëled circles for market access and childcare pooling.</li>
          <li>Publish rotation schedule; require two witness signatures per payout.</li>
          <li>Default fail‚Äësafes: grace week, hardship pool (2%), audit log.</li>
        </ul>
      </div></div>
    </section>

    <section id="dashboard" class="grid cols-3" aria-labelledby="dash-h2">
      <div class="card"><div class="content">
        <h2 id="dash-h2">Dashboards & OKRs</h2>
        <p>Track ventures launched, women co‚Äëfounders, jobs, safety resolutions, and civic fixes. Metrics render to the constellation and the tiles below.</p>
        <div class="grid cols-3">
          <div class="card"><div class="content"><h3>üöÄ Ventures</h3><div id="m-ventures">0</div></div></div>
          <div class="card"><div class="content"><h3>üë©‚Äçüíº Women Co‚Äëfounders</h3><div id="m-women">0%</div></div></div>
          <div class="card"><div class="content"><h3>üíº Jobs</h3><div id="m-jobs">0</div></div></div>
          <div class="card"><div class="content"><h3>üõ°Ô∏è Safety Resolved</h3><div id="m-safety">0</div></div></div>
          <div class="card"><div class="content"><h3>üõ†Ô∏è Civic Fixes</h3><div id="m-fixes">0</div></div></div>
          <div class="card"><div class="content"><h3>üìà Survival @ 6 mo</h3><div id="m-survival">0%</div></div></div>
        </div>
      </div></div>
    </section>

    <section id="export" class="card" aria-labelledby="export-h2">
      <div class="content">
        <h2 id="export-h2">Export & Offline</h2>
        <p>
          This file is already self‚Äëcontained. Press <span class="kbd">Ctrl/Cmd + P</span> for a clean PDF, or use the orb ‚Üí ‚ÄúDownload HTML snapshot‚Äù to save a copy with your current data embedded. A lightweight service worker will attempt to install (secure contexts only) to enable offline reloads; if not permitted, your data remains available locally and your saved snapshot will always work offline.
        </p>
      </div>
    </section>
  </main>

  <!-- Floating export orb -->
  <button id="orb" aria-label="Open export menu" title="Export & Tools"></button>
  <div id="orbMenu" role="menu" aria-label="Export menu">
    <button role="menuitem" id="btnRaw">Copy page as raw text</button>
    <button role="menuitem" id="btnHTML">Download HTML snapshot</button>
    <button role="menuitem" id="btnPrint">Print / Save PDF</button>
    <button role="menuitem" id="btnBackup">Backup data (JSON)</button>
    <button role="menuitem" id="btnRestore">Restore data (JSON)</button>
  </div>

  <!-- Schemas & Templates (inline JSON) -->
  <script type="application/json" id="schemas">{
    "venture": {"team":"","women_pct":0,"problem":"","inputs":"","route":""},
    "incident": {"date":"","area":"","type":"","desc":"","responder":"","status":"Open"},
    "civic": {"project":"","cat":"","ward":"","status":"Reported"}
  }</script>
  <script type="application/json" id="templates">{
    "grantRules": "MICRO-GRANT RULES (District Sprint)\n1) Eligibility: women-led or mixed teams; essential goods/services.\n2) Disbursement: 60% at week 3 (pilot), 40% post-sales day.\n3) Proof: receipts + 3 customer interviews.\n4) Safety: route plan + stall compact signed.\n5) Pay-it-forward: 5% back into next cohort pool within 90 days.",
    "vendorContract": "VENDOR CONTRACT (Market Stall)\n‚Ä¢ Stall #, days/hours, fees.\n‚Ä¢ ‚ÄòNo harassment, no rent‚Äô clause; violations terminate access.\n‚Ä¢ Night storage & lighting provided where applicable.\n‚Ä¢ Dispute process with market committee (7-day SLA).",
    "cba": "COMMUNITY BENEFIT AGREEMENT\n‚Ä¢ Jobs for local youth.\n‚Ä¢ Women‚Äôs safety measures enforced.\n‚Ä¢ Waste & noise standards.\n‚Ä¢ Quarterly open meeting & dashboard publication.",
    "mentorMou": "MENTOR MOU\n‚Ä¢ 2hrs/week office hours; 1 site visit / cohort.\n‚Ä¢ Ethics: no recruitment or IP claims.\n‚Ä¢ Success metric: 3 teams launched per cohort.",
    "grievance": "GRIEVANCE & SAFETY SOP\n1) Report within 24h (app form or hotline).\n2) Evidence capture (time, place, witnesses).\n3) Interim safety plan (buddy routes, stall swap).\n4) Investigation (7 days) with civil partner.\n5) Outcome posted (anonymized) to public log."
  }</script>

  <script>
  // Basic state and helpers
  const S = {
    key: 'bd-youth-vfactory-v1',
    data: { ventures: [], incidents: [], civic: [], metrics:{ventures:0,womenPct:0,jobs:0,safety:0,fixes:0,survival:0} }
  };
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const schemas = JSON.parse(document.getElementById('schemas').textContent);
  const templates = JSON.parse(document.getElementById('templates').textContent);

  // Load / save
  function load(){
    try{ const raw = localStorage.getItem(S.key); if(raw){ S.data = JSON.parse(raw); } }catch(e){}
    renderAll();
  }
  function save(){ localStorage.setItem(S.key, JSON.stringify(S.data)); }

  // Forms
  $('#scoutForm').addEventListener('submit', e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const v = Object.assign({}, schemas.venture);
    for(const [k,val] of fd.entries()) v[k]=val;
    v.women_pct=Number(v.women_pct||0);
    S.data.ventures.push(v);
    save();
    e.target.reset();
    updateMetrics();
    alert('Saved candidate ‚úÖ');
  });
  $('#safetyForm').addEventListener('submit', e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const it = Object.assign({}, schemas.incident);
    for(const [k,val] of fd.entries()) it[k]=val;
    S.data.incidents.push(it); save(); renderSafety(); updateMetrics();
  });
  $('#civicForm').addEventListener('submit', e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const it = Object.assign({}, schemas.civic);
    for(const [k,val] of fd.entries()) it[k]=val;
    S.data.civic.push(it); save(); renderCivic(); updateMetrics();
  });

  // Template generation
  $$('button[data-template]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const t = b.getAttribute('data-template');
      $('#templateOut').value = templates[t] || '';
    })
  });
  $('#copyTemplate').onclick = ()=>{ navigator.clipboard.writeText($('#templateOut').value || ''); };
  $('#downloadTemplate').onclick = ()=>{
    const blob = new Blob([$('#templateOut').value||''], {type:'text/plain'});
    const a = Object.assign(document.createElement('a'), {download:'template.txt', href: URL.createObjectURL(blob)}); a.click(); URL.revokeObjectURL(a.href);
  };

  // Safety list & Civic list renderers
  function renderSafety(){
    const ul = $('#safetyList'); ul.innerHTML='';
    S.data.incidents.forEach((it,i)=>{
      const li = document.createElement('li');
      li.textContent = `${it.date||''} ‚Ä¢ ${it.area||''} ‚Ä¢ ${it.type||''} ‚Üí ${it.responder||''}`;
      ul.appendChild(li);
    });
  }
  function renderCivic(){
    const ul = $('#civicList'); ul.innerHTML='';
    S.data.civic.forEach(it=>{
      const li = document.createElement('li'); li.textContent = `${it.project} ‚Ä¢ ${it.cat} ‚Ä¢ ${it.status}`; ul.appendChild(li);
    });
  }

  // ROSCA calc
  $('#roscaForm').addEventListener('submit', e=>{
    e.preventDefault();
    const n = Number(new FormData(e.target).get('n')); const c=Number(new FormData(e.target).get('c')); const m=Number(new FormData(e.target).get('m'));
    const pot = n*c; const out = document.getElementById('roscaOut');
    let html = '<div role="rowgroup">';
    for(let i=1;i<=m;i++) html += `<div role="row"><span class="kbd">Month ${i}</span> ‚Äî payout ‡ß≥${pot.toLocaleString()} ‚Äî everyone pays ‡ß≥${c.toLocaleString()}</div>`;
    out.innerHTML = html+ '</div>';
  });

  // Metrics
  function updateMetrics(){
    const V = S.data.ventures.length; const women = Math.round((S.data.ventures.reduce((a,b)=>a+(b.women_pct||0),0)/(V||1))||0);
    const jobs = Math.round(V*2.2); // heuristic placeholder
    const safety = S.data.incidents.length; const fixes = S.data.civic.filter(x=>x.status==='Completed').length; const survival = Math.min(100, Math.round(V*0.8));
    S.data.metrics = {ventures:V, womenPct:women, jobs, safety, fixes, survival}; save(); renderMetrics(); drawConstellation();
  }
  function renderMetrics(){
    $('#m-ventures').textContent = S.data.metrics.ventures;
    $('#m-women').textContent = S.data.metrics.womenPct + '%';
    $('#m-jobs').textContent = S.data.metrics.jobs;
    $('#m-safety').textContent = S.data.metrics.safety;
    $('#m-fixes').textContent = S.data.metrics.fixes;
    $('#m-survival').textContent = S.data.metrics.survival + '%';
  }

  // Map mock (click to place points)
  let mode='safe';
  $('#addSafe').onclick=()=>mode='safe';
  $('#addRisk').onclick=()=>mode='risk';
  const pts=[];
  $('#map').addEventListener('click', e=>{
    const r = e.currentTarget.getBoundingClientRect();
    const x = (e.clientX - r.left)/r.width, y=(e.clientY - r.top)/r.height;
    pts.push({type: mode, x, y});
    const dot = document.createElement('div'); dot.style.cssText=`position:absolute;left:${x*100}%;top:${y*100}%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:${mode==='safe'?'#a1ffb0':'#ffb871'};box-shadow:0 0 10px ${mode==='safe'?'#a1ffb0':'#ffb871'};`;
    e.currentTarget.appendChild(dot);
  });
  $('#exportGeo').onclick=()=>{
    const gj = {type:'FeatureCollection',features:pts.map(p=>({type:'Feature',properties:{kind:p.type},geometry:{type:'Point',coordinates:[p.x,p.y]}}))};
    const blob = new Blob([JSON.stringify(gj,null,2)],{type:'application/json'});
    const a = Object.assign(document.createElement('a'), {download:'safe-routes.geojson', href: URL.createObjectURL(blob)}); a.click(); URL.revokeObjectURL(a.href);
  };

  // Export Orb interactions
  const orb = $('#orb'), menu = $('#orbMenu');
  orb.addEventListener('click', ()=>{ menu.style.display = menu.style.display==='block'?'none':'block'; });
  $('#btnPrint').onclick = ()=>window.print();
  $('#btnRaw').onclick = ()=>{ navigator.clipboard.writeText(document.documentElement.outerText || document.body.innerText); alert('Copied raw text to clipboard'); };
  $('#btnHTML').onclick = ()=>{
    const html = makeSnapshotHTML();
    const blob = new Blob([html], {type:'text/html'});
    const a = Object.assign(document.createElement('a'), {download:'venture-factory.snapshot.html', href: URL.createObjectURL(blob)}); a.click(); URL.revokeObjectURL(a.href);
  };
  $('#btnBackup').onclick = ()=>{
    const blob = new Blob([JSON.stringify(S.data,null,2)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {download:'venture-factory.data.json', href: URL.createObjectURL(blob)}); a.click(); URL.revokeObjectURL(a.href);
  };
  $('#btnRestore').onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=>{ const f = inp.files[0]; const r = new FileReader(); r.onload = ()=>{ try{ S.data = JSON.parse(r.result); save(); renderAll(); alert('Data restored ‚úÖ'); }catch(e){alert('Invalid JSON');}}; r.readAsText(f); };
    inp.click();
  };

  function makeSnapshotHTML(){
    const doc = document.documentElement.cloneNode(true);
    // Embed current data inline
    doc.querySelector('#schemas').textContent = document.querySelector('#schemas').textContent;
    const t = doc.querySelector('#templates'); t.textContent = document.querySelector('#templates').textContent;
    // Add inline data script
    const dataScript = doc.createElement('script');
    dataScript.type='application/json'; dataScript.id='inlineData'; dataScript.textContent = JSON.stringify(S.data);
    doc.querySelector('body').appendChild(dataScript);
    // Mark snapshot
    doc.querySelector('title').textContent += ' (Snapshot)';
    return '<!doctype html>\n' + doc.outerHTML;
  }

  // Constellation + starfield animations
  function drawConstellation(){
    const c = document.getElementById('constellation'); const ctx = c.getContext('2d'); const w=c.width=c.clientWidth*devicePixelRatio, h=c.height=280*devicePixelRatio; ctx.clearRect(0,0,w,h);
    const metrics = S.data.metrics; const points=[
      {x:.15,y:.6,val:metrics.ventures,label:'Ventures'},
      {x:.35,y:.35,val:metrics.womenPct,label:'Women %'},
      {x:.55,y:.55,val:metrics.jobs,label:'Jobs'},
      {x:.75,y:.30,val:metrics.safety,label:'Safety'},
      {x:.85,y:.65,val:metrics.fixes,label:'Fixes'}
    ];
    ctx.lineWidth=2; ctx.strokeStyle='rgba(118,228,247,.6)'; ctx.fillStyle='rgba(161,255,176,.9)';
    let prev=null; points.forEach(p=>{
      const x=w*p.x, y=h*p.y; if(prev){ctx.beginPath();ctx.moveTo(prev.x,prev.y);ctx.lineTo(x,y);ctx.stroke();}
      prev={x,y};
      const r = Math.max(4, Math.min(16, (Number(p.val)||0)/4));
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    });
  }
  function starfield(){
    const c = document.getElementById('stars'); const ctx = c.getContext('2d');
    function resize(){ c.width = innerWidth*devicePixelRatio; c.height = innerHeight*devicePixelRatio; }
    resize(); addEventListener('resize', resize);
    const N = 300, Sarr=[]; for(let i=0;i<N;i++){ Sarr.push({x:Math.random()*c.width,y:Math.random()*c.height, z: Math.random()*1.5+0.5, a: Math.random()*1}); }
    function tick(){ ctx.clearRect(0,0,c.width,c.height); for(const s of Sarr){ s.x+=s.z; if(s.x>c.width) s.x=0; const r = s.z*1.2; ctx.globalAlpha = .4 + .6*Math.sin((s.a+=0.02)); ctx.beginPath(); ctx.arc(s.x,s.y,r,0,6.283); ctx.fillStyle='#bcd7ff'; ctx.fill(); } requestAnimationFrame(tick); }
    tick();
  }

  // Accessible focus outline on keyboard nav
  document.addEventListener('keydown', e=>{ if(e.key==='Tab'){ document.body.classList.add('kbdnav'); }});

  // Service worker (best-effort, may be blocked for blob: script by some browsers)
  async function tryInstallSW(){
    if(!('serviceWorker' in navigator)) return;
    try{
      const swCode = `self.addEventListener('install',e=>{e.waitUntil(caches.open('vf-cache-v1').then(c=>c.addAll(['./'])))});
self.addEventListener('activate',e=>{});
self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match('./')))});`;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(url, {scope: './'});
      console.log('Service worker registered');
    }catch(err){ console.warn('SW not installed (likely blob: restriction). Snapshot export remains fully offline.', err); }
  }

  function renderAll(){ renderSafety(); renderCivic(); updateMetrics(); }

  // Boot
  load(); starfield(); tryInstallSW();
  </script>
</body>
</html>
